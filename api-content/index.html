{"posts":[{"title":"Cacti启用HTTPS登录","content":"HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全，为了保证这些隐私数据能加密传输，于是网景公司（Netscape Communications Corporation）设计了SSL（Secure Sockets Layer）协议用于对HTTP协议传输的数据进行加密，从而就诞生了HTTPS。本文将介绍在Cacti中启用https登录。 安装mod_ssl软件包 yum install -y mod_ssl 生成服务器私钥ca.key openssl genrsa -out ca.key 2048 用私钥ca.key文件生成证书请求文件ca.csr openssl req -new -key ca.key -out ca.csr 按照提示完成相关信息： You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [XX]:CN State or Province Name (full name) []:Hunan Locality Name (eg, city) [Default City]:Changsha Organization Name (eg, company) [Default Company Ltd]:CNCONN Company Organizational Unit Name (eg, section) []:NetBU Common Name (eg, your name or your server's hostname) []:cacti Email Address []:netadmin@cnconn.com Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []:123456 An optional company name []: 如果找第三方公司签名，请把csr文件发给第三方公司签名。以下第4步是自签设定。 生成证书文件ca.crt openssl x509 -req -days 700 -in ca.csr -signkey ca.key -out ca.crt 可以见到生成成功的提示信息： Signature ok subject=C = CN, ST = Hunan, L = Changsha, O = CNCONN Company, OU = NetBU, CN = cacti, emailAddress = netadmin@cnconn.com Getting Private key 如果是找第三方公司签名，第三方公司签名后会把crt文件发给你。 复制证书文件到对应的目录 cp ca.crt /etc/pki/tls/certs cp ca.key /etc/pki/tls/private/ca.key cp ca.csr /etc/pki/tls/private/ca.csr 修改Apache SSL配置文件 vi /etc/httpd/conf.d/ssl.conf 找到如下两行配置文件： SSLCertificateFile /etc/pki/tls/certs/localhost.crt SSLCertificateKeyFile /etc/pki/tls/private/localhost.key 修改为： SSLCertificateFile /etc/pki/tls/certs/ca.crt SSLCertificateKeyFile /etc/pki/tls/private/ca.key 修改防火墙配置 firewall-cmd --permanent --add-service=https firewall-cmd --permanent --remove-service=http firewall-cmd --reload firewall-cmd --permanent --list-all 重启http服务 systemctl restart httpd 服务器一般是放置在硬件网络防火墙DMZ区，如是，还需开放硬件网络防火墙的权限。 ","link":"https://eflytop.github.io/post/cacti-https/"},{"title":"FortiGate使用内置iperf服务进行带宽测试","content":"FortiGate具有内置的iPerf3客户端和有限的嵌入式 iPerf3 服务器，本文介绍如何使用FortiGate内置iperf服务进行带宽测试，适用固件版本为FortiGate V7.0和V7.2。 为了进行测试，本文将“FG-A”作为 Iperf 服务器，将“FG-B”作为 Iperf 客户端。“FG-A”端口port1的IP地址为10.10.10.1/30，“FG-B”端口port1的IP地址为10.10.10.2/30。 “FG-A”的配置为： config system global set speedtest-server enable end config system interface edit &quot;port1&quot; set ip 10.10.10.1 255.255.255.252 set allowaccess ping https ssh http speed-test end 注：需在测试端口下允许speed-test流量，该流量使用的是TCP端口5201。 “FG-B”的配置为： config system interface edit &quot;port1&quot; set ip 10.10.10.2 255.255.255.252 end diagnose traffictest client-intf port1 diagnose traffictest server-intf port1 diagnose traffictest port 5201 diagnose traffictest proto 0 diagnose traffictest show server-intf: port1 client-intf: port1 port: 5201 proto: TCP 注：diagnose traffictest命令是及时的，退出终端后配置就会恢复成默认值。 测试： 使用命令&quot; diagnose traffictest run -c 10.10.10.1&quot;测试带宽： diagnose traffictest run -c 10.10.10.1 Connecting to host 10.10.10.1, port 5201 [ 10] local 10.10.10.2 port 21241 connected to 10.10.10.1 port 5201 [ ID] Interval Transfer Bandwidth Retr Cwnd [ 10] 0.00-1.00 sec 387 MBytes 3.25 Gbits/sec 70 509 KBytes [ 10] 1.00-2.00 sec 446 MBytes 3.75 Gbits/sec 0 566 KBytes [ 10] 2.00-3.00 sec 453 MBytes 3.80 Gbits/sec 2 455 KBytes [ 10] 3.00-4.00 sec 440 MBytes 3.69 Gbits/sec 26 433 KBytes [ 10] 4.00-5.00 sec 452 MBytes 3.80 Gbits/sec 0 515 KBytes [ 10] 5.00-6.00 sec 450 MBytes 3.77 Gbits/sec 0 570 KBytes [ 10] 6.00-7.00 sec 451 MBytes 3.78 Gbits/sec 4 474 KBytes [ 10] 7.00-8.00 sec 452 MBytes 3.79 Gbits/sec 0 539 KBytes [ 10] 8.00-9.00 sec 451 MBytes 3.78 Gbits/sec 0 587 KBytes [ 10] 9.00-10.00 sec 453 MBytes 3.80 Gbits/sec 2 452 KBytes - - - - - - - - - - - - - - - - - - - - - - - - - [ ID] Interval Transfer Bandwidth Retr [ 10] 0.00-10.00 sec 4.33 GBytes 3.72 Gbits/sec 104 sender [ 10] 0.00-10.00 sec 338 MBytes 284 Mbits/sec receiver iperf Done. iperf3: interrupt - the server has terminated diagnose traffictest run -c 10.10.10.1 -R Connecting to host 10.10.10.1, port 5201 Reverse mode, remote host 10.10.10.1 is sending [ 10] local 10.10.10.2 port 18987 connected to 10.10.10.1 port 5201 [ ID] Interval Transfer Bandwidth [ 10] 0.00-1.00 sec 377 MBytes 3.16 Gbits/sec [ 10] 1.00-2.00 sec 402 MBytes 3.37 Gbits/sec [ 10] 2.00-3.00 sec 410 MBytes 3.44 Gbits/sec [ 10] 3.00-4.00 sec 439 MBytes 3.68 Gbits/sec [ 10] 4.00-5.00 sec 441 MBytes 3.70 Gbits/sec [ 10] 5.00-6.00 sec 450 MBytes 3.77 Gbits/sec [ 10] 6.00-7.00 sec 451 MBytes 3.78 Gbits/sec [ 10] 7.00-8.00 sec 452 MBytes 3.79 Gbits/sec [ 10] 8.00-9.00 sec 453 MBytes 3.80 Gbits/sec [ 10] 9.00-10.00 sec 330 MBytes 2.77 Gbits/sec - - - - - - - - - - - - - - - - - - - - - - - - - [ ID] Interval Transfer Bandwidth Retr [ 10] 0.00-10.00 sec 111 MBytes 93.4 Mbits/sec 8 sender [ 10] 0.00-10.00 sec 4.11 GBytes 3.53 Gbits/sec receiver iperf Done. iperf3: interrupt - the server has terminated 注：默认情况下，iperf 将数据发送到远程主机，也就是说，在本例中，它针对“FG-A”进行了测试 （UPLOAD），要生成相反方向的流量，请使用 -R 选项。 查看其它可用命令： diag traffictest run -h ","link":"https://eflytop.github.io/post/fortigate-speed-test/"},{"title":"在CentOS 8上安装Zabbix 6.0","content":"Zabbix可以安装在任何Linux发行版上，但在本教程中，我将向您展示如何在CentOS 8 / RHEL 8 / Alma Linux 8 / Rocky Linux 8上安装最新的Zabbix 6.0 LTS。 我们首先安装和配置Zabbix服务器，然后是数据库，最后是前端，下图为Zabbix架构。 1：将 SELinux 设置为permissive模式 setenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config 2：安装 Zabbix 服务器、前端和代理 rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/8/x86_64/zabbix-release-6.0-1.el8.noarch.rpm dnf clean all dnf -y install zabbix-server-mysql zabbix-web-mysql zabbix-apache-conf zabbix-sql-scripts zabbix-selinux-policy zabbix-agent 3：安装和配置数据库 a. 安装 MariaDB 10.6 curl -LsS -O https://downloads.mariadb.com/MariaDB/mariadb_repo_setup sudo bash mariadb_repo_setup --mariadb-server-version=10.6 dnf -y install mariadb-server &amp;&amp; systemctl start mariadb &amp;&amp; systemctl enable mariadb b.重置数据库的根密码 mariadb-secure-installation Enter current password for root (enter for none): Press Enter Switch to unix_socket authentication [Y/n] y Change the root password? [Y/n] y New password: 输入数据库根密码 Re-enter new password: 再次输入数据库根密码(我设置的密码为rootDBpass) Remove anonymous users? [Y/n]: Y Disallow root login remotely? [Y/n]: Y Remove test database and access to it? [Y/n]: Y Reload privilege tables now? [Y/n]: Y c. 创建数据库 sudo mysql -uroot -p'rootDBpass' -e &quot;create database zabbix character set utf8mb4 collate utf8mb4_bin;&quot; sudo mysql -uroot -p'rootDBpass' -e &quot;grant all privileges on zabbix.* to zabbix@localhost identified by 'zabbixDBpass';&quot; zabbixDBpass为zabbix数据库密码。 d. 导入初始架构和数据 sudo zcat /usr/share/doc/zabbix-sql-scripts/mysql/server.sql.gz | mysql -uzabbix -p'zabbixDBpass' zabbix e.在Zabbix配置文件中输入数据库密码 使用命令打开文件（如果您没有安装&quot;nano&quot;，请使用&quot;vi&quot;）：zabbix_server.conf sudo nano /etc/zabbix/zabbix_server.conf 在文件中任意位置添加数据库密码： DBPassword=zabbixDBpass 保存并退出文件（ctrl+x，后跟 y 并回车） 4：启动Zabbix服务器和代理进程 systemctl restart zabbix-server zabbix-agent systemctl enable zabbix-server zabbix-agent 5：配置防火墙 firewall-cmd --add-service={http,https} --permanent firewall-cmd --add-port={10051/tcp,10050/tcp} --permanent firewall-cmd --reload 6：配置 Zabbix 前端 a. 重新启动 Apache Web 服务器，并使其在系统启动时启动 systemctl restart httpd php-fpm systemctl enable httpd php-fpm b.配置 Web 前端 使用 URL&quot;http:// server_ip_or_dns_name/zabbix&quot;连接到新安装的 Zabbix 前端，以启动 Zabbix 安装向导。在此向导中，您只需要输入Zabbix DB用户的密码，对于其他内容，只需单击&quot;下一步&quot;即可。 7：使用Zabbix默认登录凭据登录到前端 使用Zabbix默认管理员用户名&quot;Admin&quot;和密码&quot;zabbix&quot;（不带引号）通过浏览器登录到URL&quot;http:// server_ip_or_dns_name/zabbix&quot;的Zabbix前端。 8：在历史记录和事件表上创建MySQL分区（可选） Zabbix使用housekeeping进程删除旧的趋势和历史数据。使用 SQL DELETE语句从数据库中删除旧数据可能会对数据库性能产生负面影响。因此，有时候我们看到这个告警：Zabbix housekeeper processes more than 75% busy 这个问题可以通过数据库分区轻松解决。分区为每个小时或每天创建表，并在不再需要时删除它们。SQL DROP 比 DELETE 语句更有效。 您可以参照这个教程对MySQL表进行分区。 9：优化Zabbix服务器（可选） 如果您计划监视大量设备，请继续执行此步骤。 使用vi或nano命令打开zabbix_server.conf文件: nano /etc/zabbix/zabbix_server.conf 然后将下列配置添加到文件中的任意位置： StartPollers=100 StartPollersUnreachable=50 StartPingers=50 StartTrappers=10 StartDiscoverers=15 StartPreprocessors=15 StartHTTPPollers=5 StartAlerters=5 StartTimers=2 StartEscalators=2 CacheSize=128M HistoryCacheSize=64M HistoryIndexCacheSize=32M TrendCacheSize=32M ValueCacheSize=256M 保存并退出文件（ctrl+x，后跟 y 并回车）。请根据实际情况修改这些配置，比如你不使用ping监控，可以设定StartPingers=1。 10：优化 MySQL/MariaDB 数据库（可选） 有时您会碰到下面这个告警： [Z3001] connection to database 'Zabbix' failed: [1040] Too many connections/var/log/zabbix/zabbix_server.log 那么您可以添加如下配置： a. 创建自定义 MySQL 配置文件 通过vi或nano命令创建mysql.cnf配置文件： nano /etc/my.cnf.d/mysql.cnf 粘贴如下配置： [mysqld] max_connections = 404 innodb_buffer_pool_size = 800M innodb-log-file-size = 128M innodb-log-buffer-size = 128M innodb-file-per-table = 1 innodb_buffer_pool_instances = 8 innodb_old_blocks_time = 1000 innodb_stats_on_metadata = off innodb-flush-method = O_DIRECT innodb-log-files-in-group = 2 innodb-flush-log-at-trx-commit = 2 tmp-table-size = 96M max-heap-table-size = 96M open_files_limit = 65535 max_connect_errors = 1000000 connect_timeout = 60 wait_timeout = 28800 保存并退出文件（ctrl+x，后跟 y 并回车）。给该文件添加权限： chown mysql:mysql /etc/my.cnf.d/mysql.cnf chmod 644 /etc/my.cnf.d/mysql.cnf 要注意的2个参数： 参数max_connections必须大于所有 Zabbix 进程的总数加上 150。您可以使用以下命令自动检查Zabbix进程的数量（该命令的结果是加上了150后的值）： egrep &quot;^Start.+=[0-9]&quot; /etc/zabbix/zabbix_server.conf | awk -F &quot;=&quot; '{s+=$2} END {print s+150}' 404 第二个重要的参数是 innodb_buffer_pool_size。它决定了MySQL可以获得多少内存来缓存InnoDB表和索引数据。如果服务器上仅安装了数据库，则应将该参数设置为系统内存的 70%。 但是通常情况下，我们将Zabbix数据库和Apache安装在同一台服务器，因此建议将innodb_buffer_pool_size设置为总系统内存的40%。如果服务器是2G RAM，那么这个值将设定为是800MB。 b. 重新启动 Zabbix Server 和 MySQL 服务 systemctl stop zabbix-server systemctl stop mysql systemctl start mysql systemctl start zabbix-server 11：如何管理Zabbix / MySQL / Apache服务 有时您需要检查或重新启动Zabbix，MySQL或Apache服务， 使用下面的命令来执行此操作。 Zabbix Server systemctl &lt;status/restart/start/stop&gt; zabbix-server MySQL/MariaDB Server systemctl &lt;status/restart/start/stop&gt; mysql Apache Server systemctl &lt;status/restart/start/stop&gt; httpd PHP FastCGI Process Manager systemctl &lt;status/restart/start/stop&gt; php-fpm Zabbix Agent systemctl &lt;status/restart/start/stop&gt; zabbix-agent upgrade dnf upgrade 'zabbix-*' ","link":"https://eflytop.github.io/post/centos8-install-zabbix6/"},{"title":"VMware SD-WAN EDGE冗余方案","content":"SD-WAN采用管理平面、控制层面和数据层面分离的工作模式，其中VCO负责管理层面、VCG中的VCC部分负责控制层面、VCE负责数据层面。因此，VCO和VCG（VCC部分）的部署位置其实影响没有那么大，只是我们管理操作稍微慢点，更新路由稍微慢点（毫秒级别），数据通过VCE传输的，直接影响用户感知。 如果所有的VCO和VCG都挂了，根据官方信息，VCE上的路由表保持不变，在一定的时间内数据传输不受影响。 VCE有3种冗余模式或架构 HA高可用High Availability，适合大中小站点及数据中心 集群Clustering，适合大型站点及数据中心 VRRP (used in branch only)，适合小站点 3种冗余模式特征对比表 架构示意图 HA模式 HA模式又分为普通模式与增强模式，无论哪种模式都只能为Active和Standby状态。当Active VCE出问题时，Standby会自动接替Active继续工作。 两台VCE之间使用GE1口用作心跳线，建议部署新的非HA模式的VCE时，不要使用G1口，以便日后方便部署HA模式。 HA普通模式： HA增强模式： 集群模式： 每个VCE的LAN口和WAN口都需要一个独立的IP，如果VCE直连Internet，每个VCE都需要一个公网地址，MPLS线路建议先接入自行管理的路由器，然后通过路由器与每台VCE建BGP邻居。 根据官方文档，VCG会根据每台VCE的负载情况（CPU，内存，隧道容量）来调度，优先使用最低利用率的VCE来承担新的流量。 集群建议部署的VCE的数量为N+1, N为满足隧道数和吞吐量的最小VCE数量。 VRRP模式： 典型的运作模式为，主线路为专线接其它品牌路由器，备用线路为Internet接VCE，当专线断线时，流量自动切换到Internet接入的SD-WAN上。 VCO上VCE的冗余状态显示 lh-vce和lh-vce2为一个集群，HA列显示为【集群】，集群中的每台VCE单独展示； zz-vce为HA普通模式，HA列显示为一个圆点，2台VCE只展示一台； vce-b为HA普通模式，HA列显示为一个圆点，2台VCE只展示一台； vce-e为VRRP模式，HA列显示为双向箭头加数字。 ","link":"https://eflytop.github.io/post/vwmare-sd-wan-edge-ha/"},{"title":"VMware SD-WAN组件简介","content":"VMware SD-WAN by VeloCloud由三大组件组成，可以为企业提供高性能、可靠的组网服务。 这三个组件为： VMware SD-WAN Orchestrator VMware SD-WAN Gateway VMware SD-WAN Edge VMware SD-WAN Orchestrator 简称VCO，是基于虚拟化/云部署的组件，为VMware SD-WAN的管理中心，提供集中管理、配置和监控服务，通过它，可以实现Edge设备快速部署。此外，它还提供丰富的API接口，可用于提供管理、故障排除甚至与其它运营支持系统/业务支持系统（OSS/BSS）集成。它的主要功能有： 配置： 激活和部署Edge，并设定策略，它能支持Edge零接触部署。 监控： 能提供基于五元组甚至应用级别的监控数据，供客户或网络工程师使用。 诊断：为用户提供远程诊断、数据包捕获或其他用于故障排除的相关工具。 VMware SD-WAN Gateway 简称VCG，是基于虚拟化/云部署的组件，可以充当两个独立的角色，提供两个独立的服务。这两个服务为控制平面服务和数据平面服务。提供控制平面服务的子组件为VMware SD-WAN Controller（简称VCC），它提供如下两个很重要的功能： 链路发现 路由信息分发与更新 数据平面服务可以用来与SaaS和运营商集成，提供数据转发服务。 VCG有两个接口，一个网络接口连接到互联网，另一个网络接口连接到服务提供商的MPLS骨干网，使之能够访问服务提供商的基础设施和服务。 VMware SD-WAN Edge 简称VCE，部署在中心点、分支点或IaaS平台，为公网、私有线路提供接入，并转发数据到其它站点。除了有各种性能的硬件型号外，也提供用于虚拟化/云部署的软件镜像。 VMware SD-WAN Overlay Overlay层面，VMware SD-WAN使用VeloCloud Multi-path Protocol (VCMP) 协议来创建基于IPsec协议的隧道。VCMP隧道在两个VCE之间建立或在VCE和VCG之间建立。VCMP使用UDP端口2426。 三大组件之间的通信 管理平面 管理平面流量启用TLS 1.2加密传输，涉及以下组件的通信： VCE和VCO VCG和VCO VCE和VCG都注册在VCO，使用管理平面来接收配置和策略更新，以及上传统计信息和事件日志。VCE和VCG每30秒向VCO发送一次心跳包，如果连续四个心跳包丢失，VCE和VCG则被声明为离线。VCE还会每五分钟向VCO发送一次统计信息。 控制平面 控制平面利用VCE和VCG之间的VCMP隧道进行通信，用于交换路由信息。VCG检测WAN线路IP地址和带宽，并充当路由反射器角色，使VCE能收到和更新每个站点的路由。 数据平面 数据平面利用在两个VCE之间或在VCE和VCG之间的VCMP隧道进行通信，用于转发数据。 ","link":"https://eflytop.github.io/post/vmware-sd-wan-by-velocloud/"},{"title":"旧电脑绕过硬件限制升级Win11正式版最全「升级攻略」","content":"微软正式发布新一代Windows 11操作系统。升级Windows 11有一定的最低硬件要求，比如CPU、TPM 2.0版本等。本文将介绍旧电脑如何绕过硬件限制升级Win11正式版。 本文转自PCBETA论坛，原文链接：https://bbs.pcbeta.com/viewthread-1906293-1-2.html 本文涉及到的工具下载：https://wwi.lanzoui.com/b00oxkxsj 密码:2jx9 Windows 11官方下载网址：https://www.microsoft.com/zh-cn/software-download/windows11/ 选择「下载 Windows 11 磁盘映像 (ISO)」选项下载ISO文件 绕过硬件检测时注意断网~ 一、升级安装（方案1） 首先双击运行脚本“skip_tpm_check_on_dynamic_update_v2.cmd” 离线升级方法： 使用微软原版ISO离线升级（无需解压），双击装载。然后双击ISO根目录下的setup.exe即可。 在线升级方法： 情况1：如果已经通过offlineinsiderenroll强制切换到了Beta/RP通道，升级了Win11预览版，可以直接在Windows Update中检查更新，微软虽说不给升级，但并没有限制。（注意：如果使用了offlineinsiderenroll强制切换通道后，仍不能收到推送，还需要导入一个注册表rs_prerelease-SwitchChannel.reg，使通道可以自由切换，这样就能收到推送了。） 情况2：如果你现在的系统是Win10，想采用在线升级，则运行上述批处理，等待推送（因为微软分批推送，短时间未必能收到）。 优点：可以保留现有软件、设置等； 缺点：不是全新安装，可能会有遗留的疑难杂症。 二、升级安装（方案2） 步骤1、将ISO解压到C盘以外的某目录，比如E:\\Win11 步骤2、将“start_setup.bat”复制到ISO解压的根目录（与setup.exe同一目录） 步骤3、以管理员身份运行“start_setup.bat”，后续步骤一路下一步即可完成系统的升级安装或全新安装。 备注：相当于先解除限制、再运行ISO目录下的setup.exe。 优点：简便，不需要PE、U盘等 缺点：如果当前系统是32位，此方案失效。 三、全新安装（方案1） 步骤1、将ISO解压到C盘以外的某目录，比如E:\\Win11 步骤2、将“start_sources_setup.bat”复制到ISO解压的根目录（与setup.exe同一目录） 步骤3、以管理员身份运行“start_sources_setup.bat&quot; 备注：相当于先解除限制、再运行ISO\\sources目录下的setup.exe，此种方法虽是全新安装，但不能格式化C盘。生成的old文件夹，以后手动清理掉即可。 优点：简便，不需要PE、U盘等。与在PE下格式化安装几乎毫无区别，干净！ 缺点：如果当前系统是32位，此方案失效；与PE下安装相比，唯一缺陷是不能格式化C盘。 四、全新安装（方案2） 进入Win PE下： 步骤1、将ISO解压，比如E:\\Win11 步骤2、将“start_setup.bat”复制到ISO解压的根目录（与setup.exe同一目录） 步骤3、双击运行“start_setup.bat”，后续步骤一路下一步即可完成系统的升级安装或全新安装。 优点：全新安装，非常干净！ 缺点：需要准备64位Win10内核的PE，所以方便性上差一些。 五、全新安装（方案3） 不借助第三方WinPE，不借助U盘等，在当前系统下，使用Dism++工具： 步骤1、运行Dism++x86.exe，左上角恢复功能→在RE中运行。稍等片刻自动重启进入RE环境。 步骤2、使用左侧“工具箱”中的“系统还原”。依次设置5项内容：选择install.wim路径、选择系统盘（通常是C盘，如果盘符错乱，以“浏览”看到的为准）、选择Win11的版本、添加引导、格式化。选择完毕后，点击“确定”。 优点：全新安装，非常干净！不需要第三方的PE；也不需要U盘；无论当前系统是32位还是64位，均可行。与进入PE没有区别。 缺点：需要会使用Dism++这个工具，否则白费。 说明：可能有小伙伴会说，还可以不借助任何工具，直接重启进入高级启动，运行setup.exe不行吗？可以，但是局限性很大，比如当前32位系统，就不能安装64位的Win11。（反之也不可以） 六、全新安装（方案4） 进入Win PE： 使用Dism++、WinNTSetup、CGI等工具直接部署安装，无需考虑硬件限制的问题。 优点：全新安装，非常干净！ 缺点：需要会使用PE、Dism++等工具，否则白费。 七、全新安装（方案5） 改造ISO大法，需要下载工具v2.0_plus++版本： 步骤1、将原版ISO复制到W11目录下； 步骤2、运行Win_11_Boot_And_Upgrade_FiX_KiT_v2.0_plus++_by_zbezj.cmd，等待3-5分钟，生成一个新的ISO； 步骤3、将新的ISO写入U盘，U盘启动安装，即可绕过一切硬件限制。（U盘启动的制作工具很多，推荐Ventoy或Rufus，下载自行搜索） 优点：经过改造的ISO，U盘启动无需其他任何操作，与原版的安装方法一样。此外，也可以和上文方案一样，运行ISO根目录下的skip.cmd（或start_setup.bat）安装，既适用于Windows也适用于Win PE环境。还集成了Dism++工具，可以方便的调用。也就是说，改造后，上述所有方案的内容都包含在里面了，集上述所有功能于一身。 缺点：改造ISO，可能会觉得麻烦。（其实就两步、耗时3分钟，傻瓜式操作） 备注：改造ISO大法，也可把Win11的install.wim替换到Win10的ISO中，但不推荐。因为和原版ISO安装出来的不是100%一样的。 ","link":"https://eflytop.github.io/post/windows11-upgrade/"},{"title":"思科路由器Smart Licensing注册步骤","content":"本文将介绍思科路由器Smart Licensing注册步骤，以及如何将传统License转换成Smart License。 查看Smart Licensing VN-QC4351-1.20#sh license summary Smart Licensing is ENABLED Registration: Status: UNREGISTERED Export-Controlled Functionality: NOT ALLOWED License Authorization: Status: EVAL MODE Evaluation Period Remaining: 83 days, 1 hours, 20 minutes, 50 seconds License Usage: License Entitlement tag Count Status ----------------------------------------------------------------------------- (ISR_4351_Security) 1 EVAL MODE (ISR_4351_400M_Performance) 1 EVAL MODE 我们可以看到： 没有注册Smart Licensing。 License处于EVAL MODE试用模式。 注册Smart Licensing 配置代理（可选） 如果路由器需要通过代理服务器访问思科Smart Licensing，参考如下命令配置代理： VN-QC4351-1.20(config)#call-home VN-QC4351-1.20(cfg-call-home)#http-proxy 10.111.31.111 port 3128 VN-QC4351-1.20(cfg-call-home)#end 查看call-home信息： VN-QC4351-1.20#sh call-home Current call home settings: call home feature : enable call home message's from address: Not yet set up call home message's reply-to address: Not yet set up [...] source ip address: Not yet set up source interface: Not yet set up Mail-server: Not yet set up http proxy: 10.111.31.111:3128 [...] VN-QC4351-1.20#sh call-home profile all Profile Name: CiscoTAC-1 Profile status: ACTIVE Profile mode: Full Reporting Reporting Data: Smart Call Home, Smart Licensing Preferred Message Format: xml Message Size Limit: 3145728 Bytes Transport Method: http HTTP address(es): https://tools.cisco.com/its/service/oddce/services/DDCEService Other address(es): default Periodic configuration info message is scheduled every 12 day of the month at 12:38 [...] 申请Token令牌 访问并登录https://software.cisco.com/，点击[管理许可证]，参照下图所示申请Token: 复制令牌信息： 激活Token令牌 VN-QC4351-1.20#license smart register idtoken OGRlOTdlOWItZGI4[...] Registration process is in progress. Use the 'show license status' command to check the progress and result 查看注册状态： VN-QC4351-1.20#show license status Smart Licensing is ENABLED [...] Registration: Status: REGISTERED Smart Account: F*H M*** INDUSTRY S.****V. Virtual Account: CNCS Export-Controlled Functionality: ALLOWED Initial Registration: SUCCEEDED on Last Renewal Attempt: None Next Renewal Attempt: Registration Expires: [...] 把传统License转换成Smart License 查看当前License授权状态 VN-QC4351-1.20#sh license summary Smart Licensing is ENABLED [...] License Authorization: Status: OUT OF COMPLIANCE Last Communication Attempt: SUCCEEDED Next Communication Attempt: License Usage: License Entitlement tag Count Status ----------------------------------------------------------------------------- ISR_4351_Security (ISR_4351_Security) 1 OUT OF COMPLIANCE ISR_4351_400M_Perfor... (ISR_4351_400M_Performance) 1 OUT OF COMPLIANCE 可以看到License状态从EVAL MODE变成了OUT OF COMPLIANCE，没有被授权。 因为我们还没有将传统License转换成Smart License。 查询传统License VN-QC4351-1.20#sh platform software license dlc Index 1 Feature: securityk9 Permanent License: 1 EVAL RTU License: 0 RTU License: 0 Paper License: 0 Index 2 Feature: throughput Permanent License: 0 EVAL RTU License: 0 RTU License: 1 Paper License: 0 DLC Process Status: Not Complete 可以看到有一个Permanent License，有一个RTU License。 将传统License转换成Smart License 使用license smart conversion start命令开始转换： VN-QC4351-1.20#license smart conversion start 查询转换状态： VN-QC4351-1.20#show license all | sec License Conversion: License Conversion: Automatic Conversion Enabled: False Status: Successful on Sep 22 03:46:17 2021 PDT 转换时间较长，建议1小时后再查询状态。 查询License状态 VN-QC4351-1.20#sh license summary Smart Licensing is ENABLED Registration: Status: REGISTERED Smart Account: F*H M*** INDUSTRY S.****V. Virtual Account: CNCS Export-Controlled Functionality: ALLOWED Last Renewal Attempt: None Next Renewal Attempt: License Authorization: Status: OUT OF COMPLIANCE Last Communication Attempt: SUCCEEDED Next Communication Attempt: License Usage: License Entitlement tag Count Status ----------------------------------------------------------------------------- ISR_4351_Security (ISR_4351_Security) 1 AUTHORIZED ISR_4351_400M_Perfor... (ISR_4351_400M_Performance) 1 AUTHORIZED 两个License都已经AUTHORIZED了。 访问并登录https://software.cisco.com/查看设备注册状态： ","link":"https://eflytop.github.io/post/cisco-smart-licensing/"},{"title":"如何在CentOS 8/RHEL 8上安装Cacti","content":"Cacti是一个开源的基于Web的网络监控工具，可以用于监控系统的CPU、内存、进程数和网络带宽利用率等图形数据。使用Cacti我们可以通过SNMP监控路由器或交换机的网络流量。本文将介绍如何在CentOS 8/RHEL 8上安装Cacti。 STEP 1. SELinux设定 将Selinux设置为permissive模式 setenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config STEP 2. 环境准备 安装最新EPEL库： [root@localhost ~]# yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm 安装SNMP和RRDTool，RRDTool为Cacti数据轮询工具： [root@localhost ~]# yum install -y net-snmp net-snmp-utils net-snmp-libs rrdtool 安装MariaDB数据库： [root@localhost ~]# yum install -y mariadb-server mariadb 安装PHP组件： [root@localhost ~]# yum install -y php php-xml php-session php-sockets php-ldap php-gd php-json php-mysqlnd php-gmp php-mbstring php-posix php-snmp php-intl 启用相关服务： [root@localhost ~]# systemctl start httpd snmpd mariadb php-fpm [root@localhost ~]# systemctl enable httpd snmpd mariadb php-fpm STEP 3. 数据库调优 建议更改MySQL参数以获得更好的性能，参数请根据系统详细参数调整。 vi /etc/my.cnf.d/mariadb-server.cnf 在[mysqld]部分添加以下参数： collation-server=utf8mb4_unicode_ci character-set-server=utf8mb4 max_heap_table_size=32M tmp_table_size=32M join_buffer_size=64M # 25% Of Total System Memory innodb_buffer_pool_size=1GB # pool_size/128 for less than 1GB of memory innodb_buffer_pool_instances=10 innodb_flush_log_at_timeout=3 innodb_read_io_threads=32 innodb_write_io_threads=16 innodb_io_capacity=5000 innodb_io_capacity_max=10000 innodb_file_format=Barracuda innodb_large_prefix=1 重启服务： [root@localhost ~]# systemctl restart mariadb STEP 4. 创建Cacti数据库 初始化Maridb： [root@localhost ~]# mysql_secure_installation 配置步骤和参数供参考： Enter current password for root (enter for none): 敲回车 Set root password? [Y/n]: Y New password: &lt;Enter root DB password&gt; Re-enter new password: &lt;Repeat root DB password&gt; Remove anonymous users? [Y/n]: Y Disallow root login remotely? [Y/n]: Y Remove test database and access to it? [Y/n]: Y Reload privilege tables now? [Y/n]: Y 这里为root用户创建了一个MariaDB密码。 为Cacti创建一个数据库： [root@localhost ~]# mysql -u root -p Enter password: MariaDB [(none)]&gt; create database cacti; MariaDB [(none)]&gt; GRANT ALL ON cacti.* TO cactiuser@localhost IDENTIFIED BY 'cactipassword'; MariaDB [(none)]&gt; quit; 数据名为cacti，数据库用户名为cactiuser，把cactipassword修改为你自己的密码。 新创建的数据库用户cactiuser需有权访问mysql.time_zone_name表。要做到这一点，需要先把mysql_test_data_timezone.sql表导入到MySQL的数据库。 [root@localhost ~]# mysql -u root -p mysql &lt; /usr/share/mariadb/mysql_test_data_timezone.sql Enter password: 再次配置数据库，授权用户cactiuser访问mysql.time_zone_name表： [root@localhost ~]# mysql -u root -p Enter password: MariaDB [(none)]&gt; GRANT SELECT ON mysql.time_zone_name TO cactiuser@localhost; MariaDB [(none)]&gt; flush privileges; MariaDB [(none)]&gt; quit; 将zoneinfo目录路径名传递给mysql_tzinfo_to_sql程序并将输出发送到mysql程序： [root@localhost ~]# mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root mysql -p Enter password: STEP 5. 安装和配置Cacti 安装Cacti： [root@localhost ~]# yum install -y cacti 将默认数据库导入Cacti 数据库： [root@localhost ~]# mysql cacti &lt; /usr/share/doc/cacti/cacti.sql -u cactiuser -p Enter password: 编辑Cacti配置文件以指定数据库名称、主机名、用户和密码信息： [root@localhost ~]# vi /usr/share/cacti/include/config.php 进行相应的修改： $database_type = 'mysql'; $database_default = 'cacti'; $database_hostname = 'localhost'; $database_username = 'cactiuser'; $database_password = 'cactipassword'; $database_port = '3306'; 在crontab文件中编辑Cacti的cron条目以每五分钟轮询一次： [root@localhost ~]# vi /etc/cron.d/cacti 删除前面的#号以取消注释改行： */5 * * * * apache /usr/bin/php /usr/share/cacti/poller.php &gt; /dev/null 2&gt;&amp;1 编辑 Apache 配置文件使Cacti能被远程访问： [root@localhost ~]# vi /etc/httpd/conf.d/cacti.conf 删除Require host localhost行，添加内容Require all granted： Alias /cacti /usr/share/cacti &lt;Directory /usr/share/cacti/&gt; &lt;IfModule mod_authz_core.c&gt; # httpd 2.4 Require all granted &lt;/IfModule&gt; &lt;IfModule !mod_authz_core.c&gt; # httpd 2.2 Order deny,allow Deny from all Allow from localhost &lt;/IfModule&gt; &lt;/Directory&gt; 修改PHP时区及其它配置： [root@localhost ~]# vi /etc/php.ini 删除;date.timezone = 前面的; 号（取消注释），然后修改为正确的时区，并顺便优化相关PHP参数： date.timezone = Asia/Shanghai memory_limit = 512M max_execution_time = 60 点击时区列表查看各个时区。 重启相关服务： [root@localhost ~]# systemctl restart httpd php-fpm snmpd mariadb STEP 6. 防火墙设定 允许http连接： [root@localhost ~]# firewall-cmd --permanent --add-service=http [root@localhost ~]# firewall-cmd --reload STEP 7. (可选) 安装和配置Spine 在需要大量采集数据时，如果使用自带的cmd.php轮询器会比较慢，尤其在设定1分钟1次的采集频率下可能无法完成轮询所有的被监控的机器，从而可能导致部分监控项目不出图或图形断断续续。为了解决效率问题，Cacti官方也推出spine，采用多线程的方式高效的轮询。 安装spine： [root@localhost ~]# yum install cacti-spine 设置spine： [root@localhost ~]# vi /etc/spine.conf 填写主机名，用户和密码信息： DB_Host localhost DB_Database cacti DB_User cactiuser DB_Pass cactipassword DB_Port 3306 测试spine: [root@localhost ~]# /usr/bin/spine SPINE: Using spine config file [/etc/spine.conf] Version 1.2.17 starting Time: 0.2350 s, Threads: 1, Devices: 2 重启相关服务： [root@localhost ~]# systemctl restart httpd php-fpm snmpd mariadb STEP 8. 网页端设置 浏览器访问http://your-ip-address/cacti 输入默认账号admin/admin后根据提示设置和安装。 这个步骤可能会有一些报错，请根据具体提示修改相关参数： 安装完成后，记得在[系统设置] -&gt; [设置] -&gt; [Poller]选项卡下将采集类型由cmd修改为spine： ","link":"https://eflytop.github.io/post/cacti-installation-on-centos8/"},{"title":"如何在CentOS 8上安装Zabbix-Proxy","content":"Zabbix-Proxy可以代替Zabbix-Server从终端设备收集性能和可用性数据的服务。是Zabbix分布式架构中十分重要的组件。本教程中将介绍如何在CentOS 8上安装、优化和配置Zabbix Proxy 5.0 LTS或5.4 Standard版本。 STEP 1. 设置Selinux 将Selinux设置为permissive模式 setenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config STEP 2. 配置防火墙 firewall-cmd --add-service={http,https} --permanent firewall-cmd --add-port={10051/tcp,10050/tcp} --permanent firewall-cmd --reload STEP 3. 安装Zabbix Proxy 必须注意的是，你的Zabbix-Proxy版本必须要和Zabbix-Server版本匹配，你可以使用如下命令来确认Zabbix-Server版本： [root@localhost ~]# zabbix_server -V zabbix_server (Zabbix) 5.0.6 Zabbix 5.0: rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/8/x86_64/zabbix-release-5.0-1.el8.noarch.rpm dnf clean all dnf -y install zabbix-proxy-mysql Zabbix 5.4: rpm -Uvh https://repo.zabbix.com/zabbix/5.4/rhel/8/x86_64/zabbix-release-5.4-1.el8.noarch.rpm dnf clean all dnf -y install zabbix-proxy-mysql zabbix-sql-scripts STEP 4. 配置数据库 安装和启用MariaDB dnf -y install mariadb-server &amp;&amp; systemctl start mariadb &amp;&amp; systemctl enable mariadb 设置MySQL Root密码 输入如下命令初始化配置： mysql_secure_installation 配置步骤和参数供参考： Enter current password for root (enter for none): 敲回车 Set root password? [Y/n]: Y New password: &lt;Enter root DB password&gt; Re-enter new password: &lt;Repeat root DB password&gt; Remove anonymous users? [Y/n]: Y Disallow root login remotely? [Y/n]: Y Remove test database and access to it? [Y/n]: Y Reload privilege tables now? [Y/n]: Y 这里为root用户创建了一个MariaDB密码。 创建数据库 mysql -uroot -p Enter password: MariaDB [(none)]&gt; create database zabbix_proxy character set utf8 collate utf8_bin; MariaDB [(none)]&gt; create user zabbix@localhost identified by 'your zabbix DB password'; MariaDB [(none)]&gt; grant all privileges on zabbix_proxy.* to zabbix@localhost; MariaDB [(none)]&gt; quit; 这里创建了一个名为zabbix_proxy的数据库，然后创建了一个名为zabbix的用户，把'your zabbix DB password'中''里面的内容替换为你自己的密码。 导入初始数据 Zabbix 5.0: zcat /usr/share/doc/zabbix-proxy-mysql*/schema.sql.gz | mysql -uzabbix -p zabbix_proxy Zabbix 5.4: zcat /usr/share/doc/zabbix-sql-scripts/mysql/schema.sql.gz | mysql -uzabbix -p zabbix_proxy STEP 5. 配置Zabbix Proxy 本案例中，此Zabbix-Proxy将命名为zabbix_proxy_01，Zabbix-Server服务器地址为192.168.10.130。 编辑配置文件/etc/zabbix/zabbix_proxy.conf: vi /etc/zabbix/zabbix_proxy.conf 修改如下配置： DBPassword= your zabbix DB password ConfigFrequency= 100 Server=192.168.10.130 Hostname=zabbix_proxy_01 DBName=zabbix_proxy DBUser=zabbix ConfigFrequency参数定义了Zabbix-Proxy以秒为单位从Zabbix-Server获取配置数据的频率，默认为3600秒。 STEP 6. 启动Zabbix Proxy进程 systemctl restart zabbix-proxy &amp;&amp; systemctl enable zabbix-proxy STEP 7. 在Zabbix-Server网页端设置Proxy 如图所示进行配置： 至此，你已经在CentOS 8上成功安装了Zabbix-Proxy。下面是一些优化设定，请根据实际情况设定。 STEP 8. （可选）配置 PSK 加密 Zabbix服务器和代理之间可以使用TLS 1.2协议通信。可以使用证书或预共享密钥(PSK)加密。 这里介绍PSK加密方式。 在Zabbix-Proxy上生成PSK密钥 [root@localhost ~]# openssl rand -hex 32 3c17b47bd7795e341f9be4666b8a73643e6ef0aa0b21428df799c55a14203234 使用命令vi /etc/zabbix/zabbix_proxy.psk创建并打开文件zabbix_proxy.psk，然后将新生成的密钥复制粘贴到其中并保存。 设置权限： chown zabbix:zabbix /etc/zabbix/zabbix_proxy.psk chmod 644 /etc/zabbix/zabbix_proxy.psk 在Zabbix-Proxy上配置PSK加密 编辑配置文件/etc/zabbix/zabbix_proxy.conf: vi /etc/zabbix/zabbix_proxy.conf 修改如下配置： TLSConnect=psk TLSAccept=psk TLSPSKFile=/etc/zabbix/zabbix_proxy.psk TLSPSKIdentity=ZBX-PSK-01 重启服务： systemctl restart zabbix-proxy 在 Zabbix-Server网页端的代理上启用PSK加密 如图所示进行配置： STEP 9. （可选）优化Zabbix-Proxy 如果你监控的设备不多，就没必要进行此步骤，但如果计划监控大量设备，请执行此步骤。 编辑配置文件/etc/zabbix/zabbix_proxy.conf： vi /etc/zabbix/zabbix_proxy.conf 在任何位置加入如下参数： StartPollers=100 StartPollersUnreachable=50 StartPingers=50 StartTrappers=10 StartDiscoverers=15 StartHTTPPollers=5 CacheSize=128M HistoryCacheSize=64M HistoryIndexCacheSize=32M 请根据实际情况进一步优化，假设您不使用 ICMP 检查，则将StartPingers参数设置为1，或者如果您不使用活动代理，则将StartTrappers设置为1。您可以在官方文档中找到有关Zabbix配置文件中支持的参数的更多信息 。 STEP 10. （可选）优化MySQL/MariaDB数据库 创建自定义MySQL配置文件 通过命令vi /etc/my.cnf.d/zabbix_db.cnf创建zabbix_db.cnf数据库配置文件： vi /etc/my.cnf.d/zabbix_db.cnf 然后粘贴如下配置： [mysqld] max_connections = 280 innodb_buffer_pool_size = 1G innodb-log-file-size = 128M innodb-log-buffer-size = 128M innodb-file-per-table = 1 innodb_buffer_pool_instances = 8 innodb_old_blocks_time = 1000 innodb_stats_on_metadata = off innodb-flush-method = O_DIRECT innodb-log-files-in-group = 2 innodb-flush-log-at-trx-commit = 2 tmp-table-size = 96M max-heap-table-size = 96M open_files_limit = 65535 max_connect_errors = 1000000 connect_timeout = 60 wait_timeout = 28800 赋予权限： chown mysql:mysql /etc/my.cnf.d/zabbix_db.cnf chmod 644 /etc/my.cnf.d/zabbix_db.cnf 这样设定后可以避免一些报错，比如参数max_connections = 404可以解决这个报错：“[Z3001] connection to database 'zabbix_proxy' failed: [1040] Too many connections”。值得注意的是max_connections参数必须大于所有Zabbix代理进程总数+150，我们可以使用如下命令计算出来： [root@localhost ~]# egrep &quot;^Start.+=[0-9]&quot; /etc/zabbix/zabbix_proxy.conf | awk -F &quot;=&quot; '{s+=$2} END {print s+150}' 201 还有一个比较重要的参数是innodb_buffer_pool_size，这个参数决定了MySQL可以获得多少内存来缓存 InnoDB表和索引数据。如果服务器只运行了数据库，我们建议将这个值设定为系统内存的70%，这里我们还运行了Zabbix-Proxy服务，我们建议将这个值设定为系统内存的50%。假如系统内存为2G，那么这个值为1G。 重启进程 systemctl restart zabbix-proxy systemctl restart mariadb ","link":"https://eflytop.github.io/post/zabbix-proxy-installation/"},{"title":"如何在CentOS 8上安装Zabbix 5.0或5.4","content":"Zabbix是100%免费开源的企业级监控软件，旨在监控IT基础设施组件和服务的可用性和性能。Zabbix可安装在任何Linux发行版上，本教程将展示在CentOS 8上如何安装Zabbix 5.0 LTS和Zabbix 5.4版本。 Zabbix 5.0 LTS 版本官方支持至 2025年5月，Zabbix 5.4 标准版官方支持至 2021年12月。 首先我们安装和配置 Zabbix 服务器，然后是数据库，最后是WEB前端frontend。 STEP 1. 设置Selinux 将Selinux设置为permissive模式 setenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config STEP 2. 安装zabbix-server, zabbix-web和zabbix-agent Zabbix 5.0： rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/8/x86_64/zabbix-release-5.0-1.el8.noarch.rpm dnf clean all dnf -y install zabbix-server-mysql zabbix-web-mysql zabbix-apache-conf zabbix-agent Zabbix 5.4： rpm -Uvh https://repo.zabbix.com/zabbix/5.4/rhel/8/x86_64/zabbix-release-5.4-1.el8.noarch.rpm dnf clean all dnf -y install zabbix-server-mysql zabbix-web-mysql zabbix-apache-conf zabbix-sql-scripts zabbix-agent 可以看出5.4多了zabbix-sql-scripts这个组件。 STEP 3. 安装和配置MariaDB数据库 安装MariaDB和启用MariaDB服务 dnf -y install mariadb-server &amp;&amp; systemctl start mariadb &amp;&amp; systemctl enable mariadb 配置MariaDB 输入如下命令初始化配置： mysql_secure_installation 配置步骤和参数供参考： Enter current password for root (enter for none): 敲回车 Set root password? [Y/n]: Y New password: &lt;Enter root DB password&gt; Re-enter new password: &lt;Repeat root DB password&gt; Remove anonymous users? [Y/n]: Y Disallow root login remotely? [Y/n]: Y Remove test database and access to it? [Y/n]: Y Reload privilege tables now? [Y/n]: Y 这里为root用户创建了一个MariaDB密码。 创建数据库 mysql -uroot -p Enter password: MariaDB [(none)]&gt; create database zabbix character set utf8 collate utf8_bin; MariaDB [(none)]&gt; create user zabbix@localhost identified by 'your zabbix DB password'; MariaDB [(none)]&gt; grant all privileges on zabbix.* to zabbix@localhost; MariaDB [(none)]&gt; quit; 这里创建了一个名为zabbix的数据库，然后创建了一个名为zabbix的用户，把'your zabbix DB password'中''里面的内容替换为你自己的密码。 导入初始架构和数据 Zabbix 5.0： zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix Enter password: Zabbix 5.4： zcat /usr/share/doc/zabbix-sql-scripts/mysql/create.sql.gz | mysql -uzabbix -p zabbix Enter password: 如果出现报错ERROR 1118 (42000) at line 1284: Row size too large (&gt; 8126)，可以通过如下命令临时关闭strict mode： mysql -uroot -p Enter password: MariaDB [(none)]&gt;set global innodb_strict_mode='OFF'; MariaDB [(none)]&gt; quit; 然后再执行上面的数据导入步骤，数据导入完毕后再开启strict mode： mysql -uroot -p Enter password: MariaDB [(none)]&gt;set global innodb_strict_mode='ON'; MariaDB [(none)]&gt; quit; 修改zabbix_server.conf配置文件 编辑配置文件 /etc/zabbix/zabbix_server.conf： vi /etc/zabbix/zabbix_server.conf 把Zabbix数据库密码修改为上面设定的密码： DBPassword= your zabbix DB password 假如你设定的数据库名和用户名不是为zabbix，对应的也是在这个文件中把数据库名和用户名修改为你设定的名字。 STEP 4. 配置防火墙 firewall-cmd --add-service={http,https} --permanent firewall-cmd --add-port={10051/tcp,10050/tcp} --permanent firewall-cmd --reload STEP 5. 配置Zabbix前端frontend 配置PHP中的时区参数 编辑/etc/php-fpm.d/zabbix.conf文件： vi /etc/php-fpm.d/zabbix.conf 删除php_value date.timezone Europe/Riga前面的; 号（取消注释），然后修改为正确的时区： php_value[date.timezone] = Asia/Shanghai 点击时区列表查看各个时区。 重启zabbix-server, zabbix-agent, http和php服务进程 systemctl restart zabbix-server zabbix-agent httpd php-fpm &amp;&amp; systemctl enable zabbix-server zabbix-agent httpd php-fpm 配置Web前端 用浏览器打开网址http://server_ip_or_name/zabbix，根据提示一步一步往下进行配置，在DB配置页面输入正确的数据库密码： 最后输入默认的用户名密码Admin/zabbix登录。 至此，你已经在CentOS 8上成功安装了Zabbix 5，现在您可以监控任何东西了。下面是一些优化设定，请根据实际情况设定。 STEP 6. （可选）优化Zabbix服务器参数 如果你监控的设备不多，就没必要进行此步骤，但如果计划监控大量设备，请执行此步骤。 编辑配置文件 /etc/zabbix/zabbix_server.conf： vi /etc/zabbix/zabbix_server.conf 在任何位置加入如下参数： StartPollers=100 StartPollersUnreachable=50 StartPingers=50 StartTrappers=10 StartDiscoverers=15 StartPreprocessors=15 StartHTTPPollers=5 StartAlerters=5 StartTimers=2 StartEscalators=2 CacheSize=128M HistoryCacheSize=64M HistoryIndexCacheSize=32M TrendCacheSize=32M ValueCacheSize=256M 请根据实际情况进一步优化，假设您不使用 ICMP 检查，则将StartPingers参数设置为1，或者如果您不使用活动代理，则将StartTrappers设置为1。您可以在官方文档中找到有关Zabbix配置文件中支持的参数的更多信息 。 STEP 7. （可选）优化MySQL/MariaDB数据库 创建自定义MySQL配置文件 通过命令vi /etc/my.cnf.d/zabbix_db.cnf创建zabbix_db.cnf数据库配置文件： vi /etc/my.cnf.d/zabbix_db.cnf 然后粘贴如下配置： [mysqld] max_connections = 404 innodb_buffer_pool_size = 800M innodb-log-file-size = 128M innodb-log-buffer-size = 128M innodb-file-per-table = 1 innodb_buffer_pool_instances = 8 innodb_old_blocks_time = 1000 innodb_stats_on_metadata = off innodb-flush-method = O_DIRECT innodb-log-files-in-group = 2 innodb-flush-log-at-trx-commit = 2 tmp-table-size = 96M max-heap-table-size = 96M open_files_limit = 65535 max_connect_errors = 1000000 connect_timeout = 60 wait_timeout = 28800 赋予权限： chown mysql:mysql /etc/my.cnf.d/zabbix_db.cnf chmod 644 /etc/my.cnf.d/zabbix_db.cnf 这样设定后可以避免一些报错，比如参数max_connections = 404可以解决这个报错：“[Z3001] connection to database 'zabbix' failed: [1040] Too many connections”。值得注意的是max_connections参数必须大于所有Zabbix代理进程总数+150，我们可以使用如下命令计算出来： egrep &quot;^Start.+=[0-9]&quot; /etc/zabbix/zabbix_server.conf | awk -F &quot;=&quot; '{s+=$2} END {print s+150}' 还有一个比较重要的参数是innodb_buffer_pool_size，这个参数决定了MySQL可以获得多少内存来缓存 InnoDB表和索引数据。如果服务器只运行了数据库，我们建议将这个值设定为系统内存的70%；这里我们同时运行了数据库、Zabbix-Server及WEB服务，我们建议将这个值设定为系统内存的40%，假如系统内存为2G，那么这个值为800MB。 重启进程 systemctl restart zabbix-server systemctl restart mariadb STEP 8. （可选）在History和Events表上创建MySQL分区 Zabbix的housekeeping进程负责删除旧的trend和history数据，这个动作会对数据库性能产生负面影响，有时会产生这个烦人的警报：Zabbix housekeeper processes more than 75% busy。 使用数据库分区可以轻松解决该问题。分区每小时或每天创建表，并在不再需要时删除它们。SQL DROP 比 DELETE 语句更有效。 MySQL分区教程请详见本网站为Zabbix在History和Events表上创建MySQL分区博文教程。 ","link":"https://eflytop.github.io/post/centos8-install-zabbix5/"},{"title":"Cisco Nexus VPC配置向导","content":"vPC是一种实现跨设备链路聚合的机制，基于LACP进行了扩展，能够实现多台设备间的链路聚合，从而把链路可靠性从单设备级提高到了多设备级。目前，vPC可以在Cisco Nexus 9000、7000、5000和3000系列平台上实施。 名词 VPC - Virtual Port Channel VPC Peer - 指的是通过vPC Peer-link链接的两台相邻交换机，其它设备通过Multi-Channel Ethernet (MEC)跟这两台交换机链接。 VPC Peer-link - 用于同步和转发两台VPC PEER的数据，包括组播，广播，单播等。需要至少10G以上的端口链接。 VPC Peer Keepalive Link - 提供一个L3通道来再次验证两个VPC PEER是否运作正常。可以检测出VPC Peer自己是否发生故障或者对方已经关闭。它不转发和同步数据，使用UDP 3200端口，默认检测时间为1秒超时5秒。 VPC domain - 通过domain ID来区分不同domain。 VPC Member port - 加入VPC Peer-link的端口。 Cisco Fabric Service (CFS) - 该协议用于有状态的同步和配置，不需要进行额外的配置。 vPC配置步骤 vPC配置通常有9个步骤，应该注意的是，vPC 配置的顺序很重要，基本的 vPC 设置是通过使用前 4 个步骤建立的： 步骤 1：开启vPC特性并在两台 Nexus 交换机上配置 vPC domain ID。 步骤 2：选择一个Peer Keepalive链接部署方式。 步骤 3：建立vPC Peer Keepalive链接。 步骤 4：配置vPC Peer-Link，完成全局 vPC 配置。 步骤 5：将vPC配置到下游交换机或设备。 步骤 6：（可选）开启peer gateway以优化HSRP。 步骤 7：（可选）开启peer switch特性来优化vPC的STP。 步骤 8：（可选）其它优化VPC设定。 步骤 9：（可选）验证vPC参数。 CISCO NEXUS VPC 配置示例 这里我们以两台N5K交换机为例来配置vPC。两台交换机分别命名为N5k-Primary和N5k-Secondary。 步骤 1：开启vPC特性并在两台 Nexus 交换机上配置 vPC domain ID。 N5k-Primary(config)# feature vpc N5k-Primary(config)# vpc domain 1 N5k-Primary(config-vpc-domain)# show vpc role vPC Role status ---------------------------------------------------- vPC role : none established Dual Active Detection Status : 0 vPC system-mac : 00:23:04:ee:be:01 vPC system-priority : 32667 vPC local system-mac : 8c:60:4f:2c:b3:01 vPC local role-priority : 0 N5k-Secondary(config)# feature vpc N5k-Secondary(config)# vpc domain 1 N5k-Secondary(config-vpc-domain)# show vpc role vPC Role status ---------------------------------------------------- vPC role : none established Dual Active Detection Status : 0 vPC system-mac : 00:23:04:ee:be:01 vPC system-priority : 32667 vPC local system-mac : 8c:60:4f:aa:c2:3c vPC local role-priority : 0 两台交换机必须使用相同的domain ID，这里把domain ID配置为1。show vpc role命令的显示的系统MAC地址来自vPC的domain ID，它等于01。 步骤 2：选择一个Peer Keepalive链接部署方式。 Peer Keepalive有如下部署方式： 这里我们采用第二种方式启用SVI进行。先启用一个专用VLAN，然后配置SVI并划分到一个专用VRF里面来区分和隔离其它流量。默认情况下，vPC Peer Keepalive数据包使用管理接口并在VRF management中传输。但是强烈建议为vPC Peer Keepalive链路单独配置一个VRF，以确保Peer Keepalive流量始终在Peer Keepalive链路上传输，而从不在Peer-Link上传输。 这里我们使用接口Ethernet1/32用作Peer Keepalive的专用接口： N5k-Primary(config)# vlan 23 N5k-Primary(config-vlan)# name keepalive N5k-Primary(config)# vrf context keepalive N5k-Primary(config)#interface Vlan23 N5k-Primary(config)# vrf member keepalive N5k-Primary(config)# ip address 192.168.1.1/24 N5k-Primary(config)#interface Ethernet1/32 N5k-Primary(config)# switchport access vlan 23 N5k-Secondary (config)# vlan 23 N5k-Secondary(config-vlan)# name keepalive N5k-Secondary(config)# vrf context keepalive N5k-Secondary (config)# interface Vlan23 N5k-Secondary (config)# vrf member keepalive N5k-Secondary (config)# ip address 192.168.1.2/24 N5k-Secondary (config)# interface Ethernet1/32 N5k-Secondary (config)# switchport access vlan 23 验证peer keepalive链接： N5k-Secondary# ping 192.168.1.1 vrf keepalive PING 192.168.1.1 (192.168.1.1): 56 data bytes 36 bytes from 192.168.1.2: Destination Host Unreachable Request 0 timed out 64 bytes from 192.168.1.1: icmp_seq=1 ttl=254 time=3.91 ms 前几个包丢包是正常现象，因为交换机需要首先发出 ARP 请求以获取192.168.1.1的MAC地址，然后发送 ICMP数据包。 步骤 3：建立vPC Peer Keepalive链接。 N5k-Primary(config)# vpc domain 1 N5k-Primary (config-vpc-domain)# peer-keepalive destination 192.168.1.2 source 192.168.1.1 vrf keepalive N5k-Secondary(config)# vpc domain 1 N5k-Secondary(config-vpc-domain)# peer-keepalive destination 192.168.1.1 source 192.168.1.2 vrf keepalive 在两台交换机上使用show vpc peer-keepalive命令验证： N5k-Secondary# show vpc peer-keepalive vPC keep-alive status : peer is alive --Peer is alive for : (106) seconds, (385) msec --Send status : Success --Last send at : 2017.06.22 22:46:32 106 ms --Sent on interface : Vlan23 --Receive status : Success --Last receive at : 2017.06.22 22:46:32 5 ms --Received on interface : Vlan23 --Last update from peer : (0) seconds, (333) msec vPC Keep-alive parameters --Destination : 192.168.1.1 --Keepalive interval : 1000 msec --Keepalive timeout : 5 seconds --Keepalive hold timeout : 3 seconds --Keepalive vrf : keepalive --Keepalive udp port : 3200 --Keepalive tos : 192 步骤 4：配置vPC Peer-Link，完成全局 vPC 配置。 开启lacp特性，并建立PortChannel用于vPC Peer-Link。 N5k-Primary (config)# feature lacp N5k-Primary(config)# interface ethernet 1/2-3 N5k-Primary(config-if-range)# description *** VPC PEER LINKS *** N5k-Primary(config-if-range)# channel-group 23 mode active N5k-Primary(config)# interface port-channel 23 N5k-Primary(config-if)# description *** VPC PEER LINKS *** N5k-Primary(config-if)# switchport mode trunk N5k-Primary(config-if)# switchport trunk allowed vlan 10, x, xx, xxx N5k-Primary(config-if)# vpc peer-link N5k-Primary(config-if)# spanning-tree port type network 把PortChannel配置成Trunk，并允许相关Vlan流量。建议排除Peer Keepalive VLAN，如上面配置的Vlan 23，同时不建议在该Trunk上允许non-vPC VLAN，因为这种配置可能会导致当vPC出现问题时non-vPC VLAN的流量中断，如果VPC同行链接失败。 N5k-Secondary(config)# feature lacp N5k-Seondary(config)# interface ethernet 1/2-3 N5k-Secondary(config-if-range)# description *** VPC PEER LINKS *** N5k-Secondary(config-if-range)# channel-group 23 mode active N5k-Secondary(config)# interface port-channel 23 N5k-Secondary(config-if)# description *** VPC PEER LINKS *** N5k-Secondary(config-if)# switchport mode trunk N5k-Secondary(config-if)# switchport trunk allowed vlan 10, x, xx, xxx N5k-Secondary(config-if)# vpc peer-link N5k-Secondary(config-if)# spanning-tree port type network 在两台交换机上使用show vpc验证： N5k-Secondary# show vpc Legend: (*) - local vPC is down, forwarding via vPC peer-link vPC domain id : 1 Peer status : peer adjacency formed ok vPC keep-alive status : peer is alive Configuration consistency status : success Per-vlan consistency status : success Type-2 consistency status : success vPC role : secondary, operational primary Number of vPCs configured : 0 Peer Gateway : Disabled Dual-active excluded VLANs : - Graceful Consistency Check : Enabled Auto-recovery status : Enabled (timeout = 240 seconds) vPC Peer-link status --------------------------------------------------------------------- id Port Status Active vlans -- ---- ------ -------------------------------------------------- 1 Po23 up 10 步骤 5：将vPC配置到下游交换机或设备。 上述步骤中已正确建立vPC域，因此现在可以为下游交换机配置vPC。这台下游交换机将分别连接到两台vPC Peer交换机，以增加冗余和带宽可用性。 N5k-Primary(config)#interface Ethernet1/1 N5k-Primary(config)# description *** Connected to Switch *** N5k-Primary(config)# switchport access vlan 10 N5k-Primary(config)# channel-group 10 N5k-Primary(config)#interface port-channel10 N5k-Primary(config)# switchport access vlan 10 N5k-Primary(config)# vpc 10 N5k-Secondary(config)#interface Ethernet1/1 N5k-Secondary(config)# description *** Connected to Switch *** N5k-Secondary(config)# switchport access vlan 10 N5k-Secondary(config)# channel-group 10 N5k-Secondary(config)#interface port-channel10 N5k-Secondary(config)# switchport access vlan 10 N5k-Secondary(config)# vpc 10 Switch(config)#interface range Ethernet1/1 - 2 Switch(config)#description *** Connected to vPC Peer *** Switch(config)#switchport access vlan 10 Switch(config)# channel-group 10 Switch(config)#interface port-channel10 Switch(config)# switchport access vlan 10 步骤 6：（可选）开启peer gateway以优化HSRP。 在vPC中使用HSRP没有任何特殊配置，同正常的HSRP操作一样，Active HSRP接口响应ARP请求，区别的是vPC HSRP（active 和 standby）均会转发流量。 如果发送到3层网关的帧使用MAC burn -in-address（实mac）而不是HSRP MAC（虚mac）地址，那么因PortChannel hash可能会将它转发到错误的vPC peer，而该错误的vPC peer将会通过vPC peer link将帧发给另一个vPC peer。这样因为 vPC duplicate prevention rule，帧将不会再给vPC成员端口。解决以上问题的配置命令：peer-gateway。该命令允许vPC peers 交换各自的BIA MAC地址的信息，这样它们就可以在本地直接转发流量，而不必通过vPC peer link转发流量。 N5k-Primary(config)# vpc domain 1 N5k-Primary(config-vpc-domain)# peer-gateway N5k-Secondary(config)# vpc domain 1 N5k-Secondary(config-vpc-domain)# peer-gateway 步骤 7：（可选）开启peer switch特性来优化vPC的STP。 通常情况下，我们需要将Primary Switch配置成root primary，将Secondary Switch配置成此root secondary。开启peer switch特性后可以使两台vPC交换机运行为单个生成树根。加快了vPC交换机出现故障时STP的收敛速度。 N5k-Primary(config)# vpc domain 1 N5k-Primary(config-vpc-domain)# peer-switch N5k-Secondary(config)# vpc domain 1 N5k-Secondary(config-vpc-domain)# peer-switch 步骤 8：（可选）其它优化VPC设定。 N5k-Primary(config)# vpc domain 1 N5k-Primary(config-vpc-domain)# delay restore 360 N5k-Primary(config-vpc-domain)# auto-recovery Warning: Enables restoring of vPCs in a peer-detached state after reload, will wait for 240 seconds to determine if peer is un-reachable N5k-Primary(config-vpc-domain)# graceful consistency-check N5k-Primary(config-vpc-domain)# ip arp synchronize N5k-Secondary(config)# vpc domain 1 N5k-Secondary(config-vpc-domain)# delay restore 360 N5k-Secondary(config-vpc-domain)# auto-recovery Warning: Enables restoring of vPCs in a peer-detached state after reload, will wait for 240 seconds to determine if peer is un-reachable N5k-Secondary(config-vpc-domain)# graceful consistency-check N5k-Secondary(config-vpc-domain)# ip arp synchronize 步骤 9：（可选）验证vPC参数。 N5k-Primary# show vpc brief N5k-Primary# show vpc consistency-parameters global ","link":"https://eflytop.github.io/post/VPC-CONFIGURATION-GUIDE/"},{"title":"Cisco VSS简易配置向导","content":"VSS是思科的一种交换机集群技术，可将两台物理交换机虚拟成一台逻辑交换机。两台物理交换机通过VSL链路连接，用于承载控制平面和转发平面流量。本文以两台Catalyst 4500为例，展示如何配置VSS。 名词： VSS - Virtual Switching System VSL - Virtual Switch Link 配置步骤： 1. 配置Virtual Switch Domain和Switch Numbers 首先，您须在 VSS 的两台交换机上配置相同的Virtual Switch Domain。Virtual Switch Domain是1到255之间的数字。然后您须将一台交换机配置为Switch Number 1，另一台交换机配置为Switch Number 2。 SW1#conf t Enter configuration commands, one per line. End with CNTL/Z. SW1(config)#switch virtual domain 10 Domain ID 10 config will take effect only after the exec command 'switch convert mode virtual' is issued SW1(config-vs-domain)#switch 1 SW1(config-vs-domain)#exit SW1(config)# SW2#conf t Enter configuration commands, one per line. End with CNTL/Z. SW2(config)#switch virtual domain 10 Domain ID 10 config will take effect only after the exec command 'switch convert mode virtual' is issued SW2(config-vs-domain)#switch 2 SW2(config-vs-domain)#exit SW2(config)# 2. 配置VSL PortChannel 您需要在每台交换机上使用PortChannel配置 VSL。PortChannel号需要不一样，否则VSS不能正常建立将进入 RPR 模式。为避免这种情况，请为两个交换机上的两个PortChannel分配不同编号。 SW1(config)#int port-channel 5 SW1(config-if)#switchport SW1(config-if)#switch virtual link 1 SW1(config-if)#no shut SW1(config-if)#exit *Jan 24 05:19:57.092: %SPANTREE-6-PORTDEL_ALL_VLANS: Port-channel5 deleted from all Vlans SW2(config)#int port-channel 10 SW2(config-if)#switchport SW2(config-if)#switch virtual link 2 SW2(config-if)#no shut SW2(config-if)#exit SW2(config)# *Jan 24 05:14:17.273: %SPANTREE-6-PORTDEL_ALL_VLANS: Port-channel10 deleted from all Vlans 3. 配置VSL端口 将 VSL 物理端口添加到PortChannel。在以下示例中，Switch 1上的Gi7/3和Gi7/4接口连接到Switch 2上的Gi4/45和Gi4/46接口。 SW1(config)#int range gig7/3 - 4 SW1(config-if-range)#switchport mode trunk SW1(config-if-range)#channel-group 5 mode on WARNING: Interface GigabitEthernet7/3 placed in restricted config mode. All extraneous configs removed! WARNING: Interface GigabitEthernet7/4 placed in restricted config mode. All extraneous configs removed! SW1(config-if-range)#exit SW2(config)#int range gig4/45 - 46 SW2(config-if-range)#switchport mode trunk SW2(config-if-range)#channel-group 10 mode on WARNING: Interface GigabitEthernet4/45 placed in restricted config mode. All extraneous configs removed! WARNING: Interface GigabitEthernet4/46 placed in restricted config mode. All extraneous configs removed! SW2(config-if-range)#exit 注意：一旦使用“channel-group”命令将接口放入VSL端口通道，则接口进入“notconnect”状态。Interface status显示为UP，但line protocol将down。接口将处于up/down状态，直到交换机在步骤 4 中重新启动。 4. 切换交换机至Virtual Switch模式 在switch 1上输入switch convert mode virtual命令将交换机转换为 Virtual Switch模式。系统创建一个转换后的配置文件，并将配置文件保存到bootflash，并自动重启。 SW1#switch convert mode virtual This command will convert all interface names to naming convention &quot;interface-type switch-number/slot/port&quot;, save the running config to startup-config and reload the switch. Do you want to proceed? [yes/no]: yes Converting interface names Building configuration... Compressed configuration from 6551 bytes to 2893 bytes[OK] Saving converted configuration to bootflash: ... Destination filename [startup-config.converted_vs-20130124-062921]? Please stand by while rebooting the system... Restarting system. Rommon (G) Signature verification PASSED Rommon (P) Signature verification PASSED FPGA (P) Signature verification PASSED 同样的操作命令将switch 2转换为Virtual Switch模式： SW2#switch convert mode virtual​ This command will convert all interface names to naming convention &quot;interface-type switch-number/slot/port&quot;, save the running config to startup-config and reload the switch. Do you want to proceed? [yes/no]: yes Converting interface names Building configuration... Compressed configuration from 6027 bytes to 2774 bytes[OK] Saving converted configuration to bootflash: ... Destination filename [startup-config.converted_vs-20130124-052526]? Please stand by while rebooting the system... Restarting system. Rommon (G) Signature verification PASSED Rommon (P) Signature verification PASSED FPGA (P) Signature verification PASSED 重启完毕后交换机将处于Virtual Switch模式，可以通过如下命令验证。 show switch virtual 查询virtual switch domain number和switch number及角色（Active or Standby）。 SW1#sh switch virtual Executing the command on VSS member switch role = VSS Active, id = 1 Switch mode : Virtual Switch Virtual switch domain number : 10 Local switch number : 1 Local switch operational role: Virtual Switch Active Peer switch number : 2 Peer switch operational role : Virtual Switch Standby Executing the command on VSS member switch role = VSS Standby, id = 2 Switch mode : Virtual Switch Virtual switch domain number : 10 Local switch number : 2 Local switch operational role: Virtual Switch Standby Peer switch number : 1 Peer switch operational role : Virtual Switch Active Standby Switch用console登录后无法查看和修改配置，仅能看到如下提示： SW2-standby&gt; Standby console disabled show switch virtual role'查看交换机详细角色信息： SW1#sh switch virtual role Executing the command on VSS member switch role = VSS Active, id = 1 RRP information for Instance 1 -------------------------------------------------------------------- Valid Flags Peer Preferred Reserved Count Peer Peer -------------------------------------------------------------------- TRUE V 1 1 1 Switch Switch Status Preempt Priority Role Local Remote Number Oper(Conf) Oper(Conf) SID SID -------------------------------------------------------------------- LOCAL 1 UP FALSE(N ) 100(100) ACTIVE 0 0 REMOTE 2 UP FALSE(N ) 100(100) STANDBY 6834 6152 Peer 0 represents the local switch Flags : V - Valid In dual-active recovery mode: No Executing the command on VSS member switch role = VSS Standby, id = 2 RRP information for Instance 2 -------------------------------------------------------------------- Valid Flags Peer Preferred Reserved Count Peer Peer -------------------------------------------------------------------- TRUE V 1 1 1 Switch Switch Status Preempt Priority Role Local Remote Number Oper(Conf) Oper(Conf) SID SID -------------------------------------------------------------------- LOCAL 2 UP FALSE(N ) 100(100) STANDBY 0 0 REMOTE 1 UP FALSE(N ) 100(100) ACTIVE 6152 6834 Peer 0 represents the local switch Flags : V - Valid In dual-active recovery mode: No show switch virtual link查看VSL链路状态： SW1#sh switch virtual link Executing the command on VSS member switch role = VSS Active, id = 1 VSL Status : UP VSL Uptime : 3 minutes VSL Control Link : Gi1/7/4 Executing the command on VSS member switch role = VSS Standby, id = 2 VSL Status : UP VSL Uptime : 3 minutes VSL Control Link : Gi2/4/45 show switch virtual link port-channel查看PortChannel信息： SW1#sh switch virtual link port-channel Executing the command on VSS member switch role = VSS Active, id = 1 Flags: D - down P - bundled in port-channel I - stand-alone s - suspended H - Hot-standby (LACP only) R - Layer3 S - Layer2 U - in use N - not in use, no aggregation f - failed to allocate aggregator M - not in use, no aggregation due to minimum links not met m - not in use, port not aggregated due to minimum links not met u - unsuitable for bundling d - default port w - waiting to be aggregated Group Port-channel Protocol Ports ------+-------------+-----------+------------------- 5 Po5(SU) - Gi1/7/3(P) Gi1/7/4(P) 10 Po10(SU) - Gi2/4/45(P) Gi2/4/46(P) Executing the command on VSS member switch role = VSS Standby, id = 2 Flags: D - down P - bundled in port-channel I - stand-alone s - suspended H - Hot-standby (LACP only) R - Layer3 S - Layer2 U - in use N - not in use, no aggregation f - failed to allocate aggregator M - not in use, no aggregation due to minimum links not met m - not in use, port not aggregated due to minimum links not met u - unsuitable for bundling d - default port w - waiting to be aggregated Group Port-channel Protocol Ports ------+-------------+-----------+------------------- 5 Po5(SU) - Gi1/7/3(P) Gi1/7/4(P) 10 Po10(SU) - Gi2/4/45(P) Gi2/4/46(P) VSS正常运作后，交换机端口号由原来的Gi x/x自动转换成了Gi 1/x/x或Gi 2/x/x。1和2为两台硬件交换机编号，从逻辑上你可以把这两台交换机当作一台交换机了。你可以分别在这两台交换机上选一个端口比如Gi1/0/8和Gi2/0/8与其它交换机建立PortChannel。 ","link":"https://eflytop.github.io/post/vss-cfg-guildline/"},{"title":"Cisco VSS vs VPC","content":"VSS和VPC都可以将Port-channel的概念扩展到两个独立的物理交换机，这样消除了Spanning Tree，简化了管理，提高了HA。第三个设备可以分别连接至这两台硬件交换机，并配置成PortChannel。第三个设备可以是交换机、服务器，或者支持PortChannel的其他网络设备。 传统Port Channel 交换机端使用LACP或者PAgP协议，服务器端使用NIC teaming技术讲多条链路绑定在一起，STP运行在所有物理链路组成的逻辑链路上。优点是绝大部分交换机都支持这种技术，缺点是所有port channel的组成端口都必须位于同一台交换机上，可能造成单点故障。 StackWise Catalyst低端交换上使用的堆叠技术，可以将两台交换机“合并”为一台进行使用和管理，同一prot channel当中的端口可以位于不同物理交换机上。不需要特殊配置，只需要连线即可。只有一个控制层面(control plane)和管理层面（management plane），主要用于接入层端口扩充，同一逻辑单元最多能够接入9台物理交换机。 VSS Catalyst 4500和6500上使用的技术，但是对于硬件型号和引擎要求较多，并且只能将两台设备“合并”在一起。此外，VSS不只是二层技术，而是将二层和三层全部“合并”。只有一个控制层面（control plane）和管理层面（management plane）。 VPC 适用于Nexus交换机，单纯的二层跨机箱冗余技术，不支持VPN或QoS等三层特性。和StackWise和VSS不同的是，配置了vPC的Nexus依然保持各自的控制层面(control plane)和管理层面（management palne），可以用于构建大二层网络。此外还有vitual Port Channel Plus和Enhanced virtual Port Channel。 VSS和VPC具体对比如下： 序号 VPC VSS 1 Nexus交换机特性 Catalyst 6500，4500交换机特性 2 两台交换机两个控制层面 两台交换机合并成一个逻辑交换机，只有一个控制层面 3 两台交换机两个管理层面 只有一个管理层面 4 需要配置HSRP 不需要配置HSRP 5 支持LACP 支持PAGP和LACP 6 支持L2 PortChannel 支持L2和L3 PortChannel 7 两台交换机都处于active状态并单独工作 两台交换机管理层面和控制层面一主一备 8 Control messages are carried by CFS over Peer Link and a Peer keep alive link is used to check heartbeats and detect dual-active condition Control messages and Data frames flow between active and standby via VSL ","link":"https://eflytop.github.io/post/vss-vs-vpc/"},{"title":"Cisco C9300交换机密码恢复","content":"每个网管都会有忘记交换机密码的那么一次，之前解决办法是思科设备通过修改寄存器（config-register）值来重置密码，对于Cisco Catalyst 9300交换机，密码恢复方法有了少许改变。该教程同样也适于C3850系列。 用Console线连接交换机，并打开Console终端。 拔掉交换机背面的电源线关闭电源。 重新插入电源线，待LED指示灯闪烁后，按下并松开 Mode 按钮 2-3 次，或者在连接电源线的同时一直按住Mode按钮，直到终端命令行显示switch。 输入以下命令忽略启动配置并再次启动。 Switch: SWITCH_IGNORE_STARTUP_CFG=1 Switch: boot 交换机重启完毕后，复制startup-config到 running-config。 Switch# copy startup-config running-config 设定新的交换机密码。 XYZ-Switch# conf t XYZ-Switch(config)# username admin privilege 15 secret Cisco123 XYZ-Switch(config)# enable secret Cisco321 将引导变量移除。 #XYZ-Switch(config)# no system ignore startupconfig switch all 保存新配置并重启然后验证新密码是否有效。 XYZ-Switch# copy running-config startup-config XYZ-Switch#Reload 如果你想恢复出厂设置，交换机启动完毕后清除配置及VLAN数据库即可。 Switch# write erase [Press Enter 2 times] Switch# delete flash:vlan.dat [Press Enter 2 times] ","link":"https://eflytop.github.io/post/Cisco-C9300-Password-Recovery/"},{"title":"思科Firepower 2100 FTD更换ASA镜像","content":"如果您购买的Firepower防火墙是使用的FTD镜像，但是您又十分怀念ASA软件怎么办？您是可以删除FTD镜像并重新安装ASA镜像的。这有点类似于把您笔记本原厂预装的Windows 10换成Linux系统。本文将向您展示其安装步骤。 Step 0 - 设备连接 用Console线连接笔记本USB口和防火墙Console口。 用网线连接笔记本网卡和防火墙管理口Management1/1。 笔记本设置一个192.168.45.0/24网段的IP，比如192.168.45.123/24，网关192.168.45.45。 笔记本上准备好ASA镜像，并启用TFTP软件。 Step 1 - 擦除FTD镜像 从Console口输入账号密码登录FXOS，其默认账号密码为admin/Admin123。然后就是格式化硬盘。 firepower-2110# connect local-mgmt firepower-2110(local-mgmt)# format everything All configuration and bootable images will be lost. Do you still want to format? (yes/no): 输入yes后Firepower 2100会自动重启。 Step 2 - 进入ROMMON模式 当重启后输出提示Use BREAK or ESC to interrupt boot时按Esc键。 Current image running: Boot ROM0 Last reset cause: ResetRequest DIMM_1/1 : Present DIMM_2/1 : Present Platform FPR-2130 with 32768 MBytes of main memory BIOS has been successfully locked !! MAC Address: 0c:75:bd:08:c9:80 Use BREAK or ESC to interrupt boot. Use SPACE to begin boot immediately. 如果没有及时按Esc键，Firepower 2100会尝试启动3次后最终进入ROMMON模式。（因为镜像都被删了，只有ROMMON可用） Step 3 - 通过 TFTP启动FXOS 在ROMMON模式下使用命令行： address 192.168.45.45 : 配置管理口Management1/1地址 netmask 255.255.255.0 ：配置管理口网络掩码 server 192.168.45.123 ：设置TFTP服务器，也就是笔记本的IP地址 gateway 192.168.45.1 ：设置网关，也可以不配置 file cisco-asa-fp2k.9.8.3.8.SPA ：设置TFTP服务器上的ASA镜像包名。FXOS和ASA是同一个软件包。 rommon 1&gt; address 192.168.45.45 rommon 2&gt; netmask 255.255.255.0 rommon 3&gt; server 192.168.45.123 rommon 4&gt; gateway 192.168.45.1 rommon 5&gt; file cisco-asa-fp2k.9.8.3.8.SPA rommon 6&gt; set […] rommon 7&gt; sync rommon 8&gt; tftp -b Enable boot bundle: tftp_reqsize = 268435456 […] link up Receiving cisco-asa-fp2k.9.8.3.8.SPA from 10.70.33.222!!!!!!!! […] set ：显示网络设置。您还可以使用 ping 命令来验证与服务器的连接 sync ：保存网络设置 tftp -b ： 加载 FXOS 加载完毕后Firepower 2100会进入FXOS模式。 Step 4 - 使用U盘将ASA镜像复制至防火墙flash 现在我们只是从TFTP服务器加载了ASA镜像并进入了FXOS系统，ASA镜像并没有上传至Firepower 2100 Flash中。 据网上资料所示，我们使用TFTP、FTP等协议上传ASA镜像到Flash不起作用，只能使用U盘将ASA镜像复制至防火墙Flash。 复制ASA镜像至U盘，插入机箱上的USB接口。(U盘文件系统需为FAT32格式) 从Console口输入账号密码登录FXOS，其默认账号密码为admin/Admin123。 使用如下命令复制： firepower-2110# scope firmware firepower-2110 /firmware # download image usbA:/cisco-asa-fp2k.9.8.3.8.SPA Please use the command 'show download-task' or 'show download-task detail' to check download progress. firepower-2130 /firmware # show download-task Download task: File Name Protocol Server Port Userid State --------- -------- --------------- ---------- --------------- ----- cisco-asa-fp2k.9.8.3.8.SPA Usb A 0 Downloading 复制完毕后进行安装 irepower 2110 /firmware # show package Name Package-Vers --------------------------------------------- ------------ cisco-asa-fp2k.9.8.3.8.SPA 9.8.3.8 firepower 2110 /firmware # scope auto-install firepower-2130 /firmware/auto-install # install security-pack version 9.8.3.8 The system is currently installed with security software package not set, which has: - The platform version: not set If you proceed with the upgrade 9.8.3.8, it will do the following: - upgrade to the new platform version 2.2.2.97 - install with CSP asa version 9.8.3.8 During the upgrade, the system will be reboot Do you want to proceed ? (yes/no):yes This operation upgrades firmware and software on Security Platform Components Here is the checklist of things that are recommended before starting Auto-Install (1) Review current critical/major faults (2) Initiate a configuration backup Do you want to proceed? (yes/no):yes Triggered the install of software package version 9.8.3.8 Install started. This will take several minutes. For monitoring the upgrade progress, please enter 'show' or 'show detail' command. firepower-2130 /firmware/auto-install # show detail Firmware Auto-Install: Package-Vers: 9.8.3.8 Oper State: Scheduled Installation Time: 2021-02-22T22:50:53.775 Upgrade State: Ready Upgrade Status: Validation Software Pack Status: Firmware Upgrade Status: Current Task: 从安装进程可以看到，先是安装的FXOS version 2.2.2.97，然后安装的是ASA version 9.8.3.8。FXOS和ASA两个软件被打包在一起。 使用ASA软件 上个步骤执行完后会自动重启进入FXOS模式。这样我们就可以愉快的使用ASA了。 firepower-2110# connect asa Attaching to Diagnostic CLI ... Press 'Ctrl+a then d' to detach. Type help or '?' for a list of available commands. ciscoasa&gt; enable Password: &lt;blank&gt; ciscoasa# configure terminal ciscoasa(config)# Firepower ASA软件的配置、使用教程请参考我之前的文章： 思科Firepower 2100运行ASA配置指南 ","link":"https://eflytop.github.io/post/cisco-firepower-ftd-to-asa/"},{"title":"思科Firepower 2100运行ASA配置指南","content":"Cisco Firepower系列订购时可以选择FTD或者ASA镜像，由于笔者公司一直用的ASA镜像，为了方便运维和管理，仍然选择了ASA镜像。本文将介绍如何安装、设置和使用基于ASA镜像的Firepower 2100。 Cisco的Firepower本身并不是一个产品，而是一套产品或者组件。在此之前，我们有必要了解一下如下术语： FXOS：Cisco Firepower eXtensible Operating System是用于网络和安全解决方案的下一代系统平台。 是运行在Firepower 2000、4000和9000系列上的底层系统，在 FXOS 之上再运行 ASA 或 FTD 软件。我们可以这样理解：FXOS是“虚拟化管理程序”，ASA和FTD是运行在FXOS之上的“虚拟机”。它提供2种管理方式： - CLI：命令行，用于配置、监控和排障。 - FCM：FXOS Chassis Manager - 基于Web的网页管理端，可以可视化配置和监控。 FTD：Firepower Threat Defense是运行在FXOS上的提供NGFW功能的“虚拟机”。一般通过中央控制器（FMC）管理 ，思科正在拼命推动 FTD 成为 ASA 的继任者。它有2种管理模式： - FMC：Firepower Management Center - FTD的中央控制器，对所有 FTD 实施集中部署管理。 - FDM：Firepower Device Manager - 基于Web的用于管理FTD网页管理端，功能有限，比如创建本地账号都无法实现。 ASA：Adaptive Security Appliance是我们都知道和喜爱的旧版思科防火墙软件，思科希望我们尽快忘记并迁移到FTD平台。我们仍然可以在Firepower系列防火墙FXOS上运行ASA“虚拟机”。它有2种管理模式： - CLI：命令行。 - ASDM：图形化界面软件，远程管理ASA。 使用Console连接至Firepower 2100后我们就直接进入了FXOS CLI模式，我们先要配置FXOS，然后再配置ASA。在FXOS模式下输入命令connect asa进入ASA模式，在ASA模式下输入connect fxos进入FXOS模式。默认FXOS用户名为admin，密码为Admin123。 配置FXOS 修改FXOS主机名 firepower-2110# scop system firepower-2110 /system # set name et-fp2110 firepower-2110 /system* # commit-buffer firepower-2110 /system # top et-fp2110# 设置domain name et-fp2110# scope system et-fp2110 /system # scope service et-fp2110 /system/services # set domain-name ex.eflytop.com et-fp2110 /system/services* # commit-buffer et-fp2110 /system/services # show domain-name Domain: ex.eflytop.com 配置时间和NTP服务器 有些服务比如NTP需要再FXOS里面配置，ASA里面不再提供相关命令，从FXOS同步时间。 et-fp2110# scope system et-fp2110 /system # scope services et-fp2110 /system/services # set clock Aug 18 2021 05 29 30 et-fp2110 /system/services # set timezone et-fp2110 /system/services* # enter ntp-server 10.16.16.16 et-fp2110 /system/services/ntp-server* # commit-buffer et-fp2110 /system/services/ntp-server # exit et-fp2110 /system/services # show ntp-server et-fp2110 /system/services # show clock 配置DNS et-fp2110# scope system et-fp2110 /system* # scope services et-fp2110 /system/services *# create dns 8.8.8.8 0 et-fp2110 /system/services *# commit-buffer 配置带外管理/管理接口 根据上图可以看到FXOS默认的管理接口IP为192.168.45.45，并启用了DHCP为接入管理接口的PC分配同网段的IP便于管理，现实环境中我们一般有专用的管理网段，需要修改管理接口IP、DHCP设定和允许接入网段。 关闭DHCP服务： et-fp2110# scope system et-fp2110 /system # scope services et-fp2110 /system/services # disable dhcp-server 配置新的管理IP： et-fp2110*# scope fabric-interconnect a et-fp2110 /fabric-interconnect* # set out-of-band static ip 10.70.128.32 netmask 255.255.240.0 gw 10.70.128.1 配置允许访问管理口网段： et-fp2110 /system/services # enter ip-block 10.0.0.0 8 https et-fp2110 /system/services* # enter ip-block 10.0.0.0 8 ssh et-fp2110 /system/services # delete ip-block 192.168.45.0 24 https et-fp2110 /system/services* # delete ip-block 192.168.45.0 24 ssh et-fp2110 /system/services* # commit-buffer 设置接口 先看一看目前的接口配置 et-fp2110# scope eth-uplink et-fp2110 /eth-uplink # scope fabric a et-fp2110 /eth-uplink/fabric # show interface Interface: Port Name Port Type Admin State Oper State State Reason -------------- ------------------ ----------- ---------------- ------------ Ethernet1/1 Data Enabled Up Up Ethernet1/2 Data Enabled Up Up Ethernet1/3 Data Disabled Link Down Down Ethernet1/4 Data Disabled Link Down Down Ethernet1/5 Data Disabled Link Down Down Ethernet1/6 Data Disabled Link Down Down Ethernet1/7 Data Disabled Link Down Down 你会看到除了接口1和2外，其余接口都是disabled。必须要在FXOS里enable对应的接口，才能在ASA中正常使用，不然在ASA中no shutdown此接口但接口状态还是down的。命令如下： et-fp2110# scope eth-uplink et-fp2110 /eth-uplink # scope fabric a et-fp2110 /eth-uplink/fabric # enter interface Ethernet1/8 et-fp2110 /eth-uplink/fabric/interface # enable et-fp2110 /eth-uplink/fabric/interface * # commit-buffer 配置FXOS管理账号 et-fp2110# scope security et-fp2110 /security # create local-user aerynsun et-fp2110 /security/local-user* # set password Enter a password: Confirm the password: et-fp2110 /security/local-user* # enter role admin et-fp2110 /security # enter local-user admin et-fp2110 /security/local-user # set password Enter a password: Confirm the password: et-fp2110 /security/local-user* # commit-buffer 配置ASA 从FXOS切换到ASA et-fp2110# connect asa Remote card closed command session. Press any key to continue. Connection with fxos terminated. Type help or '?' for a list of available commands. ciscoasa&gt; enable Password: &lt;blank&gt; ciscoasa# configure terminal ciscoasa(config)# 从ASA切换到FXOS的命令为 ciscoasa# connect fxos 配置管理口 FXOS和ASA共用管理口Management1/1，但是需要为它们配置不同IP地址。 ciscoasa(config)# interface management1/1 ciscoasa(config-if)# ip address 10.70.128.33 255.255.240.0 ciscoasa(config)# route management 0.0.0.0 0.0.0.0 10.70.128.1 其它配置 配置路由、策略、NAT、VPN等，这跟我们以前配置ASA的命令没有区别，这里不单独介绍。 ","link":"https://eflytop.github.io/post/firepower-2100-asa-installation/"},{"title":"Elastic Stack之安全认证","content":"安装完Elastic Stack打开Kibana网页端没有账号认证就能直接访问。之前的做法是使用Apache的密码认证进行安全配置，然后通过访问Nginx转发kibana服务器地址。从 7.1.0 版本开始， Elastic Stack安全功能可以实现账号认证。用户能够对网络流量进行加密、创建和管理用户、定义能够保护索引和集群级别访问权限的角色， Kibana 提供访问保护。 配置Elasticsearch 在 Elasticsearch 主节点上配置 TLS 首先关闭相关进程以免造成异常 [root@cncs ~]# systemctl stop elasticsearch 生成自签名证书 在 Elasticsearch 主节点生成证书，文件名为elastic-stack-ca.p12。 [root@cncs ~]# cd /usr/share/elasticsearch #生成CA，包含CA私钥和证书,默认名称elastic-stack-ca.p12 [root@cncs elasticsearch]# bin/elasticsearch-certutil ca #敲2次回车 #颁发一个实例证书,默认名称elastic-certificates.p12 [root@cncs elasticsearch]# bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 #敲3次回车 拷贝证书到Elasticsearch配置目录 [root@cncs ~]# mkdir /etc/elasticsearch/certs [root@cncs ~]# cp /usr/share/elasticsearch/elastic-certificates.p12 /etc/elasticsearch/certs [root@cncs ~]# chown -R elasticsearch:elasticsearch /etc/elasticsearch/certs 如有多个Elasticsearch节点，每个节点复制一份。 开启Elasticsearch Security特性 Security特性默认是被禁用的，打开文件 config/elasticsearch.yaml。将下列代码行粘贴到文件末尾，开启Elasticsearch Security特性，加密内部通信流量与http流量。 [root@cncs ~]# vim /etc/elasticsearch/elasticsearch.yml xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12 如有多个Elasticsearch节点，每个节点都需配置。 为内置用户创建密码 启动 Elasticsearch [root@cncs ~]# systemctl start elasticsearch Elasticsearch默认的内置用户有kibana_system、kibana、elastic、beats_system等。 kibana_system用户用于Kibana连接Elasticsearch认证 kibana用户用于Elasticsearch集群认证 beats_system用户用于beats连接Elasticsearch认证 elastic用户用于Kibana网页端登录认证 通过运行 elasticsearch-setup-passwords 命令为内置用户设置密码。auto参数是自动生成随机密码，也可以通过 interactive 参数手动定义密码。请记录这些密码，非常重要。 [root@cncs ~]# cd /usr/share/elasticsearch [root@cncs elasticsearch]# bin/elasticsearch-setup-passwords auto Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user. The passwords will be randomly generated and printed to the console. Please confirm that you would like to continue [y/N]y Changed password for user apm_system PASSWORD apm_system = UymyZjBfqSS743TwTgpe Changed password for user kibana_system PASSWORD kibana_system = lwjCX1ho1oOMGf30bbJW Changed password for user kibana PASSWORD kibana = lwjCX1ho1oOMGf30bbJW Changed password for user logstash_system PASSWORD logstash_system = 6RYXgJw9V6LBnT53Qgzt Changed password for user beats_system PASSWORD beats_system = FiwFQBTuJsumTnWslM2f Changed password for user remote_monitoring_user PASSWORD remote_monitoring_user = oU73njEE3ynCThCT2NwZ Changed password for user elastic PASSWORD elastic = QA4xUfjBwnfjI6u73Af2 配置Kibana 配置Kibana连接Elasticsearch的账号 上文生成了kibana_system这个账号密码，现在给Kibana配置上这个账号使Kibana能够连接Elasticsearch。 [root@cncs ~]# vi /etc/kibana/kibana.yml elasticsearch.username: &quot;kibana_system&quot; elasticsearch.password: &quot;lwjCX1ho1oOMGf30bbJW&quot; 现在可以使用elastic这个账号访问网页端http://10.18.224.112:5601/了。 配置Filebeat 配置Filebeat连接Elasticsearch的账号 这里用的是elastic这个账号密码 [root@localhost ~]# vi /etc/filebeat/filebeat.yml output.elasticsearch: # Array of hosts to connect to. hosts: [&quot;10.18.224.112:9200&quot;] username: &quot;elastic&quot; password: &quot;QA4xUfjBwnfjI6u73Af2&quot; ","link":"https://eflytop.github.io/post/elk-enable-secure/"},{"title":"Elastic Stack收集NetFlow或sFlow数据","content":"NetFlow是一种数据交换方式。Netflow提供网络流量的会话级视图，记录下每个TCP/IP事务的信息。当汇集起来时，它更加易于管理和易读。Netflow由Cisco创造。 同NetFlow一样，sFlow是一种向采集器发送报告的推送技术。所不同的是，NetFlow是一种基于软件的技术，而sFlow则采用内置在硬件中的专用芯片。这种做法消除了路由器或交换机的CPU和内存的负担。 Flow名称 代表厂商 主要版本 备注 NetFlow Cisco V1、V5、V7、V8、V9 应用最广 sFlow Foundry、HP、Alcatel、NEC、Extreme等 V4、V5 实时性较强，具备突出的第二~七层信息描述能力 NetStream 华为 V5、V8、V9 与NetFlow较为类似 IPFIX IETF标准规范 RFC 3917 以NetFlow V9为蓝本 CFlowd Juniper V5、V8 厂商跟进力度不高 本文使用ELK协议栈中Filebeat内置的netflow.yml模块，以思科路由器为例，把flow输出到Elasticsearch，并在Kibana中查阅。 安装Filebeat [root@cncs ~]# yum install filebeat -y 配置开机自启动和开启服务 [root@cncs ~]# systemctl enable filebeat [root@cncs ~]# systemctl start filebeat 修改Filebeat总体配置 指定Elasticsearch和Kibana参数 [root@cncs ~]# vim /etc/filebeat/filebeat.yml setup.kibana: host: &quot;10.18.224.112:5601&quot; output.elasticsearch: hosts: [&quot;10.18.224.112:9200&quot;] # 自定义索引 indices: - index: &quot;filebeat-netflow_%{+yyyy.MM.dd}&quot; when.equals: event.module: &quot;netflow&quot; 启用netflow模块 [root@cncs ~]# filebeat modules enable netflow Enabled netflow [root@cncs ~]# filebeat modules list Enabled: netflow Disabled: activemq ...... 修改netlfow模块的配置 netflow模块配置文件netflow.yml位于/etc/Filebeat/modules.d/目录下 [root@cncs ~]# vim /etc/filebeat/modules.d/netflow.yml - module: netflow log: enabled: true var: netflow_host: 0.0.0.0 netflow_port: 9996 指定思科netflow输出端口udp/9996 可以用test命令测试配置有没有问题 [root@cncs ~]# filebeat test config Config OK 防火墙开放 [root@cncs ~]# firewall-cmd --permanent --add-port=9996/udp [root@cncs ~]# firewall-cmd --reload [root@cncs ~]# firewall-cmd --list-all 使用setup命令加载Kibana dashboards [root@cncs ~]# filebeat setup Overwriting ILM policy is disabled. Set `setup.ilm.overwrite: true` for enabling. Index setup finished. Loading dashboards (Kibana must be running and reachable) Loaded dashboards Setting up ML using setup --machine-learning is going to be removed in 8.0.0. Please use the ML app instead. See more: https://www.elastic.co/guide/en/machine-learning/current/index.html Loaded machine learning job configurations Loaded Ingest pipelines [root@cncs ~]# service filebeat restart Restarting filebeat (via systemctl): [ OK ] Kibana网页端初步设置 ","link":"https://eflytop.github.io/post/elk-netflow/"},{"title":"Elastic Stack收集思科设备log日志","content":"上一篇文章介绍了如何安装ELK协议栈，其中Filebeat可以从input读取日志信息，经过相应解析和处理之后，从output输出到目标存储库。输入可以从Log、Syslog、Stdin、Redis、UDP、Docker、TCP、NetFlow输入，然后可以输出到Elasticsearch、Logstash、Kafka、Redis、File、Console、Cloud。 Filebeat支持的module： 本文使用Filebeat内置的cisco.yml模块，以思科ASA防火墙为例，把log输出到Elasticsearch，并在Kibana中查阅。 安装Filebeat [root@cncs ~]# yum install filebeat -y 配置开机自启动和开启服务 [root@cncs ~]# systemctl enable filebeat [root@cncs ~]# systemctl start filebeat 修改Filebeat总体配置 指定Elasticsearch和Kibana参数 [root@cncs ~]# vi /etc/filebeat/filebeat.yml setup.kibana: host: &quot;10.18.224.112:5601&quot; output.elasticsearch: hosts: [&quot;10.18.224.112:9200&quot;] # 自定义索引 indices: - index: &quot;filebeat-asa_%{+yyyy.MM.dd}&quot; when.equals: fileset.name: &quot;asa&quot; - index: &quot;filebeat-ios_%{+yyyy.MM.dd}&quot; when.equals: fileset.name: &quot;ios&quot; 启用cisco模块 [root@cncs ~]# filebeat modules enable cisco Enabled cisco [root@cncs ~]# filebeat modules list Enabled: cisco Disabled: activemq apache auditd ...... 修改cisco模块的配置 该模块支持asa、ftd、ios、nexus、meraki、umbrella、amp等思科设备，这里以asa防火墙为例： [root@cncs ~]# vi /etc/filebeat/modules.d/cisco.yml - module: cisco asa: enabled: true var.syslog_host: 0.0.0.0 var.syslog_port: 514 指定思科asa日志输出端口udp/514 防火墙开放 [root@cncs ~]# firewall-cmd --permanent --add-port=514/udp [root@cncs ~]# firewall-cmd --reload 使用setup命令加载Kibana dashboards [root@cncs ~]# filebeat setup Overwriting ILM policy is disabled. Set `setup.ilm.overwrite: true` for enabling. Index setup finished. Loading dashboards (Kibana must be running and reachable) Loaded dashboards Setting up ML using setup --machine-learning is going to be removed in 8.0.0. Please use the ML app instead. See more: https://www.elastic.co/guide/en/machine-learning/current/index.html Loaded machine learning job configurations Loaded Ingest pipelines [root@cncs filebeat]# service filebeat restart Restarting filebeat (via systemctl): [ OK ] Kibana网页端初步设置 Kibana强大的数据展示和分析功能需要自己慢慢挖掘了。 ","link":"https://eflytop.github.io/post/elk-cisco-log/"},{"title":"Elastic Stack的安装和搭建","content":"ELK其实并不是一款软件，而是一整套解决方案，是三个软件产品的首字母缩写，Elasticsearch，Logstash 和 Kibana。这三款软件都是开源软件，通常是配合使用，而且又先后归于 Elastic.co 公司名下，故被简称为ELK协议栈。 Elasticsearch是一个实时的分布式搜索和分析引擎，它可以用于全文搜索，结构化搜索以及分析。提供搜集、分析、存储数据三大功能。 Kibana可以为Elasticsearch提供分析和可视化的 Web 平台。它可以在Elasticsearch的索引中查找，交互数据，并生成各种维度的表图，可以帮助汇总、分析和搜索重要数据日志。 Logstash 主要是用来日志的搜集、分析、过滤日志的工具，支持大量的数据获取方式。负责将收到的各节点日志进行过滤、修改等操作在一并发往Elasticsearch上去。 Beats是ELK 协议栈的新成员，集合了多种单一用途轻量级开源数据搜集器，基于Logstash-Forwarder源代码开发，是对它的替代。Beats采集日志后发送到Logstash进行解析，亦可直接发送到 Elasticsearch进行集中式存储和分析。Beats包含多种搜集器，常用的有： Packetbeat（搜集网络流量数据） Topbeat（搜集系统、进程和文件系统级别的 CPU 和内存使用情况等数据） Filebeat（搜集文件数据） Winlogbeat（搜集 Windows 事件日志数据） 本文的教程采用Filebeat作为数据搜集器，且和Elasticsearch、Kibana安装在同一台服务器上，IP地址为10.18.224.112。 安装Java 查看yum库中的java安装包 [root@cncs ~]#yum -y list java* 安装最新版本java [root@cncs ~]#yum -y install java-1.8.0-openjdk* 查看Java版本 [root@cncs ~]#java -version 配置limit相关参数 [root@cncs ~]#vi /etc/security/limits.conf #添加 * soft nproc 65536 * hard nproc 65536 * soft nofile 65536 * hard nofile 65536 [root@cncs ~]# cat /etc/security/limits.conf | grep -v &quot;^#&quot; | grep -v &quot;^$&quot; * soft nproc 65536 * hard nproc 65536 * soft nofile 65536 * hard nofile 65536 修改虚拟内存交换区的大小 [root@cncs ~]#vi /etc/sysctl.conf #添加 vm.max_map_count=262144 [root@cncs ~]# sysctl -p vm.max_map_count = 262144 安装Elasticsearch 配置Elasticsearch 的yum源 [root@cncs ~]# vi /etc/yum.repos.d/elasticsearch.repo [elasticsearch-7.x] name=Elasticsearch repository for 7.x packages baseurl=https://artifacts.elastic.co/packages/7.x/yum gpgcheck=1 gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch enabled=1 autorefresh=1 type=rpm-md 引入GPG key [root@cncs ~]#rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch 安装Elasticsearch [root@cncs ~]# yum -y install elasticsearch 修改配置文件 [root@cncs ~]# vi /etc/elasticsearch/elasticsearch.yml cluster.name: cncs_cluster_us node.name: node-1 network.host: 0.0.0.0 http.port: 9200 discovery.seed_hosts: [&quot;10.18.224.112&quot;] cluster.initial_master_nodes: [&quot;node-1&quot;] [root@cncs ~]# cat /etc/elasticsearch/elasticsearch.yml | grep -v '^#' cluster.name: cncs_cluster_us node.name: node-1 network.host: 0.0.0.0 http.port: 9200 discovery.seed_hosts: [&quot;10.18.224.112&quot;] cluster.initial_master_nodes: [&quot;node-1&quot;] path.data: /var/lib/elasticsearch path.logs: /var/log/elasticsearch 数据目录：/var/lib/elasticsearch 日志目录：/var/log/elasticsearch 配置开机自启动和开启服务 [root@cncs ~]# systemctl enable elasticsearch.service [root@cncs ~]# systemctl start elasticsearch.service 防火墙权限 [root@cncs ~]# firewall-cmd --permanent --add-port 9200/tcp [root@cncs ~]# firewall-cmd --reload 验证服务是否启动 [root@cncs ~]# netstat -lptnu | grep java tcp6 0 0 :::9200 :::* LISTEN 31390/java tcp6 0 0 :::9300 :::* LISTEN 31390/java 9200作为Http协议，主要用于外部通讯 9300作为Tcp协议，ES集群之间是通过9300进行通讯 [root@cncs ~]# curl -X GET http://10.18.224.112:9200 { &quot;name&quot; : &quot;node-1&quot;, &quot;cluster_name&quot; : &quot;cncs_cluster_us&quot;, &quot;cluster_uuid&quot; : &quot;3NUlLjGHTmuSXBXPtfZ3-w&quot;, &quot;version&quot; : { &quot;number&quot; : &quot;7.13.4&quot;, &quot;build_flavor&quot; : &quot;default&quot;, &quot;build_type&quot; : &quot;rpm&quot;, &quot;build_hash&quot; : &quot;c5f60e894ca0c61cdbae4f5a686d9f08bcefc942&quot;, &quot;build_date&quot; : &quot;2021-07-14T18:33:36.673943207Z&quot;, &quot;build_snapshot&quot; : false, &quot;lucene_version&quot; : &quot;8.8.2&quot;, &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;, &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot; }, &quot;tagline&quot; : &quot;You Know, for Search&quot; } 安装Filebeat yum安装Filebeat [root@cncs ~]# yum install filebeat -y 配置开机自启动和开启服务 [root@cncs filebeat]# systemctl enable filebeat [root@cncs filebeat]# systemctl start filebeat Filebeat从input读取日志信息，经过相应解析和处理之后，从output输出到目标存储库。输入可以从Log、Syslog、Stdin、Redis、UDP、Docker、TCP、NetFlow输入，然后可以输出到Elasticsearch、Logstash、Kafka、Redis、File、Console、Cloud。 Filebeat的配置文件：/etc/filebeat/filebeat.yml Filebeat支持的module： [root@cncs ~]# cd /etc/filebeat/modules.d/ [root@cncs modules.d]# ls activemq.yml.disabled cyberark.yml.disabled imperva.yml.disabled netflow.yml.disabled santa.yml.disabled apache.yml.disabled cylance.yml.disabled infoblox.yml.disabled netscout.yml.disabled snort.yml.disabled auditd.yml.disabled elasticsearch.yml.disabled iptables.yml.disabled nginx.yml.disabled snyk.yml.disabled awsfargate.yml.disabled envoyproxy.yml.disabled juniper.yml.disabled o365.yml.disabled sonicwall.yml.disabled aws.yml.disabled f5.yml.disabled kafka.yml.disabled okta.yml.disabled sophos.yml.disabled azure.yml.disabled fortinet.yml.disabled kibana.yml.disabled oracle.yml.disabled squid.yml.disabled barracuda.yml.disabled gcp.yml.disabled logstash.yml.disabled osquery.yml.disabled suricata.yml.disabled bluecoat.yml.disabled googlecloud.yml.disabled microsoft.yml.disabled panw.yml.disabled system.yml.disabled cef.yml.disabled google_workspace.yml.disabled misp.yml.disabled pensando.yml.disabled threatintel.yml.disabled checkpoint.yml.disabled gsuite.yml.disabled mongodb.yml.disabled postgresql.yml.disabled tomcat.yml.disabled cisco.yml haproxy.yml.disabled mssql.yml.disabled proofpoint.yml.disabled traefik.yml.disabled coredns.yml.disabled ibmmq.yml.disabled mysqlenterprise.yml.disabled rabbitmq.yml.disabled zeek.yml.disabled crowdstrike.yml.disabled icinga.yml.disabled mysql.yml.disabled radware.yml.disabled zoom.yml.disabled cyberarkpas.yml.disabled iis.yml.disabled nats.yml.disabled redis.yml.disabled zscaler.yml.disabled 后文将介绍使用cisco和netflow这两个模块。 安装Kibana yum源安装 [root@cncs ~]# yum install kibana -y 配置Kibana [root@cncs ~]# vi /etc/kibana/kibana.yml [root@cncs ~]# cat /etc/kibana/kibana.yml |grep -v &quot;^#&quot; |grep -v &quot;^$&quot; server.port: 5601 server.host: &quot;0.0.0.0&quot; elasticsearch.hosts: [&quot;http://10.18.224.112:9200&quot;] 防火墙开放 [root@cncs ~]# firewall-cmd --permanent --add-port=5601/tcp [root@cncs ~]# firewall-cmd --reload 配置开机自启动和启动Kibana服务 [root@cncs ~]# systemctl enable kibana [root@cncs ~]# systemctl start kibana 浏览器访问 打开浏览器访问http://10.18.224.112:5601 本文到此完毕，下一篇文章介绍如何配置收集思科设备日志。 ","link":"https://eflytop.github.io/post/elk-installation/"},{"title":"使用Python批量配置思科路由器","content":"分享一个使用Python批量配置思科路由器代码，把cfg.py、device.txt、cmd.txt放同一目录下，device.txt是要登录的主机列表，一行一个IP地址；cmd.txt是命令列表，一行一条命令，不需要输入configure terminal和write命令。 代码如下： 单线程版： #!/usr/bin/env python3 # -*- coding=utf-8 -*- # by EFLYTOP # www.eflytop.com from netmiko import ConnectHandler,NetmikoTimeoutException,NetmikoAuthenticationException import time import getpass import sys username = input(&quot;请输入设备用户名：&quot;) password = getpass.getpass(prompt='请输入密码:') #enpass = getpass.getpass(prompt='请输入enable密码:') failed_login_ip = [] devices = open('device.txt','r') ip_list = [x.strip() for x in devices.readlines()] devices.close() commands = open('cmd.txt','r') cmd_list = [y.strip() for y in commands.readlines()] commands.close() start_time = time.time() #print输出到txt文件 class Logger(object): def __init__(self, filename=&quot;Default.log&quot;): self.terminal = sys.stdout self.log = open(filename, &quot;a&quot;) def write(self, message): self.terminal.write(message) self.log.write(message) def flush(self): pass sys.stdout = Logger('log.txt') for ipaddr in ip_list: device_info = { 'device_type': 'cisco_ios', 'ip': ipaddr, 'username': username, 'password': password, #'port': 22, #'secret': enpass, } try: host_conn = ConnectHandler(**device_info) print('INFO: ',time.strftime('%x %X'),ipaddr,'正在连接...') output = host_conn.send_config_set(cmd_list) save_cfg = host_conn.save_config() print(output) print(save_cfg) except NetmikoAuthenticationException : #认证失败报错记录 print('INFO: ',time.strftime('%x %X'),ipaddr,'[Error 1] Authentication failed.') failed_login_ip.append(ipaddr) except NetmikoTimeoutException : #登录超时报错记录 print('INFO: ',time.strftime('%x %X'),ipaddr,'[Error 2] Connection timed out.') failed_login_ip.append(ipaddr) except : #未知报错记录 print('INFO: ',time.strftime('%x %X'),ipaddr,'[Error 3] Unknown error.') failed_login_ip.append(ipaddr) print('下列主机登录失败，请手动检查：') for i in failed_login_ip: print(i) print('本次执行时长：%.2f'%(time.time()-start_time) + '秒') print(&quot;命令执行完毕，结果请查看log.txt文件&quot;) 多线程版： #!/usr/bin/env python3 # -*- coding=utf-8 -*- # by EFLYTOP # www.eflytop.com from netmiko import ConnectHandler,NetmikoTimeoutException,NetmikoAuthenticationException import time import getpass import sys username = input(&quot;请输入设备用户名：&quot;) password = getpass.getpass(prompt='请输入密码:') #enpass = getpass.getpass(prompt='请输入enable密码:') failed_login_ip = [] devices = open('device.txt','r') ip_list = [x.strip() for x in devices.readlines()] devices.close() commands = open('cmd.txt','r') cmd_list = [y.strip() for y in commands.readlines()] commands.close() start_time = time.time() #print输出到txt文件 class Logger(object): def __init__(self, filename=&quot;Default.log&quot;): self.terminal = sys.stdout self.log = open(filename, &quot;a&quot;) def write(self, message): self.terminal.write(message) self.log.write(message) def flush(self): pass sys.stdout = Logger('log.txt') for ipaddr in ip_list: device_info = { 'device_type': 'cisco_ios', 'ip': ipaddr, 'username': username, 'password': password, #'port': 22, #'secret': enpass, } try: host_conn = ConnectHandler(**device_info) print('INFO: ',time.strftime('%x %X'),ipaddr,'正在连接...') output = host_conn.send_config_set(cmd_list) save_cfg = host_conn.save_config() print(output) print(save_cfg) except NetmikoAuthenticationException : #认证失败报错记录 print('INFO: ',time.strftime('%x %X'),ipaddr,'[Error 1] Authentication failed.') failed_login_ip.append(ipaddr) except NetmikoTimeoutException : #登录超时报错记录 print('INFO: ',time.strftime('%x %X'),ipaddr,'[Error 2] Connection timed out.') failed_login_ip.append(ipaddr) except : #未知报错记录 print('INFO: ',time.strftime('%x %X'),ipaddr,'[Error 3] Unknown error.') failed_login_ip.append(ipaddr) print('下列主机登录失败，请手动检查：') for i in failed_login_ip: print(i) print('本次执行时长：%.2f'%(time.time()-start_time) + '秒') print(&quot;命令执行完毕，结果请查看log.txt文件&quot;) ","link":"https://eflytop.github.io/post/python-cisco-cfg/"},{"title":"如何使用Python自动采集路由器信息","content":"还有一小时就要下班了，老板突然指示马上收集一下所有设备的IP，软件版本，序列号信息，一台一台登录肯定得加班了，要不用Python自动采集吧。 环境 Python 3.9 Python模块 Netmiko - ssh登录路由器模块 Getpass - 非明文输入密码 TextFSM - 把无规律的文本内容整理成有序的数据格式 ntc-templates - 用TextFSM开发的用于网络设备的模板集，包括Cisco、Avaya、Huawei等 openpyxl - 把查询结果输出到EXCEL concurrent.futures - 并发模块 代码 #!/usr/bin/env python3 # -*- coding=utf-8 -*- # by EFLYTOP # www.eflytop.com from netmiko import ConnectHandler,NetmikoTimeoutException,NetmikoAuthenticationException from openpyxl import Workbook from openpyxl.styles import PatternFill, Border, Side from pprint import pprint from concurrent.futures import ThreadPoolExecutor import getpass import sys import time print('请把要执行的IP清单保存至device.txt文件') username = input(&quot;请输入设备用户名：&quot;) password = getpass.getpass(prompt='请输入密码:') #enpass = getpass.getpass(prompt='请输入enable密码:') succeed_ip_list = [] failed_login_ip_list = [] hostname_list = [] sn_list = [] uptime_list = [] model_list = [] os_version_list = [] image_list = [] wb = Workbook() ws = wb.active ws.title = 'Inventory' ws['A1'] = 'Hostname' ws['B1'] = 'IP Address' ws['C1'] = 'Serial Number' ws['D1'] = 'Uptime' ws['E1'] = 'Model' ws['F1'] = 'OS Version' ws['G1'] = 'Image' yellowFill = PatternFill(start_color='FFFF00', end_color='FFFF00', fill_type='solid') thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin')) ws['A1'].fill=yellowFill ws['B1'].fill=yellowFill ws['C1'].fill=yellowFill ws['D1'].fill=yellowFill ws['E1'].fill=yellowFill ws['F1'].fill=yellowFill ws['G1'].fill=yellowFill file_time = time.strftime(&quot;%Y-%m-%d_%H_%M_%S&quot;, time.localtime()) #print输出到txt文件 class Logger(object): def __init__(self, filename=&quot;Default.log&quot;): self.terminal = sys.stdout self.log = open(filename, &quot;a&quot;) def write(self, message): self.terminal.write(message) self.log.write(message) def flush(self): pass sys.stdout = Logger('log_' + file_time + '.log') start_time = time.time() def get_ip_address(): with open('device.txt') as f: addresses = f.read().splitlines() return addresses def retrieve_data(ipaddr): connection_info = { 'device_type': 'cisco_ios', 'ip': ipaddr, 'username': username, 'password': password, #'port': 22, #'secret': enpass, } try: with ConnectHandler(**connection_info) as conn: #conn.enable() print('INFO: ',time.strftime('%x %X'),'已经登录设备：', ipaddr) output = conn.send_command('show version', use_textfsm=True) succeed_ip_list.append(ipaddr) hostname = conn.find_prompt().replace('#','') hostname_list.append(hostname) sn = output[0]['serial'][0] sn_list.append(sn) uptime = output[0]['uptime'] uptime_list.append(uptime) model = output[0]['hardware'][0] model_list.append(model) os_version = output[0]['version'] os_version_list.append(os_version) image = output[0]['running_image'] image_list.append(image) except NetmikoAuthenticationException : #认证失败报错记录 print('INFO: ',time.strftime('%x %X'),ipaddr,'[Error 1] Authentication failed.') failed_login_ip_list.append(ipaddr) except NetmikoTimeoutException : #登录超时报错记录 print('INFO: ',time.strftime('%x %X'),ipaddr,'[Error 2] Connection timed out.') failed_login_ip_list.append(ipaddr) except Exception as e: print('INFO: ',time.strftime('%x %X'),ipaddr,e) failed_login_ip_list.append(ipaddr) with ThreadPoolExecutor(max_workers=5) as exe: ip_addresses = get_ip_address() results = exe.map(retrieve_data, ip_addresses) row_top_number = len(succeed_ip_list) + 2 for hostname, ip, sn, uptime, model, os_version, image, row in zip(hostname_list, succeed_ip_list, sn_list, uptime_list, model_list, os_version_list, image_list, range(2, row_top_number)): ws.cell(row=row, column=1, value=hostname) ws.cell(row=row, column=2, value=ip) ws.cell(row=row, column=3, value=sn) ws.cell(row=row, column=4, value=uptime) ws.cell(row=row, column=5, value=model) ws.cell(row=row, column=6, value=os_version) ws.cell(row=row, column=7, value=image) dims = {} for row in ws.rows: for cell in row: cell.border=thin_border if cell.value: dims[cell.column_letter] = max((dims.get(cell.column, 0), len(str(cell.value)))) for col, value in dims.items(): ws.column_dimensions[col].width = value + 5 wb.save('inventory_' + file_time +'.xlsx') print('下列主机登录失败，请手动检查：') for i in failed_login_ip_list: print(i) #print(succeed_ip_list) #print(hostname_list) #print(model_list) print('本次执行时长：%.2f'%(time.time()-start_time) + '秒') print(&quot;命令执行完毕，执行日志请查看&quot; + 'log_' + file_time + '.log') print('执行结果请查看' + 'inventory_' + file_time +'.xlsx') 输出结果 ","link":"https://eflytop.github.io/post/cisco-python-show/"},{"title":"Cisco ISR4000路由器从3.x升级至Denali 16.2指南","content":"在管理和升级ISR4000系列路由器时，我们发现IOS XE版本有3.x的，也有Denali 16.x的。我们可以将3.x版本升级到16.x版本，已实现生成环境的稳定性。在本文中，我们将向您展示如何将ISR4000从IOS XE 3.6升级到Denali 16.2.1。 您需要知道的事 路由器的最低ROMMON版本必须为16.2（1r） 以下过程只适合于ISR4000。ASR1000和CSR的过程可能略有不同 先决条件 从cisco.com下载ISR4000 ROMMON（除非您的路由器已经满足16.2（1r）或更高版本的要求） 从cisco.com下载ISR4000软件Denali 16.x IOS XE 步骤1：验证当前ROMMON版本 在这里，我们运行的15.4（3r）S3，早于16.2（1r），因此需要升级 ISR4321#show rom-monitor r0 System Bootstrap, Version 15.4(3r)S3, RELEASE SOFTWARE Copyright (c) 1994-2014 by cisco Systems, Inc. ISR4321#sh platform Chassis type: ISR4321/K9 Slot Type State Insert time (ago) --------- ------------------- --------------------- ----------------- 0 ISR4321/K9 ok 01:26:51 0/0 ISR4321-2x1GE ok 01:25:41 R0 ISR4321/K9 ok, active 01:26:51 F0 ISR4321/K9 ok, active 01:26:51 P0 PWR-4320-AC ok 01:26:34 P2 ACS-4320-FANASSY ok 01:26:34 Slot CPLD Version Firmware Version --------- ------------------- --------------------------------------- 0 15030325 15.4(3r)S3 R0 15030325 15.4(3r)S3 F0 15030325 15.4(3r)S3 步骤2：将新的ROMMON文件和Denali 16.x软件复制到路由器flash ISR4321#copy ftp://&lt;username&gt;:&lt;password&gt;@&lt;IP Address&gt;/isr4300-rommon.162-1r.pkg flash: Destination filename [isr4300-rommon.162-1r.pkg]? Accessing ftp://*:*@172.16.32.40/isr4300-rommon.162-1r.pkg... Loading isr4300-rommon.162-1r.pkg !!!!!!!!!!! [OK - 2646988/4096 bytes] 2646988 bytes copied in 1.295 secs (2044006 bytes/sec) ISR4321#copy ftp://&lt;username&gt;:&lt;password&gt;@&lt;IP Address&gt;/isr4300-universalk9.16.02.01.SPA.bin flash: Destination filename [isr4300-universalk9.16.02.01.SPA.bin]? Accessing ftp://*:*@172.16.32.40/isr4300-universalk9.16.02.01.SPA.bin... Loading isr4300-universalk9.16.02.01.SPA.bin !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! [OK - 497494797/4096 bytes] 497494797 bytes copied in 199.583 secs (2492671 bytes/sec) 步骤3：验证文件是否上传成功，并校验MD5 ISR4321#dir bootflash: | in isr 17 -rw- 2646988 Apr 2 2016 11:00:47 -07:00 isr4300-rommon.162-1r.pkg 18 -rw- 497494797 Apr 2 2016 10:54:31 -07:00 isr4300-universalk9.16.02.01.SPA.bin ISR4321#verify /md5 flash:isr4300-rommon.162-1r.pkg .........................................Done! verify /md5 (bootflash:isr4300-rommon.162-1r.pkg) = 2afd598e38c5420162762ec80b285f14 步骤4：进行ROMMON升级 这个过程大概需要5分钟，之后需要重新启动路由器 ISR4321#upgrade rom-monitor filename bootflash:isr4300-rommon.162-1r.pkg all Chassis model ISR4321/K9 has a single rom-monitor. Upgrade rom-monitor Target copying rom-monitor image file selected : 0 Booted : 0 Reset Reason: 0 Info: Upgrading entire flash from the rommon package 4259840+0 records in 4259840+0 records out 262144+0 records in 262144+0 records out 655360+0 records in 655360+0 records out 4194304+0 records in 4194304+0 records out File is a FIPS ROMMON image FIPS-140-3 Load Test on has PASSED. Authenticity of the image has been verified. Switching to ROM 1 8192+0 records in 8192+0 records out Upgrade image MD5 signature is b702a0a59a46a20a4924f9b17b8f0887 4259840+0 records in 4259840+0 records out 4194304+0 records in 4194304+0 records out 4194304+0 records in 4194304+0 records out 262144+0 records in 262144+0 records out Upgrade image MD5 signature verification is b702a0a59a46a20a4924f9b17b8f0887 Switching back to ROM 0 ROMMON upgrade complete. To make the new ROMMON permanent, you must restart the RP. ISR4321#reload 步骤5：验证ROMMON是否升级成功 ISR4321#sh rom-monitor R0 System Bootstrap, Version 16.2(1r), RELEASE SOFTWARE Copyright (c) 1994-2016 by cisco Systems, Inc. ISR4321#show platform Chassis type: ISR4321/K9 Slot Type State Insert time (ago) --------- ------------------- --------------------- ----------------- 0 ISR4321/K9 ok 00:04:37 0/0 ISR4321-2x1GE ok 00:03:24 R0 ISR4321/K9 ok, active 00:04:37 F0 ISR4321/K9 ok, active 00:04:37 P0 PWR-4320-AC ok 00:04:20 P2 ACS-4320-FANASSY ok 00:04:20 Slot CPLD Version Firmware Version --------- ------------------- --------------------------------------- 0 15030325 16.2(1r) R0 15030325 16.2(1r) F0 15030325 16.2(1r) 步骤6：升级软件Denali 16.x IOS XE 修改系统boot变量，保存配置并重启路由器 ISR4321(config)#no boot system bootflash:isr4300-universalk9.03.16.00c.S.155-3.S0c-ext.SPA.bin ISR4321(config)#boot system bootflash:isr4300-universalk9.16.02.01.SPA.bin ISR4321#wr Building configuration... [OK] ISR4321#reload 步骤7：验证路由器是否已升级到IOS XE 16.x版本 ISR4321#sh ver Cisco IOS XE Software, Version 16.02.01 Cisco IOS Software, ISR Software (X86_64_LINUX_IOSD-UNIVERSALK9-M), Version Denali 16.2.1, RELEASE SOFTWARE (fc1) Technical Support: http://www.cisco.com/techsupport Copyright (c) 1986-2016 by Cisco Systems, Inc. Compiled Mon 28-Mar-16 03:45 by mcpre ","link":"https://eflytop.github.io/post/cisco-isr4000-upgrade/"},{"title":"如何在CentOS 7上安装Cacti 1.2","content":"Cacti是一套基于PHP，MySQL，SNMP及RRDTool开发的网络流量监测图形分析工具。它通过SNMP来获取数据，使用 RRDtool绘画图形，本文介绍如何在CentOS 7上安装Cacti 1.2 将SELinux设置为permissive模式 sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config reboot 安装EPEL库 rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm 安装SNMP和RRDTool yum -y install net-snmp net-snmp-utils net-snmp-libs rrdtool 安装PHP Centos 7的初始PHP版本不符合Cacti的最低要求，因此我们安装PHP 7.3版本。 安装Remi库 yum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm 安装PHP 7.3 yum install -y --enablerepo=remi-php73 php php-xml php-session php-sockets php-ldap php-gd php-gmp php-intl php-mbstring php-mysqlnd php-pdo php-process php-snmp 安装MariaDB Centos 7预装的MariaDB 5.4不符合Cacti的最低要求，这里我们安装MariaDB官方最新版本，直接复制下框所有命令设置安装源： cat &lt;&lt;EOF&gt;&gt; /etc/yum.repos.d/mariadb.repo [mariadb]name = MariaDB baseurl = http://yum.mariadb.org/10.4/centos7-amd64 gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB gpgcheck=1 EOF 使用如下命令安装： yum install -y MariaDB-server MariaDB-client 数据库优化 编辑MariaDB配置文件： vi /etc/my.cnf.d/server.cnf 修改[mysqld]参数如下： collation-server = utf8mb4_unicode_ci character-set-server=utf8mb4 max_heap_table_size = 64M tmp_table_size = 64M join_buffer_size = 64M innodb_file_format = Barracuda innodb_large_prefix = 1 innodb_flush_log_at_timeout = 3 innodb_buffer_pool_size = 1GB innodb_buffer_pool_instances = 10 # Based on what type for storage you use. The below values are for SSD drives. # Change it if Cacti reports issues during the installation innodb_read_io_threads = 32 innodb_write_io_threads = 16 innodb_io_capacity = 5000 innodb_io_capacity_max = 10000 启用服务 systemctl start httpd snmpd mariadb systemctl enable httpd snmpd mariadb 创建Cacti数据库 MariaDB初始化 mysql_secure_installation 按照提示设定数据库root用户密码及完成其它设置（都可以选择默认）。 创建Cacti数据库 mysql -u root -p Enter password:******* MariaDB [(none)]&gt; create database cacti; MariaDB [(none)]&gt; GRANT ALL ON cacti.* TO cactiuser@localhost IDENTIFIED BY 'cactipassword'; MariaDB [(none)]&gt; flush privileges; MariaDB [(none)]&gt; exit 其中cactiuser是数据库用户名，cactipassword是数据库密码，都可以自定义，但是下文设置需与之匹配。 Cacti要求新创建的数据库用户cactiuser需要有权限去访问mysql.time_zone_name表，我们导入mysql_test_data_timezone.sql到mysql并授权来实现这个要求。 mysql -u root -p mysql &lt; /usr/share/mysql/mysql_test_data_timezone.sql Enter password:******* mysql -u root -p Enter password:******* MariaDB [(none)]&gt; GRANT SELECT ON mysql.time_zone_name TO cactiuser@localhost; MariaDB [(none)]&gt; flush privileges; MariaDB [(none)]&gt; exit 安装Cacti yum安装cacti yum -y install cacti 将默认数据库导入到cacti数据库 mysql cacti &lt; /usr/share/doc/cacti-*/cacti.sql -u root -p Enter password:******* 编辑数据库配置文件 vi /usr/share/cacti/include/config.php 设定名称，主机名，用户和密码信息 /* make sure these values reflect your actual database/host/user/password */ $database_type = &quot;mysql&quot;; $database_default = &quot;cacti&quot;; $database_hostname = &quot;localhost&quot;; $database_username = &quot;cactiuser&quot;; $database_password = &quot;cactipassword&quot;; $database_port = &quot;3306&quot;; $database_ssl = false; 编辑crontab文件 vi /etc/cron.d/cacti 取消注释以下条目以实现每五分钟轮询一次（删掉该条目前面的#号） */5 * * * * apache /usr/bin/php /usr/share/cacti/poller.php &gt; /dev/null 2&gt;&amp;1 编辑/etc/php.ini文件设置时区 vi /etc/php.ini 更新时区 date.timezone = Aisa/Shanghai #需要删除前面的;号 memory_limit = 512M max_execution_time = 60 编辑Apache配置文件 vi /etc/httpd/conf.d/cacti.conf 把Require host localhost修改为Require all granted，修改前： &lt;Directory /usr/share/cacti/&gt; &lt;IfModule mod_authz_core.c&gt; # httpd 2.4 Require host localhost &lt;/IfModule&gt; &lt;IfModule !mod_authz_core.c&gt; # httpd 2.2 Order deny,allow Deny from all Allow from localhost &lt;/IfModule&gt; &lt;/Directory&gt; 修改后： &lt;Directory /usr/share/cacti/&gt; &lt;IfModule mod_authz_core.c&gt; # httpd 2.4 Require all granted &lt;/IfModule&gt; &lt;IfModule !mod_authz_core.c&gt; # httpd 2.2 Order deny,allow Deny from all Allow from localhost &lt;/IfModule&gt; &lt;/Directory&gt; 安装cacti-spine 由于效率的原因，在需要大量采集数据时，如果使用自带的cmd.php轮询器会比较慢，1分钟1次的采集频率可能无法完成轮询所有的被监控的机器，从而可能导致部分监控项目不出图或图形断断续续。为了解决效率问题，Cacti官方也推出spine，采用多线程的方式高效的轮询。 安装spine yum -y install cacti-spine 设置spine vi /etc/spine.conf 填写主机名，用户和密码信息 DB_Host localhost DB_Database cacti DB_User cactiuser DB_Pass cactipassword DB_Port 3306 重新启动服务 systemctl restart httpd snmpd mariadb 设定防火墙 firewall-cmd --permanent --add-service=http firewall-cmd --reload 设置cacti 打开浏览器输入http://your-ip-address/cacti登陆后按照安装向导完成Cacti安装。默认密码为admin/admin 安装完成后，记得在[系统设置] -&gt; [设置] -&gt; [Poller]选项卡下将采集类型由cmd修改为spine。 其它 Cacti 1.2.11有一个小bug，输入用户名和密码无法登陆，打开php配置文件，注释掉如下内容即可(在前面加#号)： vi /usr/share/cacti/include/config.php # $cacti_cookie_domain = 'cacti.net'; ","link":"https://eflytop.github.io/post/cacti-install-on-centos/"},{"title":"如何在Cisco ISR 4000上抓包","content":"在本文中，我们将看到如何在Cisco ISR 4000系列路由器上抓包并导出抓包文件。抓包文件是pcap文件格式，可以在Wireshark中轻松打开和分析。 本实验中使用的ISR 4331正在运行IOS XE 16.6.4。 步骤1 - 创建capture buffer capture buffer是存储抓包数据的内存区域。有两种类型的缓冲区： 循环：一旦旧数据满就覆盖旧数据 线性：流量满后立即停止捕获流量 在这里我们创建一个capture buffer称为MYCAP，这是一个循环缓冲区，大小为10 KB： R1#monitor capture MYCAP buffer circular size 10 步骤2（可选）- 定义要捕获的流量 我们创建一个ACL并将其附加到capture buffer，与ACL匹配的数据包将被抓包。此步骤是可选的，如果不配置此步骤，所有数据包都会被抓包。 在这里我们创建一个MYCAP-ACL的访问列表，以匹配所有SIP（端口UDP 5060）流量。 R1(config)#ip access-list extended MYCAP-ACL R1(config-ext-nacl)#permit udp any any eq 5060 让ACL与capture buffer相关联： R1#monitor capture MYCAP access-list MYCAP-ACL 步骤3 - 指定要抓包的接口 我们可以在该接口上定义流量方向：输入，输出或两者。在这里我们抓接口GE 0/0/0上的流入和流出流量： R1#monitor capture MYCAP interface GigabitEthernet 0/0/0 both 步骤4 - 验证capture buffer capture buffer配置未存储在running-config中，因此我们需要使用show命令来验证配置。该命令是： R1#show monitor capture MYCAP 步骤5 - 开始和停止抓包 通过以下命令启动和停止抓包进程： R1#monitor capture MYCAP start R1#monitor capture MYCAP stop 运行第一个命令开始抓包，然后运行第二个命令中止抓包。所有抓包数据都存储在路由器的RAM中。 步骤6 - 查看抓包数据 现在是时候查看抓包数据了。其命令是： R1#show monitor capture MYCAP buffer brief 另一种选择是使用dump关键字而不是brief，它会打印包内容。 步骤7 - 导出抓包数据到本地 可以通过TFTP协议将抓包数据导出到本地电脑中。这样就可以用Wireshark分析数据了。 在确保您的计算机上运行着TFTP服务器后，运行export命令： R1#monitor capture MYCAP export tftp://tftp服务器地址/MYCAP.pcap 步骤8 - 清除capture buffer 如前所述，所有抓包数据都存储在路由器的RAM中。以下命令将清除抓包数据： R1#monitor capture MYCAP clear ","link":"https://eflytop.github.io/post/isr4000-capture/"},{"title":"Centos 7安装与配置Netflow Analyzer 12.4","content":"NetFlow Analyzer是一款专业的带宽监控与流量 协议分析软件，帮助用户了解网络流量构成、协议分布以及用户的行为。它利用Flow技术，支持NetFlow、sFlow、cflowd、J-Flow、IPFIX、NetStream等协议， 集流量收集、分析、报告于一体，为优化网络性能，实现带宽最佳利用以及扩容规划提供科学的依据。 本文将介绍如何在Centos 7系统下安装该软件12.4版本。 1 安装前环境准备 1.1 将SELinux设置为permissive模式，并重新启动服务器 [root@centos ~]# sed -i ‘s/^SELINUX=.*/SELINUX=permissive/g’ /etc/selinux/config [root@centos ~]# reboot 1.2 将从官网下载好的ManageEngine_NetFlowAnalyzer_64bit.bin安装包通过sftp工具上传至tmp目录 1.3 设置文件权限 [root@centos ~]# cd /tmp [root@centos tmp]# ls ManageEngine_NetFlowAnalyzer_64bit.bin yum.log [root@centos tmp]# chmod a+x ManageEngine_NetFlowAnalyzer_64bit.bin 2 软件安装 2.1 进入安装文件所在目录，使用如下命令开始安装 [root@centos ~]# cd /tmp [root@centos tmp]# ls ManageEngine_NetFlowAnalyzer_64bit.bin [root@centos tmp]# ./ManageEngine_NetFlowAnalyzer_64bit.bin Preparing to install… Extracting the JRE from the installer archive… Unpacking the JRE… 2.2 接下来按照命令提示安装，其中有个步骤可以设定web端口，默认是8060，这里我改成8080，监听端口9996不变 =============================================================================== Webserver port Enter requested information Enter the Web Server Port Number (Default: 8060): 8080 =============================================================================== NetFlow Listener Port Enter requested information Enter the NetFlow Listener Port (Default: 9996): =============================================================================== Pre-Installation Summary Please review the following before continuing: Product Name: ManageEngine NetFlowAnalyzer Install Folder: /opt/ManageEngine/OpManager 3 软件和服务配置 3.1 将软件变更为系统服务：进入安装好之后的软件的bin目录，运行 ./linkAsService.sh [root@centos ~]# cd /opt/ManageEngine/OpManager/bin [root@centos bin]# ./linkAsService.sh Running Opmanager as Service Opmanager Directory –&gt; /opt/ManageEngine/OpManager/bin Opmanager Service name –&gt; OpManager.service OpManager.service successfully placed in /etc/systemd/system/ directory Enabling services – Created symlink from /etc/systemd/system/multi-user.target.wants/OpManager.service to /etc/systemd/system/OpManager.service. Opmanager service is added successfully To start the service login as superuser and use – systemctl start OpManager.service 3.2 启用netflow服务 [root@centos ~]# systemctl start OpManager.service 3.3 输入./run.sh 运行程序 [root@centos ~]# cd /opt/ManageEngine/OpManager/bin [root@centos bin]# ./run.sh /opt/ManageEngine/OpManager/bin/.. 一月 03, 2020 1:30:34 下午 com.manageengine.silentmigration.SilentPatchUpdater getServerHome信息: SilentInstallation Home Dir : /opt/ManageEngine/OpManager /opt/ManageEngine/OpManager/bin/.. /opt/ManageEngine/OpManager/bin/.. 一月 03, 2020 1:30:37 下午 com.adventnet.persistence.ConfigurationParser$1 resolveEntity信息: /opt/ManageEngine/OpManager/bin/null/conf/customer-config.xml doesnt exists, hence it is skipped Port Availability Module 8080 No Client 13306 No postgres 22 No SSHD 69 No TFTP 514 No Syslog # Server is already running Connect to http://localhost:8080 to view the client 3.3 防火墙设置 [root@centos ~]# firewall-cmd –permanent –zone=public –add-port=8080/tcp success [root@centos ~]# firewall-cmd –permanent –zone=public –add-port=9996/udp success [root@centos ~]# firewall-cmd –reload success 4 Netflow的使用 在浏览器中输入NetFlow Server的地址并跟上设定好的Port即可，如下： http://你的ip:8080 初始用户名和密码为：admin/admin ","link":"https://eflytop.github.io/post/centos-7-netflow-installation/"},{"title":"FortiGate与ASA防火墙建立IPsec VPN","content":"用户本地的出口防火墙选用FortiGate设备，中心点为ASA防火墙，本文介绍如何在这2个设备之间建立IPsec VPN。 基本架构： 本地网段为10.1.0.0/24，对端网段为10.2.0.0/24 FortiGate设置： 1 导航栏选择VPN -&gt; IPsec Tunnels，点击Create New 2 填写VPN名字和类型 – name：根据实际需求填写 – Template type: site to site – NAT configuration: 根据实际需求填写，两边防火墙wan/outside接口ip地址如果是公网ip，那么基本上是FortiGate与ASA之间没有过NAT，选择No NAT between sites, 否则，根据实际情况选择local还是remote behind NAT. – Remote device type: Cisco 3 设置认证参数 remote ip address: 202.1.1.2 （一般为对端外网接口ip） outgoing interface: wan (选择防火墙的外网接口） pre-share-key: 123456 (自己定义) 4 设置策略和路由 填写本地加密网段和对端加密网段10.1.0.0/24和10.2.0.0/24 5 最后点击create完成VPN建立，Fortigate会根据你前面填写的参数自动完成相应设置 – 创建地址 – 创建路由 – 创建策略 ASA配置： 在设置ASA之前，我们先查看一下Fortigate具体用到的加密和校验参数是什么。 导航VPN -&gt; IPsec Tunnel Template -&gt; Site to Site – Cisco，我们可以看到: Phase 1 Interface Dead Peer Detection: on-demand Proposal: des-sha1 des-md5 DH Group: 5 Phase 2 Interface Perfect Forward Secrecy (PFS): enable Source Address Type: name Destination Address Type: name Proposal: des-md5 DH Group: 5 因此，ASA设定命令如下（旧版命令）： crypto isakmp policy 70 authentication pre-share encryption des hash sha group 5 crypto isakmp policy 80 authentication pre-share encryption des hash md5 group 5 access-list 1260 extended permit ip 10.2.0.0 255.255.255.0 10.1.0.0 255.255.255.0 access-list inside-acl extended permit ip 10.2.0.0 255.255.255.0 10.1.0.0 255.255.255.0 access-list nonat extended permit ip 10.2.0.0 255.255.255.0 10.1.0.0 255.255.255.0 nat (inside) 0 access-list nonat nat (inside) 1 10.0.0.0 0.0.0.0 global (outside) 1 interface crypto ipsec transform-set 1260 esp-des esp-md5-hmac crypto map vpnmap 1260 match address 1260 crypto map vpnmap 1260 set pfs group5 crypto map vpnmap 1260 set peer 101.1.1.2 crypto map vpnmap 1260 set transform-set 1260 crypto map vpnmap interface outside crypto isakmp enable outside tunnel-group 101.1.1.2 type ipsec-l2l tunnel-group 101.1.1.2 ipsec-attributes pre-shared-key 123456 验证 Fortigate：导航Monitor -&gt; IPsec Monitor ASA： show crypto isakmp sa show crypto ipsec sa ","link":"https://eflytop.github.io/post/fg-asa-firewall-vpn/"},{"title":"通过Aux口访问console口","content":"在实际网络环境中，有时需要通过Console口来管理路由器/交换机，但是如果没有Console配置线怎么办？你可以使用其它路由器的AUX口来连接。 示意图如下： 使用反转线（Rollover）将路由器A的AUX口连接到路由器B的Console口。反转线一条一端与另外一端线序相反的网线，如下图所示，你可以购买一条或者自行制作。 配置路由器A的AUX口。 Router_A(config)#line aux 0 Router_A(config-line)#transport input telnet 在路由器A上使用“ show line”命令验证AUX连接。 Router_A#sh line Tty Line Typ Tx/Rx A Modem Roty AccO AccI Uses Noise Overruns Int 0 0 CTY - - - - - 0 0 0/0 - 1 1 AUX 9600/9600 - - - - - 0 0 0/0 - * 514 514 VTY - - - - - 3 0 0/0 - 515 515 VTY - - - - - 0 0 0/0 - 在电脑上通过telnet x.x.x.x 2001来访问路由器B的console口。x.x.x.x为路由器A的IP地址。 ","link":"https://eflytop.github.io/post/aux-console-connection/"},{"title":"Cisco SD-WAN cEdge安装","content":"Cisco SD-WAN包含三大类Edge设备：vEdge-Cloud、vEdge硬件盒子、 cEdge路由器 vEdge-Cloud是以虚拟机的形式存在 vEdge硬件盒子包括了Viptela原生的路由器 cEdge是指思科ISR/ASR等路由器 cEdge 安装/更换 image cEdge支持如下硬件平台 Hardware Platform Model Cisco ASR 1000 series aggregation services routers ASR 1001-HX，ASR 1001-X， ASR 1002-HX， ASR 1002-X Cisco ISR 1000 series integrated services routers C1111-8P，C1111-8P LTE EA， C1111-8P LTE LA，C1117-4P LTE EA，C1117-4P LTE LA Cisco 4000 series integrated services routers ISR 4221，ISR 4321，ISR 4331，ISR 4351 务必确保设备的最小ROMMO版本如下 Hardware Platform Minimum ROM Monitor Software Version ASR 1000 series 16.3 (2r) ISR 1000 series 16.8 (1r) ISR 4000 series 16.7 (3r) 到思科官网下载路由器的SD-WAN镜像（非IOS） 将镜像导入路由器，此时切勿进行马上升级 执行如下命令，一定要确保IOS配置下的配置文件不会保存在NVRAM里。 因为当配置在SD-WAN镜像下启动被调用后，会无法让路由器进入SD-WAN config模式，会报错。重启后进入SD-WAN，cEdge默认一开始就会使用pnp模式，所以需要禁用，并清空pnp配置 ISR4K# (config)# no boot system ... ISR4K# (config)# boot system flash bootflash:SDWAN-image ISR4K# write erase ISR4K# config t ISR4K(config)# config-register 0x2102 ISR4K(config)# end ISR4K# reload Proceed with reload? [confirm] Yes ISR4K# pnpa service discovery stop ISR4K# request platform software sdwan software reset 进入SD-WAN config模式配置system信息 ISR4K# config-transaction ISR4K(config)# system host-name cEdge ISR4K(config-system)# system-ip 1.1.1.1 ISR4K(config-system)# site-id 11 ISR4K(config-system)# vbond 10.22.0.2 ISR4K(config-system)# organization-name xxxx ISR4K(config-system)# commit and-quit cEdge的tunnel名称具有特殊性，需要为每个物理接口都配置tunnel，cEdge是以tunnel来配置和调度接口，一 个物理接口对应一个tunnel接口。tunnel也具有限定的命名规则，如物理口ge0/0/0，那么对应的tunnel为0， 如果物理口ge0/1/0，那么对应的tunnel为10 ISR4K(config)# tunnel interface 0 ISR4K(config-if)# ip unnumbered GigabitEthernet0/0/0 ISR4K(config-if)# tunnel source GigabitEthernet0/0/0 ISR4K(config-if)# tunnel mode sdwan 配置物理接口地址 ISR4K(config)# interface GigabitEthernet0/0/0 ISR4K(config)# ip address 192.168.1.2 255.255.255.0 ISR4K(config)# no shut 配置VPN属性 ISR4K(config)# sdwan ISR4K(config-sdwan)# interface GigabitEthernet0/0/0 ISR4K(config-interface-interface-name)# tunnel-interface ISR4K(config-tunnel-interface)# color mpls ISR4K(config-tunnel-interface)# encapsulation ipsec ISR4K(config-tunnel-interface)#exit ISR4K(config)# ip route 0.0.0.0 0.0.0.0 192.168.1.1 cEdge 获取PID、SN和证书序列号 请使用如下命令查看设备序列号和token值 ISRK# show crypto pki certificates CISCO_IDEVID_SUDI Certificate Status: Available Certificate Serial Number (hex): XXXXXXXX Certificate Usage: General Purpose Issuer: cn=ACT2 SUDI CA o=Cisco Subject: Name: ISR4431/K9 Serial Number: PID:ISR4431/K9 SN:XXXXXXXXXXX cn=ISR4431/K9 ou=ACT-2 Lite SUDI o=Cisco serialNumber=PID:ISR4431/K9 SN:XXXXXXXXXXX Validity Date: start date: 19:35:04 UTC Mar 28 2016 end date: 19:35:04 UTC Mar 28 2026 Associated Trustpoints: CISCO_IDEVID_SUDI 安装License cEdge License请联系TSA获取，需要提供cEdge设备的PID、SN、证书序列号。License文件是附带organization属性的，所以拿到的license文件必须与证书、controller配置的organization名称一致。 进入vManage GUI界面，进入Configuration下的Devices菜单，在WAN Edge List下，选择Upload WAN Edge List 选择Viptela的vEdge license文件，并勾选验证vEdge license list前面的复选框后上传，上传完毕后，便可在list里面看到有效的vEdge list 将license导入后，就可以看到预制的vEdge list。包含三大类vEdge设备：vEdge-Cloud、vEdge硬件盒子、 cEdge路由器 vEdge-Cloud是以虚拟机的形式存在 vEdge硬件盒子包括了Viptela原生的路由器 cEdge是指思科ISR/ASR等路由器 cEdge上线 如果是使用系统自带的Symantec证书，cEdge无需安装，vManage会将签名后的证书传到cEdge，如果是使用其他CA，需要以下命令重新安装根证书，首先将根证书上传到bootflash ISR4K# request platform software sdwan root-cert-chain install bootflash:certificate 只要确保cEdge与controller网络可达，无需做任何操作，cEdge即可自动上线。 ","link":"https://eflytop.github.io/post/cisco-sd-wan-cedge-installation/"},{"title":"年轻人的第一个无线网络 - Cisco vWLC基础配置教程","content":"本文以vWLC 8.5.151.0为例。为什么选择这个版本呢？根据兼容性矩阵，这个版本是支持Cisco 3500系列AP的最高版本。3500系列是第一个支持5G（802.11n 300Mbps）的系列，在本文写作时仍具有实用价值。 另外在二手市场上我们可以方便地购买到大量低价并且相对完好的3500系列AP。无论做实验也好，给自家别墅做个无线覆盖也好，在预算有限的前提下，3500系列AP都是不错的选择。当然考虑到3500系列已经结束支持，如果预算足够的话，可以考虑一下比较新的型号。 本文用到的设备： Cisco AIR-CAP3502I-x-K9（x是地区限制代号，硬件是一样的） 一台服务器，作为虚拟机的主机（需要amd64架构，留出8GiB硬盘和2GiB内存给虚拟机） 需要准备的文件： vWLC安装文件：AIR_CTVM-K9_8_5_151_0.ova 瘦AP恢复版本固件：ap3g1-rcvk9w8-tar.153-3.JF10.tar 关于vWLC vWLC是Cisco做的一个虚拟化版本的WLC，基于Linux，能够运行在大多数虚拟机上。不过vWLC和硬件版本的WLC是有区别的。vWLC有很多限制： 不能使用local模式，也就是说不能让AP把用户流量转发到WLC上交换 AP注册上来以后，在AP的配置页面一定要将AP Mode设置为“Flexconnect”模式，否则AP看似注册上来了，但是Radio是down状态 不能使用mDNS Snooping 所有在端口上广播的功能都是坏的，例如DHCP vWLC不支持DHCPServer功能，需要自己搭建DHCP Server 以上是由vWLC本身条件所限制，虚拟控制器本身是装在PC或Server上的，处理性能比不上真实物理机，所以思科尽量将控制器的影响性能的一些软件特性移植到其它设备上，如DHCP Server功能，AP本地流量转发等等。 网络拓扑计划 以下是建议的网络拓扑： 所有AP接在同一个交换域下 你配置WLC用的电脑需要用有线网络接入同一个交换域 如果你需要配置多个不同的无线网络，那么你的交换机需要支持VLAN Trunking 如果你想使用service port，那么请为它准备一个单独的二层 安装vWLC 在VMware/ESXi/vSphere中部署 OVF 模板，导入AIR_CTVM-K9_8_5_151_0.ova 默认虚拟机配置： 1 vCPU 2GiB以上内存，关闭动态内存分配或者balloon device之类的功能 8GiB以上的IDE硬盘 两张网卡 第一个是service port，一开始建议不接，一定要接的话别接到management port同一个二层上 第二个是management port，需要连接到你的网络大二层或者默认VLAN上 有条件的话创建一个串口 接下来应该不用多说了，等待启动，然后可以看到提示 Press any key to use this terminal as the default terminal. 的时候按任意键。然后vWLC会显示一行等待autoinstall的倒计时提示： Would you like to terminate autoinstall? [yes] 在30秒内按一下回车来禁用autoinstall。接下来会进入初始化设置向导。 vWLC初始配置 设置向导 System Name [Cisco_MAC:ADDRESS] (31 characters max): 输入一个主机名 Enter Administrative User Name (24 characters max): 管理员用户名 Enter Administrative Password (3 to 24 characters): 管理员密码 Re-enter Administrative Password: 再输入一遍管理员密码 Service Interface IP Address Configuration [static][DHCP]: 如果没接直接回车即可；如果接了，配一个该网段的static地址 Management Interface IP Address: 输入你的大二层下面一个静态IP Management Interface Netmask: 子网掩码 Management Interface Default Router: 网关 Management Interface VLAN Identifier (0 = untagged): 输入VLAN tag，默认为0 Management Interface Port Num [1 to 1]: 1 Management Interface DHCP Server IP Address: 输入你的大二层下DHCP服务器的IP Virtual Gateway IP Address: 随便填一个你内网没用到的IP，192.168.1.1之类的都行 Mobility/RF Group Name: 随便填 Network Name (SSID): 随便填 Configure DHCP Bridging Mode [yes][NO]: 回车 Allow Static IP Addresses [YES][no]: 回车 Configure a RADIUS Server now? [YES][no]: no回车 Enter Country Code list (enter ‘help’ for a list of countries) [US]: 输入 US Enable 802.11b Network [YES][no]: no Enable 802.11a Network [YES][no]: no Enable 802.11g Network [YES][no]: no Enable Auto-RF [YES][no]: 回车 Configure a NTP server now? [YES][no]: no Configure the system time now? [YES][no]: no Would you like to configure IPv6 parameters[YES][no]: no Configuration correct? If yes, system will save it and reset. [yes][NO]: yes 接下来等待WLC重启应用配置。 启用Web管理面板 重启完以后登录，输入以下两行命令： config network webmode enable save config 接下来我们就可以和命令行说再见了。使用浏览器打开vWLC的管理面板，登录，点击右上角的Advanced。我们将会在这里完成初始的Wi-Fi设置。网页右上角有个保存配置的链接，尽量完成一部分配置就保存一下，否则WLC重启以后配置不会恢复。 如果WLC管理面板显示不正常，请关掉浏览器的广告屏蔽插件再试。 设置DNS和NTP 前往Controller-&gt;General，填写DNS Server IP为一个有效的DNS服务器IP。 前往Controller-&gt;NTP-&gt;Server，添加一个NTP服务器。Server后面的选项可以改成DNS，这样就可以输入域名。 如果不知道怎么填的话，NTP服务器可以填写这两个： time.asia.apple.com cn.pool.ntp.org 关闭DHCP Proxy 这个功能没什么用并且可能搞事，建议事先关掉。 前往Controller-&gt;Advanced-&gt;DHCP，取消勾选Enable DHCP Proxy。 AP更新固件 如果AP上是个胖（Autonomous）固件，那么需要刷成瘦固件。胖固件在无配置的情况下上电会尝试DHCP拿到一个IP，如果你能访问AP的网页管理面板（默认用户名和密码都是Cisco），那么进入Software-&gt;Software upgrade-&gt;HTTP Upgrade，上传ap3g1-rcvk9w8-tar.153-3.JF10.tar即可。（浏览器需要关闭弹出窗口拦截。） 如果AP上有配置，那么你可能需要使用Console来清除配置，方法自行查看文档。 如果你也跟我一样买了一批Console坏的AP，那么可能需要使用MODE按钮来更新固件。在你的电脑上启动一个TFTP服务器（记得关闭防火墙），把ap3g1-rcvk9w8-tar.153-3.JF10.tar重命名为ap3g1-k9w7-tar.default放在TFTP根目录下。然后将电脑的有线网口IP配置成10.0.0.2/24，并用网线连接电脑和AP。连接好后，按住AP上的MODE键给AP上电，等待AP上的LED转成红色（比较久，慢慢等）后立即松手。AP会自动从电脑下载固件然后重启。 注册 向WLC添加AP授权 管理面板上前往Management-&gt;Software Activation-&gt;License Type，设置成RTU。如果之前不是RTU，那么设置完需要保存配置重启一下。 然后左侧导航栏选择Licenses，在右边Adder License里面填入你购买的AP授权数量（最高200），点击Set Count，同意用户协议。 注册AP 把AP的网口连接到WLC所在的同一个二层，给AP上电，然后前往Wireless-&gt;Access Points-&gt;All APs查看AP注册状态。第一次注册会下载无线固件并重启，会比较久；之后会快很多。 AP启动过程中LED的模式： 绿色闪烁：正在加载固件 黄绿色常亮：正在启动固件 绿色常亮：正在DHCP 蓝色闪烁：正在下载新固件（只在手工更新固件或者第一次注册的时候有这个过程） 红-绿-蓝切换或红-绿切换：正在向WLC注册 蓝色闪烁 绿色常亮：正常工作 蓝色常亮：有设备连接 基础无线配置 所有AP都注册成功以后，就可以配置无线网络了。 配置AP属性 Wireless-&gt;Access Points-&gt;All APs，分别点击每一个AP的名字，做如下设置： General-&gt;AP Name和Location可以按需改一下，以便区分不同AP General-&gt;AP Mode：设为FlexConnect 配置Wi-Fi WLANs-&gt;WLANs-&gt;WLANs，右边创建一个新网络，填入Profile Name（名字，随便写）和SSID（Wi-Fi的显示名，也随便写），确定。 在列表界面点击新创建的WLAN ID，更改以下项： General-&gt;Status：勾选 Advanced-&gt;FlexConnect Local Switching：勾选 Advanced-&gt;Enable Session Timeout：取消勾选 其它你可能会想要更改的选项： 广播SSID：General-&gt;Broadcast SSID 密码：Security-&gt;Layer 2里面找到Authentication Key Management，只勾选PSK，下面的文本框里输入密码 2.4G/5G切换：General-&gt;Radio Policy 如果你配置了多个Wi-Fi网络，请记住WLAN ID和名称的对应关系，一会儿会用到。 配置Wi-Fi到VLAN的映射 如果你需要开多个Wi-Fi网络并且要把客户端分配到不同VLAN的话，需要把每个Wi-Fi网络映射到不同的VLAN ID。 进入Wireless-&gt;FlexConnect Groups，点击default-flex-group（或者新建一个），在General下点击FlexConnect AP，确认你所有的AP都显示在里面。 回到Wireless-&gt;FlexConnect Groups，点击你刚刚配置的group名称，在设置界面修改以下项目： WLAN VLAN mapping-&gt;VLAN Support：勾选 Native VLAN ID：根据实际情况填写 完成后先点击一下Apply。配置应用成功后，在同一页面的下面WLAN VLAN Mapping处，把WLAN ID和VLAN ID的对应关系逐条添加上。 启动无线网络 启动2.4G网络 Wireless-&gt;802.11b/g/n，勾选上802.11b/g Network Status和802.11g Support两项，点击Apply。 启动5G网络 Wireless-&gt;802.11a/n/ac，勾选上802.11a Network Status，点击Apply。 接下来做什么 确认配置生效后，别忘记在网页右上角点击Save Configuration 记得备份一下虚拟机，因为AP会保存WLC的证书，如果虚拟机丢了而你AP的Console又是坏的，重置会比较麻烦 参考官方文档，探索一下vWLC别的功能，例如CleanAir 本文转自Drown in Codes ","link":"https://eflytop.github.io/post/cisco-vwlc-installation/"},{"title":"MPLS VPN的基本配置","content":"MPLS-VPN是指采用MPLS（多协议标记转换）技术在骨干的宽带IP网络上构建企业IP专网，实现跨地域、安全、高速、可靠的数据、语音、图像多业务通信，并结合差别服务、流量工程等相关技术，将公众网可靠的性能、良好的扩展性、丰富的功能与专用网的安全 、灵活、高效结合在一起。本文主要展示一些基本配置。 MPLS-VPN配置 1.CE和PE（IGP） 2.区分CE相同路由（RD） 3.VRF（Virtual Routing Forwarding） 4.RT（路由的导入导出） ①配置各路由器接口以及PE-P-PE内部IGP，保证用于建立iBGP邻居的各路由器环回接口的可达性 PE1(config)#router isis PE1(config-router)#net 49.0000.0000.0001.00 PE1(config-router)#int f0/0 PE1(config-if)#ip router isis PE1(config-if)#int lo0 PE1(config-if)#ip router isis #只启用PE-P对接接口的ISIS路由功能，但是不要忽略了环回接口也需要启用 PE1(config-router)#is-type level-1 #优化ISIS配置，使路由器只发送level-1 Hello（只维护level-1 LSDB） P、PE2：配置同PE1。基本的接口配置省略。 ②启用PE-P-PE各个相连接口的MPLS功能 P(config)#int f1/0 P(config-if)#mpls ip P(config-if)#exit P(config-if)#int f2/0 P(config-if)#mpls ip PE1、PE2：配置同P基本相同 ③在PE上定义并配置VRF参数 PE1(config)#ip vrf vpna PE1(config-vrf)#rd 100:1 PE1(config-vrf)#route-target import 100:1 PE1(config-vrf)#route-target export 100:1 PE1(config-vrf)#exit PE1(config)#ip vrf vpnb PE1(config-vrf)#rd 200:2 PE1(config-vrf)#route-target import 200:2 PE1(config-vrf)#route-target export 200:2 PE2：配置同PE1 ④将VRF与相应的接口进行关联（PE与CE相连接的接口） PE1(config-vrf)#int f2/0 PE1(config-if)#ip vrf forwarding vpna % Interface FastEthernet2/0 IP address 14.1.1.1 removed due to enabling VRF vpna PE1(config-if)#ip add 14.1.1.1 255.255.255.252 PE1(config-if)#int f1/0 PE1(config-if)#ip vrf forwarding vpnb % Interface FastEthernet1/0 IP address 15.1.1.1 removed due to enabling VRF vpnb PE1(config-if)#ip add 15.1.1.1 255.255.255.252 PE2：配置基本同PE1。 ⑤配置PE到PE的iBGP连接（MP-BGP） PE1(config)#router bgp 100 PE1(config-router)#bgp router-id 1.1.1.1 PE1(config-router)#nei 3.3.3.3 remote-as 100 PE1(config-router)#nei 3.3.3.3 update-source lo0 PE1(config-router)#address-family vpnv4 PE1(config-router-af)#nei 3.3.3.3 activate PE1(config-router)#address-family ipv4 vrf vpna PE1(config-router)#address-family ipv4 vrf vpnb PE2：配置基本同PE1。 ⑥配置PE到CE 的vrf 路由（注意这里与传统路由的区别） a)静态路由 PE1(config)#ip route vrf vpna 10.1.1.1 255.255.255.255 14.1.1.2 PE1(config)#ip route vrf vpnb 10.1.1.1 255.255.255.255 15.1.1.2 PE1(config)#router bgp 100 PE1(config-router)#address-family ipv4 vrf vpna PE1(config-router-af)#redistribute static PE1(config-router-af)#exit-address-family PE1(config-router)#address-family ipv4 vrf vpnb PE1(config-router-af)#redistribute static PE2：配置基本同PE1。 CE1_vpna(config)#ip route 0.0.0.0 0.0.0.0 14.1.1.1 CE1_vpnb、 CE2_vpna 、CE2_vpnb：配置都是只需要添加一条缺省路由指向对端的PE设备。 b)OSPF PE1(config)#router ospf 1 vrf vpnb PE1(config-router)#router-id 1.1.1.1 PE1(config-router)#redistribute bgp 100 subnets PE1(config-router)#network 15.1.1.1 0.0.0.0 area 0 PE1(config-router)#exit PE1(config)#router bgp 100 PE1(config-router)#address-family ipv4 vrf vpnb PE1(config-router-af)#redistribute ospf 1 PE2：配置基本同PE1。 CE1_vpnb(config)#router ospf 1 CE1_vpnb(config-router)#router-id 10.1.1.1 CE1_vpnb(config-router)#net 10.1.1.1 0.0.0.0 a 0 CE1_vpnb(config-router)#net 15.1.1.2 0.0.0.0 a 0 CE1_vpna、 CE2_vpna 、CE2_vpnb：配置基本同CE1_vpnb。 c)BGP PE1(config-router)#address-family ipv4 vrf vpnb PE1(config-router-af)#neighbor 15.1.1.2 remote-as 500 PE1(config-router-af)#neighbor 15.1.1.2 activate PE2：配置基本同PE1。 CE1_vpnb(config-router)#router bgp 500 CE1_vpnb(config-router)#nei 15.1.1.1 remote-as 100 CE1_vpnb(config-router)#network 10.1.1.1 mask 255.255.255.255 CE1_vpnb(config-router)#network 15.1.1.0 mask 255.255.255.252 CE1_vpna、 CE2_vpna 、CE2_vpnb：配置基本同CE1_vpnb。 MPLS VPN排错 1.查看哪些接口启用了MPLS P#show mpls interface Interface IP Tunnel Operational FastEthernet1/0 Yes (tdp) No Yes FastEthernet2/0 Yes (tdp) No Yes 2.查看LDP邻居建立情况 PE1#sh mpls ldp discovery detail Local LDP Identifier: 1.1.1.1:0 Discovery Sources: Interfaces: FastEthernet0/0 (tdp): xmit/recv Hello interval: 5000 ms; Transport IP addr: 1.1.1.1 TDP Id: 2.2.2.2:0 Src IP addr: 12.1.1.2; Transport IP addr: 2.2.2.2 Hold time: 15 sec; Proposed local/peer: 15/15 sec Reachable via 2.2.2.2/32 Local LDP Identifier 是每台LSR都必须有的，这个ID用6个字节表示，前4个节字称为Rotuer-ID，先选loopback地址最大的，然后是物理接口，它的选举方法和OSPF Rotuer-ID相同，后面2个字节是表示标签空间的，也就是标签是基于设备还是基于接口，如果是基于设备，就是0，可以从上面看出，1.1.1.1:0中，1.1.1.1表示R1的Rotuer-ID，而0表示标签是基于设备的。 Transport IP addr默认是选用Rotuer-ID的地址，这个地址在建邻居时非常重要，是会话的源地址，如果这个地址对方没有路由可达，那么就不可能建起邻居。所以一定要保证双方Transport IP 是路由相通的。 3.其它命令 router# show mpls ldp neighbor #LDP邻居正常状态为Operational（简写为Oper） router# show mpls forwarding-table #查看LFIB表 router# show ip route vrf vrf_name #查看vpn的私网路由表 router# show ip cef vrf vrf_name #查看vpn的私网转发表 router# show ip bgp summary #查看BGP邻居的基本状况 router# show ip bgp vpnv4 all #查看BGP中关于VPNv4路由的信息 router# show ip bgp vpnv4 all labels #查看BGP私网路由对应的标签 router# show ip vrf interfaces #显示vrf 接口信息 router# sh ip route vrf YJGQSP #查看VPN路由表 router# sh ip bgp vpnv4 vrf YJGQSP summary #查看BGP邻居建立情况 router# ping vrf YJGQSP 10.199.82.1 source 10.199.82.5 #测试VPN通信 router# sh ip bgp vpnv4 vrf YJGQSP neighbors 96.0.183.1 advertised-routes #查看本路由器向邻居通告了哪些路由 router# sh ip bgp 10.199.82.0 测试MPLS VPN 1.测试CE到CE的连通性 CE1_vpnb#ping 10.1.3.1 source 10.1.1.1 #因为没有将直连的网段重分发到vpn路由表中，所以需要添加环回接口来测试 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 10.1.3.1, timeout is 2 seconds: Packet sent with a source address of 10.1.1.1 !!!!! Success rate is 100 percent (5/5), round-trip min/avg/max = 76/124/176 ms 2.测试PE到CE的连通性 PE1#ping vrf vpnb 10.1.3.1 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 10.1.3.1, timeout is 2 seconds: !!!!! Success rate is 100 percent (5/5), round-trip min/avg/max = 52/94/156 ms MPLS VPN排障思路 1.查看私网路由表 show ip route vrf vrf_name show ip cef vrf vrf_name 2.若没有正确学习到私网路由，则： ①MP-BGP邻居是否正常建立 show ip bgp vpnv4 all summary show ip bgp vpnv4 vrf vrf_name summary ②本路由器是否正确通告路由 ③对端是否正确学习 ④本端RT export与对端RT import是否匹配 3.若已经正确学习都私网路由，则：检查公网标签是否正确 show mpls forwarding-table show mpls ldp neighbor ","link":"https://eflytop.github.io/post/basic-mpls-vpn-cfg/"},{"title":"Cisco SD-WAN之vManage，vBond，vSmart和vEdge上线","content":"SD-WAN的架构 1、编排平面: Vbord作为协调器，协调管理控制。数据平面负责授权所有控制器连接（白名单模式）。 2、管理平面: Vmanager统一图形化管理，实施。 3、控制平面: Vsmart整个方案的大脑，提供中心策略，负责实施策略、网络分段、流量工程等。与所有Vedge建立关系，每一个租户一个Vsmart。 4、数据平面: Vedge可以是虚拟的，也可以是硬件路由器。 Vsmart与Vedge之间运行OMP，edge之间没有控制平面，只有数据转发层面（Vsmart通常可以理解为BGP的RR），它收集所有站点的NLRI（前缀信息），默认情况下，edge会自动将本地业务侧路由表中的前缀信息公布到OMP。 一、架构和基本信息 1. 架构图 2. IP和设备信息 3. 上线基本流程 二、IOS CA基本配置 1. 配置CA服务器 IOS-CA(config)#crypto key generate rsa label PKI modulus 2048 The name for the keys will be: PKI % The key modulus size is 2048 bits % Generating 2048 bit RSA keys, keys will be non-exportable... [OK] (elapsed time was 2 seconds) *Sep 25 09:08:17.986: %SSH-5-ENABLED: SSH 1.99 has been enabled IOS-CA(config)#ip http server IOS-CA(config)#crypto pki server PKI IOS-CA(cs-server)#database url flash: % Server database url was changed. You need to move the % existing database to the new location. IOS-CA(cs-server)#database level complete IOS-CA(cs-server)#issuer-name cn=rootca.lab.local IOS-CA(cs-server)#hash sha256 IOS-CA(cs-server)#database archive pkcs12 password cisco123 IOS-CA(cs-server)#grant auto *Sep 25 09:09:44.783: %PKI-6-CS_GRANT_AUTO: All enrollment requests will be automatically granted. IOS-CA(cs-server)#no shut %Some server settings cannot be changed after CA certificate generation. % Certificate Server enabled. *Sep 25 09:09:56.732: %PKI-6-CS_ENABLED: Certificate server now enabled. 2. 查看root CA 我们可以导出root CA到flash存储 IOS-CA(cs-server)#crypto pki export PKI pem url flash: % The specified trustpoint is not enrolled (PKI). % Only export the CA certificate in PEM format. % Exporting CA certificate... Destination filename [PKI.ca]? Writing file to flash0:PKI.ca 或者直接在terminal窗口查看root CA IOS-CA(config)#crypto pki export PKI pem terminal % The specified trustpoint is not enrolled (PKI). % Only export the CA certificate in PEM format. % CA certificate: -----BEGIN CERTIFICATE----- MIIDFDCCAfygAwIBAgIBATANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDExByb290 Y2EubGFiLmxvY2FsMB4XDTIwMDkyNTA5MDk1NFoXDTIzMDkyNTA5MDk1NFowGzEZ MBcGA1UEAxMQcm9vdGNhLmxhYi5sb2NhbDCCASIwDQYJKoZIhvcNAQEBBQADggEP ADCCAQoCggEBAI5CbMtIV1G/5V8pETpqeMFfRSPPIH5Wa7+qoHB2xE7i8HzSGSG9 V2+qGmXVbSU7eMDkPDZyr1GOqQ2czKsUvL1eP5Rfcn8UhbqmmRkMTnQl+FMQh/FJ LlyWmzjiJLOGLhL+Vn/+m0O57mDWoHe4jMeVi/YXBShw7R/mgNrwBj7v3eKPHlCC S4cmsx1y0A1srcvybN7gFGKFtwbkMZjCt5VObM4PFTcT1MHFDLzVbZDmwVzY63+l TpWR6t5/QgTAA30MNRSHYf2GkzUafN6rzaqv4e09IaBYlKcBNA7Kqosh6QgirQUN m3jB+PwlYlUCi4k3r7s+dUuO1AspTi62m7ECAwEAAaNjMGEwDwYDVR0TAQH/BAUw AwEB/zAOBgNVHQ8BAf8EBAMCAYYwHwYDVR0jBBgwFoAUMpsdCVikHqDDPo6WKe28 IG1joqkwHQYDVR0OBBYEFDKbHQlYpB6gwz6OlintvCBtY6KpMA0GCSqGSIb3DQEB CwUAA4IBAQAqr0PfJBdx2hGvvDaUo6CQ5daRKeDzTlb6EudQFYDMEofSJlKXOKTC ObCBwMw6IDW/kiAbh077g49je965X8TCYizRCwsOcljChlqSL9Mh45G3dN/29SIQ QL/04wwRTvN9ApuPSStEFp2uodr4bbOZA3p8EmFKA69Vf96x+Fq/QAPYChCFry9D byCX683PA/n9Ybf8CvlbkLecev4ec+HwbCTsb3CScfaIDAR4Qpfj/4o39q+6pAOM sm96XJZ7bDH/YWc0eY6dFvtAx8QNDvWTIlc+W9w+q9MsaA7xaRDDfsHBV0gUw8aa iZoea+3xUZIgi5FnPHipoay+KbWiMDv3 -----END CERTIFICATE----- 三、vManager配置 1.初始化vManage Password: Welcome to Viptela CLI admin connected from 127.0.0.1 using console on vmanage Available storage devices: hda 19GB hda1 3GB hda2 16GB hdb 100GB hdc 3GB 1) hdb 2) hdc Select storage device to use: 1 Would you like to format hdb? (y/n): y mke2fs 1.43.4 (31-Jan-2017) Creating filesystem with 26214400 4k blocks and 6553600 inodes Filesystem UUID: 7ed402ab-8f16-469e-ba6d-a5bc7aec6b8b Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 4096000, 7962624, 11239424, 20480000, 23887872 Allocating group tables: done Writing inode tables: done Creating journal (131072 blocks): done Writing superblocks and filesystem accounting information: 等过几分钟等全部服务起来后进行后续步骤，不然会出现无法登录或报错等问题。 2.vManage基础配置 system host-name vManage system-ip 10.100.0.10 site-id 100 organization-name lab vbond 223.1.1.11 vpn 0 interface eth0 ip address 223.1.1.10/24 no shut tunnel-interface allow-service sshd allow-service netconf ip route 0.0.0.0/0 223.1.1.1 vpn 512 interface eth1 ip add 10.16.72.123/25 no shut ip route 10.0.0.0/8 10.16.72.1 commit 网页登录地址：https://10.16.72.123:8443/ 账号密码: admin/admin 3. 安装root CA vManage导入Root CA 4. 生成vManage CSR 5. 安装vManage CA 通过CSR生成vManage CA IOS-CA#crypto pki server PKI request pkcs10 terminal PKCS10 request in base64 or pem % Enter Base64 encoded or PEM formatted PKCS10 enrollment request. % End with a blank line or &quot;quit&quot; on a line by itself. 看到% End with a blank line or &quot;quit&quot; on a line by itself.提示后粘贴vManage CSR % End with a blank line or &quot;quit&quot; on a line by itself. -----BEGIN CERTIFICATE REQUEST----- MIIDKjCCAhICAQAwgakxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTERMA8GA1UE BxMIU2FuIEpvc2UxDDAKBgNVBAsTA2xhYjEMMAoGA1UEChMDbGFiMUEwPwYDVQQD Ezh2bWFuYWdlLTRkYTQxNDZiLTIxMDctNGNiMC04MWQ4LTJhMjAxODkxYmI5OS02 LmxhYi5sb2NhbDEbMBkGCSqGSIb3DQEJARYMYWRtaW5Ac2MuY29tMIIBIjANBgkq hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAs7mHp1piPXQArk6F9uKzQ+kjf8H6+NhC TL/uS16K2BmpoVegknBaC/hlBWVCdvp5gB43zBgdincLVJGLpJPFNkEudq4E1TDa WVEY54gLM1mgzJGiZI8KaNTnUd5UdA7iA87bnKb8QwY9b2em2634LQQhgj1xv6RU GRSjiGmT4eCTvz31xoOV/9m2/xX091Kcq39hk3OBCaKhwmuxEkmTtntGNLGxUSyP upkbK0kVNAowWtzuuFBjLF5SJh3wD5Dq8Tnv9wlH5vxI7lBB36X3YE5dlGyALK0y GuZybgkdxbCCAUyUTIbezO68sic4rAEVmxUgZp5yGpWoFVC6xyrq9QIDAQABoDsw OQYJKoZIhvcNAQkOMSwwKjAJBgNVHRMEAjAAMB0GA1UdDgQWBBTBLXO5YYMdJN+J gobKQhadrbxGhzANBgkqhkiG9w0BAQsFAAOCAQEAFi/KGz+6WEgAVH8hPB/7I+Gd nAVWS92M+S4BKU8PexiP7D6I+NXI3Hv+9GVhNdE7UOZs9xbs4yN+u/aZehzFV3c5 c4DMK2/5F/43Zw/E+MPmZ5mp/wFVNKh1HTnhMiQm30aPNonWWQljmVcYUmDXCQOA DcKG7eJpafTmIPxBtRsvXZv8fJe1yJGdoprDEiH7qISVrJqhx+o6zHSzLDSPu1PP xZCDUcbVvm3bwdsCNB51Oy6qyXPdIlbR/aY4UIaQzver4aFyQcXWrUTIi1PFDtbc Y3gpTC6FLRT8CFir+Dj1x/rcMo9rRlkx24cYEJWGZrscK6+eTXom1vvDOkcqpw== -----END CERTIFICATE REQUEST----- 然后输入quit，获得vManage CA Y3gpTC6FLRT8CFir+Dj1x/rcMo9rRlkx24cYEJWGZrscK6+eTXom1vvDOkcqpw== -----END CERTIFICATE REQUEST----- quit % Granted certificate: -----BEGIN CERTIFICATE----- MIIDkzCCAnugAwIBAgIBAzANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDExByb290 Y2EubGFiLmxvY2FsMB4XDTIwMDkyNjA4MDMwNFoXDTIxMDkyNjA4MDMwNFowgakx CzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTERMA8GA1UEBxMIU2FuIEpvc2UxDDAK BgNVBAsTA2xhYjEMMAoGA1UEChMDbGFiMUEwPwYDVQQDEzh2bWFuYWdlLTRkYTQx NDZiLTIxMDctNGNiMC04MWQ4LTJhMjAxODkxYmI5OS02LmxhYi5sb2NhbDEbMBkG CSqGSIb3DQEJARYMYWRtaW5Ac2MuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A MIIBCgKCAQEAs7mHp1piPXQArk6F9uKzQ+kjf8H6+NhCTL/uS16K2BmpoVegknBa C/hlBWVCdvp5gB43zBgdincLVJGLpJPFNkEudq4E1TDaWVEY54gLM1mgzJGiZI8K aNTnUd5UdA7iA87bnKb8QwY9b2em2634LQQhgj1xv6RUGRSjiGmT4eCTvz31xoOV /9m2/xX091Kcq39hk3OBCaKhwmuxEkmTtntGNLGxUSyPupkbK0kVNAowWtzuuFBj LF5SJh3wD5Dq8Tnv9wlH5vxI7lBB36X3YE5dlGyALK0yGuZybgkdxbCCAUyUTIbe zO68sic4rAEVmxUgZp5yGpWoFVC6xyrq9QIDAQABo1MwUTAPBgNVHRMBAf8EBTAD AQH/MB8GA1UdIwQYMBaAFL5MINN+WxCMkIqgkVse/sq3QnSTMB0GA1UdDgQWBBTB LXO5YYMdJN+JgobKQhadrbxGhzANBgkqhkiG9w0BAQsFAAOCAQEAVH7Ylx4JdSaK x96Gjg+E4EfAXwyzBHxb5DOnsxY2ksHbLm2qRPImXxjRJPt2/JIFeGqdaiDKqelE iK3AHGu3n/cV7eZZ1L0JHXcaUrutWhtArggYuYCeyDttQ4HfoLLHPik9AoYMZulY Wt6QPejyBN4HSxepuu1LWzJYEE0lOC/fhIPzja1jzed/WdZPwQGuzYiPDwT3LLiW z5M+1Y+TlLciZ7WU6rLsfwXUo5X4GK1OhAjtAjntq+2YISXZ1PIDwcmEW+Cvlyss bqowLd+fNGWDD5x10f5uokSHxAlLPuLazSyA3ItHZhbvaOT7Sbz/gCITDZVZgT7y CVvEElpVpA== -----END CERTIFICATE----- 安装vManage CA 安装成功后可以看到证书状态 四、vBond配置 1. 基本配置 system host-name vBond system-ip 10.100.0.11 site-id 100 organization-name lab vbond 223.1.1.11 local vpn 0 interface ge0/0 ip address 223.1.1.11/24 no shut tunnel-interface encapsulation ipsec allow-service sshd allow-service netconf ip route 0.0.0.0/0 223.1.1.1 commit 2. 加入vManager 3. 安装root CA 进入vshell模式 vBond# vshell vBond:~$ cat &gt;&gt; root-ca.txt &lt;&lt;EOF &gt; 看到&gt;提示符后粘贴Root CA证书的内容 &gt; -----BEGIN CERTIFICATE----- &gt; MIIDFDCCAfygAwIBAgIBATANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDExByb290 &gt; Y2EubGFiLmxvY2FsMB4XDTIwMDkyNjA4MjY1N1oXDTIzMDkyNjA4MjY1N1owGzEZ &gt; MBcGA1UEAxMQcm9vdGNhLmxhYi5sb2NhbDCCASIwDQYJKoZIhvcNAQEBBQADggEP &gt; ADCCAQoCggEBAM9hTvXeXbQ8R6SDXrMAUA/aZ78965bovbSr9sUqFPyXKf5PH6FY &gt; mKIJQDKRwcz4CIXJEd0QHbtsSih/qzEKaGSYknezbTMYA5Tqab5fu4Pa84isCngM &gt; v962Ubh4Q0w8OGv2Na9A4HR0rwlquVb2LvigDKqtLrxsOvr6ORr67WHuRXs+Kpe6 &gt; 1mUFWf2pMTPAZGn+ZT7iPkdiWR+2G+mFYXSG/aHAmDABqWfCSXmg1QOCOT5zSLZd &gt; mbb9jiJlRZATGtnlDCXyu546Nqvoa+iJcc8X3WWFhhHVyq3abhqAlKIcv9kj+Lq4 &gt; rZ1VvCMcZKdoNMaVrhsv6GmIZWVuPjz/SrcCAwEAAaNjMGEwDwYDVR0TAQH/BAUw &gt; AwEB/zAOBgNVHQ8BAf8EBAMCAYYwHwYDVR0jBBgwFoAUN5ywvAkOjuS7vl7yR+Am &gt; xt+iABMwHQYDVR0OBBYEFDecsLwJDo7ku75e8kfgJsbfogATMA0GCSqGSIb3DQEB &gt; CwUAA4IBAQBhPgh5l2rXj+oFYuWfnLW/372wn5Xu/HnxMXqmXzhZpXVbDh5DdG7e &gt; +q4qJxRkuzmLZtjAhd+OIz1AQdGjclwlrraUPIBF2lT381PuUkuBOfL275HmBgoU &gt; iMKmXKHBBsX+/4DxVvGL6QK6i1VL+Gs0moBkJiudip9tkiMMmbMKkQfLDG/9c8Pv &gt; DysCHfTVcyMsGf/dKngtaPEXE4IlwRWih9cug6IShnLp+SePvf2kQow/vzv2bDXW &gt; bDwyuzxvp0F5GdJUivbkItM7rHFuL+apgAU2baiOSJ7t2CJlOy261iCvZpuILz80 &gt; GRaJYW3BzETN7BssLkLmaU91FW1DyzIb &gt; -----END CERTIFICATE----- 安装Root CA &gt; EOF vBond:~$ exit exit vBond# request root-cert-chain install /home/admin/root-ca.txt Uploading root-ca-cert-chain via VPN 0 Copying ... /home/admin/root-ca.txt via VPN 0 Updating the root certificate chain.. Successfully installed the root certificate chain 4. 生成vBond CSR 5. 安装vBond CA 通过vBond CSR生成vBond CA IOS-CA#crypto pki server PKI request pkcs10 terminal PKCS10 request in base64 or pem % Enter Base64 encoded or PEM formatted PKCS10 enrollment request. % End with a blank line or &quot;quit&quot; on a line by itself. 看到% End with a blank line or &quot;quit&quot; on a line by itself.提示后粘贴vBond CSR % End with a blank line or &quot;quit&quot; on a line by itself. -----BEGIN CERTIFICATE REQUEST----- MIIDKDCCAhACAQAwgacxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTERMA8GA1UE BxMIU2FuIEpvc2UxDDAKBgNVBAsTA2xhYjEMMAoGA1UEChMDbGFiMT8wPQYDVQQD EzZ2Ym9uZC01ZDM5NTg5Yy1kNDVmLTQxM2YtYWQ0Mi1jZjkyMTVhZWZmNjUtMC5s YWIubG9jYWwxGzAZBgkqhkiG9w0BCQEWDGFkbWluQHNjLmNvbTCCASIwDQYJKoZI hvcNAQEBBQADggEPADCCAQoCggEBAOX7qRtSUX0WpUvICGEnIINcnc1FDXPZmGG+ zixWw2l3ZJIHM1JkzazI97FeEXkSX+OVeqodSHUF98+/DNJ1Bgczmqb8PhtqMf9q Bc4lys4v2WqDUszhH9BmLBIk7GXkkVXz3DJ0q9NOvukiyFAinzGkgZjPfIO1cFlD rPOUB8A9mG71U9HaR9p91nWEWlJrtNZVOv6VLRkkVXSKZ2n1BHvfWm73xKiK/18J Dk1QfsJaoIC8cYudnHxBZJFzhmhTjAmOXPCkPgjmSvwvM49Hl6eWFtZQD7kYN+Xf Ty/oxk13ZeDB8hNhQJIpGJ862ZxeerwXHtmxQbMecCFZWlry1Q0CAwEAAaA7MDkG CSqGSIb3DQEJDjEsMCowCQYDVR0TBAIwADAdBgNVHQ4EFgQU8kbeV1HJZgkHjtCy o8B2O+1VfNIwDQYJKoZIhvcNAQELBQADggEBAKrnYRoQEr5fOlTWqNvivOzQngUV 1d7IjIFuoVgJepQjzIiaDgjuwJbWNLwonLRyjLhgo2s1fQXqqDWbR16TmAjIIRyq 78kgsDL4FYj1J5OsHVI0UjNC+SFAm9zAkTWg1EHP0JGwBMPiozMWhdcgE0XKUps2 hQq9QBIjPrGdCvaMyeNnocd+WAmowlu23E5EFA9IfGrGHM8VDnxKWJRTu9+GedVv X3LIZ30qQ5i0iu8Av0TGsleRDsy3fAMNxniYRMXBsH+KcHnFqJDulf2dkPeLpQuK twWDYnOOS6A06t241kjlES14SPOszcnXCT9fg6ekCCJQHh9aolOoIhwWzYE= -----END CERTIFICATE REQUEST----- 然后输入quit，获得vBond CA，复制给下一步用 twWDYnOOS6A06t241kjlES14SPOszcnXCT9fg6ekCCJQHh9aolOoIhwWzYE= -----END CERTIFICATE REQUEST----- quit % Granted certificate: -----BEGIN CERTIFICATE----- MIIDkTCCAnmgAwIBAgIBATANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDExByb290 Y2EubGFiLmxvY2FsMB4XDTIwMDkyNjA2NDk1NVoXDTIxMDkyNjA2NDk1NVowgacx CzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTERMA8GA1UEBxMIU2FuIEpvc2UxDDAK BgNVBAsTA2xhYjEMMAoGA1UEChMDbGFiMT8wPQYDVQQDEzZ2Ym9uZC01ZDM5NTg5 Yy1kNDVmLTQxM2YtYWQ0Mi1jZjkyMTVhZWZmNjUtMC5sYWIubG9jYWwxGzAZBgkq hkiG9w0BCQEWDGFkbWluQHNjLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC AQoCggEBAOX7qRtSUX0WpUvICGEnIINcnc1FDXPZmGG+zixWw2l3ZJIHM1JkzazI 97FeEXkSX+OVeqodSHUF98+/DNJ1Bgczmqb8PhtqMf9qBc4lys4v2WqDUszhH9Bm LBIk7GXkkVXz3DJ0q9NOvukiyFAinzGkgZjPfIO1cFlDrPOUB8A9mG71U9HaR9p9 1nWEWlJrtNZVOv6VLRkkVXSKZ2n1BHvfWm73xKiK/18JDk1QfsJaoIC8cYudnHxB ZJFzhmhTjAmOXPCkPgjmSvwvM49Hl6eWFtZQD7kYN+XfTy/oxk13ZeDB8hNhQJIp GJ862ZxeerwXHtmxQbMecCFZWlry1Q0CAwEAAaNTMFEwDwYDVR0TAQH/BAUwAwEB /zAfBgNVHSMEGDAWgBS+TCDTflsQjJCKoJFbHv7Kt0J0kzAdBgNVHQ4EFgQU8kbe V1HJZgkHjtCyo8B2O+1VfNIwDQYJKoZIhvcNAQELBQADggEBADdyhIXQAfhYNRKM MhHHCGe8KFGx9hrvOe2I1nvJdLe4SJaPBo+ELl/z/DTLbZhNARUahAOGdZgWk/pM CLrpPNP5FbTiOeAtsrYG11bbDS9KG6llcKHqpibdslkyo7djpQBimNHYtKnu45WU AUwHF4ZQ6alXY+TFb7U8zcW3ga0Xs9CeCJiXGgdWLRgICpiz4GbEDW8tIJUnNwmg lz5uwVwTI/YwzuXaybx7fUw6XPefK8mFfd0wcAwicZisNl541v2+lVph0S/MAclZ 7+Y6YTBrAEZRzf2olnT/Peg6OolE9dbhFecAFFuhBmbHMtPZilf88xJiKK5Y6O+r 3SoHJ/w= -----END CERTIFICATE----- 安装vBond CA证书 五、vSmart配置 1. 基本配置 system host-name vSmart system-ip 10.100.0.12 site-id 100 organization-name lab vbond 223.1.1.11 vpn 0 interface eth0 ip address 223.1.1.12/24 no shut tunnel-interface allow-service sshd allow-service netconf ip route 0.0.0.0/0 223.1.1.1 commit 2. 加入vManager 3. 安装证书同vBond操作，省略 六、vEdge安装 1. 基本配置 system host-name vEdge1 system-ip 10.12.0.1 site-id 12 organization-name lab vbond 223.1.1.11 vpn 0 interface ge0/0 ip address 192.1.1.2/24 no shut tunnel-interface color public-internet encapsulation ipsec allow-service all interface ge0/1 ip address 172.31.11.2/24 no shut tunnel-interface color mpls encapsulation ipsec allow-service all ip route 0.0.0.0/0 192.1.1.1 commit 2. 安装Root CA 进入vshell模式 vEdge1# vshell vEdge1:~$ cat &gt;&gt; root-ca.txt &lt;&lt;EOF &gt; 看到&gt;提示符后粘贴Root CA证书的内容 &gt; -----BEGIN CERTIFICATE----- &gt; MIIDFDCCAfygAwIBAgIBATANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDExByb290 &gt; Y2EubGFiLmxvY2FsMB4XDTIwMDkyNjA4MjY1N1oXDTIzMDkyNjA4MjY1N1owGzEZ &gt; MBcGA1UEAxMQcm9vdGNhLmxhYi5sb2NhbDCCASIwDQYJKoZIhvcNAQEBBQADggEP &gt; ADCCAQoCggEBAM9hTvXeXbQ8R6SDXrMAUA/aZ78965bovbSr9sUqFPyXKf5PH6FY &gt; mKIJQDKRwcz4CIXJEd0QHbtsSih/qzEKaGSYknezbTMYA5Tqab5fu4Pa84isCngM &gt; v962Ubh4Q0w8OGv2Na9A4HR0rwlquVb2LvigDKqtLrxsOvr6ORr67WHuRXs+Kpe6 &gt; 1mUFWf2pMTPAZGn+ZT7iPkdiWR+2G+mFYXSG/aHAmDABqWfCSXmg1QOCOT5zSLZd &gt; mbb9jiJlRZATGtnlDCXyu546Nqvoa+iJcc8X3WWFhhHVyq3abhqAlKIcv9kj+Lq4 &gt; rZ1VvCMcZKdoNMaVrhsv6GmIZWVuPjz/SrcCAwEAAaNjMGEwDwYDVR0TAQH/BAUw &gt; AwEB/zAOBgNVHQ8BAf8EBAMCAYYwHwYDVR0jBBgwFoAUN5ywvAkOjuS7vl7yR+Am &gt; xt+iABMwHQYDVR0OBBYEFDecsLwJDo7ku75e8kfgJsbfogATMA0GCSqGSIb3DQEB &gt; CwUAA4IBAQBhPgh5l2rXj+oFYuWfnLW/372wn5Xu/HnxMXqmXzhZpXVbDh5DdG7e &gt; +q4qJxRkuzmLZtjAhd+OIz1AQdGjclwlrraUPIBF2lT381PuUkuBOfL275HmBgoU &gt; iMKmXKHBBsX+/4DxVvGL6QK6i1VL+Gs0moBkJiudip9tkiMMmbMKkQfLDG/9c8Pv &gt; DysCHfTVcyMsGf/dKngtaPEXE4IlwRWih9cug6IShnLp+SePvf2kQow/vzv2bDXW &gt; bDwyuzxvp0F5GdJUivbkItM7rHFuL+apgAU2baiOSJ7t2CJlOy261iCvZpuILz80 &gt; GRaJYW3BzETN7BssLkLmaU91FW1DyzIb &gt; -----END CERTIFICATE----- 安装Root CA &gt; EOF vEdge1:~$ exit exit vEdge1# request root-cert-chain install /home/admin/root-ca.txt Uploading root-ca-cert-chain via VPN 0 Copying ... /home/admin/root-ca.txt via VPN 0 Updating the root certificate chain.. Successfully installed the root certificate chain 3. 生成vEdge CSR vEdge1# request csr upload home/admin/csr.txt Uploading CSR via VPN 0 Enter organization-unit name : lab Re-enter organization-unit name : lab Generating private/public pair and CSR for this vedge device Generating CSR for this vedge device ........[DONE] Copying ... /home/admin/csr.txt via VPN 0 CSR upload successful 查看vEdge CSR vEdge1# vshell vEdge1:~$ more csr.txt -----BEGIN CERTIFICATE REQUEST----- MIIDQTCCAikCAQAwgcAxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlh MREwDwYDVQQHEwhTYW4gSm9zZTEMMAoGA1UECxMDbGFiMRQwEgYDVQQKEwt2SVB0 ZWxhIEluYzFBMD8GA1UEAxM4dmVkZ2UtYjMzYjRkMzItZmNmZi00NGZmLThmYjMt YjRkZTQ5NWViODM5LTAudmlwdGVsYS5jb20xIjAgBgkqhkiG9w0BCQEWE3N1cHBv cnRAdmlwdGVsYS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCx DErEzO/aU0bz/NGaY9l6RNkj+Dj6XOOPEtRWRhAb+ecbpZpV4ETLRJOyvbOyGhaS UxkYQ3njUlGjW1ukz5k2jnK5r79lr3v28UXWsLFlO7K9rjt10M3yBPDrNoRT6Eme Ds7qiYem0RwmNEf0ZoN/p/iYxO/DK+LgPfqva2FrxUQxs/ZGi6/UUDkU24y0kVmv OgOiKIZ5S9M3uJIbu31KB6kiDmSTIZQstkIG2HwcRwkLFqAaD/4DFWl1wpdhLxKs pbrbmTdvUg7QqbAbk50rfmt+HjsjdCZT465cy7Gvlj2OpWR8uE7gdbRFskdF41ZY D81lpEzI2ViN2HOzs8t3AgMBAAGgOzA5BgkqhkiG9w0BCQ4xLDAqMAkGA1UdEwQC MAAwHQYDVR0OBBYEFAxPCi7gYJg4QFjeqsXXJuO9wzYPMA0GCSqGSIb3DQEBCwUA A4IBAQCIsCxDO3/Bpom3xStNlMGGEZZF0Ht/gMHtIQPPT3eGgRgw/MLSxdjMLE6H YCDoarAImcRXpT2i+1vb/aRDnGZlVwm/AOzQBPZ3Z4SsfXzEGOE3EuefiB9T2dAf L4IHpEcSbZMQtPoGynNi7obutoXZTWShB+VRF/SnkzHB8Z4pX10zZ/YTCn880adM pYYysDaEh8zdBUYo2dO/x4c2U0+mmZyWG3mFtkfwktHb+FpyPXhiswwWwdcJR+q4 SAmwAXGQdeBAiC+zm+TRnqmnd0iwN9FmNDl6Y0fc7/MGhRpJEjzTAk4SAgoR61QV gnuXTZAZeWPpgpEjd4OimrZSa7z1 -----END CERTIFICATE REQUEST----- vEdge1:~$ exit 4. 安装vEdge CA 通过vEdge CSR生成vEdge CA IOS-CA#crypto pki server PKI request pkcs10 terminal PKCS10 request in base64 or pem % Enter Base64 encoded or PEM formatted PKCS10 enrollment request. % End with a blank line or &quot;quit&quot; on a line by itself. 看到% End with a blank line or &quot;quit&quot; on a line by itself.提示后粘贴上一步生成的vEdge CSR % End with a blank line or &quot;quit&quot; on a line by itself. -----BEGIN CERTIFICATE REQUEST----- MIIDQTCCAikCAQAwgcAxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlh MREwDwYDVQQHEwhTYW4gSm9zZTEMMAoGA1UECxMDbGFiMRQwEgYDVQQKEwt2SVB0 ZWxhIEluYzFBMD8GA1UEAxM4dmVkZ2UtYjMzYjRkMzItZmNmZi00NGZmLThmYjMt YjRkZTQ5NWViODM5LTAudmlwdGVsYS5jb20xIjAgBgkqhkiG9w0BCQEWE3N1cHBv cnRAdmlwdGVsYS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCx DErEzO/aU0bz/NGaY9l6RNkj+Dj6XOOPEtRWRhAb+ecbpZpV4ETLRJOyvbOyGhaS UxkYQ3njUlGjW1ukz5k2jnK5r79lr3v28UXWsLFlO7K9rjt10M3yBPDrNoRT6Eme Ds7qiYem0RwmNEf0ZoN/p/iYxO/DK+LgPfqva2FrxUQxs/ZGi6/UUDkU24y0kVmv OgOiKIZ5S9M3uJIbu31KB6kiDmSTIZQstkIG2HwcRwkLFqAaD/4DFWl1wpdhLxKs pbrbmTdvUg7QqbAbk50rfmt+HjsjdCZT465cy7Gvlj2OpWR8uE7gdbRFskdF41ZY D81lpEzI2ViN2HOzs8t3AgMBAAGgOzA5BgkqhkiG9w0BCQ4xLDAqMAkGA1UdEwQC MAAwHQYDVR0OBBYEFAxPCi7gYJg4QFjeqsXXJuO9wzYPMA0GCSqGSIb3DQEBCwUA A4IBAQCIsCxDO3/Bpom3xStNlMGGEZZF0Ht/gMHtIQPPT3eGgRgw/MLSxdjMLE6H YCDoarAImcRXpT2i+1vb/aRDnGZlVwm/AOzQBPZ3Z4SsfXzEGOE3EuefiB9T2dAf L4IHpEcSbZMQtPoGynNi7obutoXZTWShB+VRF/SnkzHB8Z4pX10zZ/YTCn880adM pYYysDaEh8zdBUYo2dO/x4c2U0+mmZyWG3mFtkfwktHb+FpyPXhiswwWwdcJR+q4 SAmwAXGQdeBAiC+zm+TRnqmnd0iwN9FmNDl6Y0fc7/MGhRpJEjzTAk4SAgoR61QV gnuXTZAZeWPpgpEjd4OimrZSa7z1 -----END CERTIFICATE REQUEST----- 然后输入quit，获得vEdge-CA twWDYnOOS6A06t241kjlES14SPOszcnXCT9fg6ekCCJQHh9aolOoIhwWzYE= -----END CERTIFICATE REQUEST----- quit % Granted certificate: -----BEGIN CERTIFICATE----- MIIDqjCCApKgAwIBAgIBBjANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDExByb290 Y2EubGFiLmxvY2FsMB4XDTIwMDkyODAzMjQxNFoXDTIxMDkyODAzMjQxNFowgcAx CzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMREwDwYDVQQHEwhTYW4g Sm9zZTEMMAoGA1UECxMDbGFiMRQwEgYDVQQKEwt2SVB0ZWxhIEluYzFBMD8GA1UE AxM4dmVkZ2UtYjMzYjRkMzItZmNmZi00NGZmLThmYjMtYjRkZTQ5NWViODM5LTAu dmlwdGVsYS5jb20xIjAgBgkqhkiG9w0BCQEWE3N1cHBvcnRAdmlwdGVsYS5jb20w ggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCxDErEzO/aU0bz/NGaY9l6 RNkj+Dj6XOOPEtRWRhAb+ecbpZpV4ETLRJOyvbOyGhaSUxkYQ3njUlGjW1ukz5k2 jnK5r79lr3v28UXWsLFlO7K9rjt10M3yBPDrNoRT6EmeDs7qiYem0RwmNEf0ZoN/ p/iYxO/DK+LgPfqva2FrxUQxs/ZGi6/UUDkU24y0kVmvOgOiKIZ5S9M3uJIbu31K B6kiDmSTIZQstkIG2HwcRwkLFqAaD/4DFWl1wpdhLxKspbrbmTdvUg7QqbAbk50r fmt+HjsjdCZT465cy7Gvlj2OpWR8uE7gdbRFskdF41ZYD81lpEzI2ViN2HOzs8t3 AgMBAAGjUzBRMA8GA1UdEwEB/wQFMAMBAf8wHwYDVR0jBBgwFoAUN5ywvAkOjuS7 vl7yR+Amxt+iABMwHQYDVR0OBBYEFAxPCi7gYJg4QFjeqsXXJuO9wzYPMA0GCSqG SIb3DQEBCwUAA4IBAQCtzCCOjd8tqde4Kga1OCy07cxHPdCMjSctA65g6mbJo06r 3U04ZkGaNHtOecpTMojCXkqW15L0EJAlQwuS1D84E7kdTyoj3DMb94KPh7ROy7xu K0+5vm/gPQwDpvizoKDKJxvp+k7Vmud6o1PqH30Wg6HjdpRJpA4+KzNP4kDvlUxv Yfp9TQb9NoDnzMsCAWGzVTsDy9NsAIbKulAaWjNu18OUp8KIdCf3CUg46ihw9uw8 f8W3tyaJEwYdehIhM81Vxznedx2Do1WCpQcFTV0SE5icC4YwBFHaGLVBUCX9kUsi PWHFdprmm6YSTcuDlnRaIFmaZeYHIa9LmbbgLTiH -----END CERTIFICATE----- 进入vshell模式 vEdge1# vshell vEdge1:~$ cat &gt;&gt; vedge-ca.txt &lt;&lt;EOF &gt; 看到&gt;提示符后粘贴vEdge CA证书的内容 &gt; -----BEGIN CERTIFICATE----- &gt; MIIDFDCCAfygAwIBAgIBATANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQDExByb290 &gt; Y2EubGFiLmxvY2FsMB4XDTIwMDkyNjA4MjY1N1oXDTIzMDkyNjA4MjY1N1owGzEZ &gt; MBcGA1UEAxMQcm9vdGNhLmxhYi5sb2NhbDCCASIwDQYJKoZIhvcNAQEBBQADggEP &gt; ADCCAQoCggEBAM9hTvXeXbQ8R6SDXrMAUA/aZ78965bovbSr9sUqFPyXKf5PH6FY &gt; mKIJQDKRwcz4CIXJEd0QHbtsSih/qzEKaGSYknezbTMYA5Tqab5fu4Pa84isCngM &gt; v962Ubh4Q0w8OGv2Na9A4HR0rwlquVb2LvigDKqtLrxsOvr6ORr67WHuRXs+Kpe6 &gt; 1mUFWf2pMTPAZGn+ZT7iPkdiWR+2G+mFYXSG/aHAmDABqWfCSXmg1QOCOT5zSLZd &gt; mbb9jiJlRZATGtnlDCXyu546Nqvoa+iJcc8X3WWFhhHVyq3abhqAlKIcv9kj+Lq4 &gt; rZ1VvCMcZKdoNMaVrhsv6GmIZWVuPjz/SrcCAwEAAaNjMGEwDwYDVR0TAQH/BAUw &gt; AwEB/zAOBgNVHQ8BAf8EBAMCAYYwHwYDVR0jBBgwFoAUN5ywvAkOjuS7vl7yR+Am &gt; xt+iABMwHQYDVR0OBBYEFDecsLwJDo7ku75e8kfgJsbfogATMA0GCSqGSIb3DQEB &gt; CwUAA4IBAQBhPgh5l2rXj+oFYuWfnLW/372wn5Xu/HnxMXqmXzhZpXVbDh5DdG7e &gt; +q4qJxRkuzmLZtjAhd+OIz1AQdGjclwlrraUPIBF2lT381PuUkuBOfL275HmBgoU &gt; iMKmXKHBBsX+/4DxVvGL6QK6i1VL+Gs0moBkJiudip9tkiMMmbMKkQfLDG/9c8Pv &gt; DysCHfTVcyMsGf/dKngtaPEXE4IlwRWih9cug6IShnLp+SePvf2kQow/vzv2bDXW &gt; bDwyuzxvp0F5GdJUivbkItM7rHFuL+apgAU2baiOSJ7t2CJlOy261iCvZpuILz80 &gt; GRaJYW3BzETN7BssLkLmaU91FW1DyzIb &gt; -----END CERTIFICATE----- 安装vEdge CA &gt; EOF vEdge1:~$ exit exit vEdge1# request certificate install home/admin/vedge-ca.txt Installing certificate via VPN 0 Copying ... /home/admin/vedge-ca.txt via VPN 0 Successfully installed the certificate 5. 加入vManage 查看vEdge Chassis number和serial number vEdge1# show certificate serial Chassis number: b33b4d32-fcff-44ff-8fb3-b4de495eb839 serial number: 06 加入vManage vManage# request vedge add chassis-num b33b4d32-fcff-44ff-8fb3-b4de495eb839 serial-num 06 vBond也收到加入一下 vBond# request vedge add chassis-num b33b4d32-fcff-44ff-8fb3-b4de495eb839 serial-num 06 vManage网页端同步一下 6. 验证 vSmart# show control connections PEER PEER PEER PEER PEER SITE DOMAIN PEER PRIV PEER PUB INDEX TYPE PROT SYSTEM IP ID ID PRIVATE IP PORT PUBLIC IP PORT REMOTE COLOR STATE UPTIME -------------------------------------------------------------------------------- -------------------------------------------------------------------------------- ----------------------- 0 vedge dtls 10.12.0.1 12 1 192.1.1.2 12366 192.1.1.2 12366 public-internet up 0:00:00:36 0 vbond dtls 0.0.0.0 0 0 223.1.1.11 12346 223.1.1.11 12346 default up 1:18:32:07 0 vmanage dtls 10.100.0.10 100 0 223.1.1.10 12346 223.1.1.10 12346 default up 1:18:31:48 1 vbond dtls 0.0.0.0 0 0 223.1.1.11 vSmart# show omp peers R -&gt; routes received I -&gt; routes installed S -&gt; routes sent DOMAIN OVERLAY SITE PEER TYPE ID ID ID STATE UPTIME R/I/S ------------------------------------------------------------------------------------------ 10.12.0.1 vedge 1 1 12 up 0:00:01:58 0/0/0 12346 223.1.1.11 12346 default up 1:18:32:07 七、Controller恢复出厂设置 vEdge#request software reset ","link":"https://eflytop.github.io/post/cisco-sdwan-controller-installation/"},{"title":"GRE vs IPIP Tunneling","content":"Generic Routing Encapsulation (GRE) 和IP-in-IP (IPIP) 是两个相似的隧道机制，但经常混淆。在本文中，我们将介绍它们的运作机制、区别以及何时使用它们。 IPIP IP-in-IP 听起来就像:一个IP包封装在另一个IP包中。外层报头的协议字段为IPv4为4，IPv6为41。 IPv4与IPv6封装的所有组合在技术上都是可行的，但是有些厂商可能不支持所有组合。. 在Cisco IOS上有三种IPIP封装方法:IPv4/IPv4、IPv6/IPv6和IPv6/IPv4。 Router(config)# interface tun0 Router(config-if)# tunnel mode ? aurp AURP TunnelTalk AppleTalk encapsulation cayman Cayman TunnelTalk AppleTalk encapsulation dvmrp DVMRP multicast tunnel eon EON compatible CLNS tunnel gre generic route encapsulation protocol ipip IP over IP encapsulation ipsec IPSec tunnel encapsulation iptalk Apple IPTalk encapsulation ipv6 Generic packet tunneling in IPv6 ipv6ip IPv6 over IP encapsulation mpls MPLS encapsulations nos IP over IP encapsulation (KA9Q/NOS compatible) rbscp RBSCP in IP tunnel GRE GRE (defined in RFC 2784 and updated by RFC 2890) 比IPIP更进一步，在内部和外部IP报头之间添加了自己的附加报头。 GRE报头的长度是可变的，从4字节到16字节不等，这取决于启用了哪些可选特性。 C, K, and S: Bit flags which are set to one if the checksum, key, and sequence number fields are present, respectively Ver: GRE version number (zero) Protocol: Ethertype of the encapsulated protocol Checksum: Packet checksum (optional) Key: Tunnel key (optional) Sequence Number: GRE sequence number (optional) GRE理论上可以使用有效的以太类型封装任何第三层协议， 而IPIP只能封装IP。 GRE在Cisco IOS上 可以 被IPv4或IPv6封装。(The multipoint option is used for DMVPN) Router(config)# interface tun0 Router(config-if)# tunnel mode gre ? ip over IP ipv6 over IPv6 multipoint over IP (multipoint) 默认情况下，只包含一个最小的4字节头。其他GRE选项可以独立地打开或关闭: Router(config-if)# tunnel ? bandwidth Set tunnel bandwidth informational parameter checksum enable end to end checksumming of packets destination destination of tunnel flow flow options key security or selector key mode tunnel encapsulation method mpls MPLS tunnel commands path-mtu-discovery Enable Path MTU Discovery on tunnel protection Enable tunnel protection rbscp Set tunnel RBSCP parameters route-via Select subset of routes for tunnel transport sequence-datagrams drop datagrams arriving out of order source source of tunnel packets tos set type of service byte ttl set time to live udlr associate tunnel with unidirectional interface vrf set tunnel vrf membership 总而言之，GRE可以： • 封装任何第三层协议(而不只是IP) • 添加一个额外的校验(这对TCP/IPv4没什么用) • 指定一个隧道key • 执行数据包排序（ Enforce packet sequencing ） 当然，这些特性是以额外的开销为代价的;如果不需要GRE的额外功能，IPIP也可以。 ","link":"https://eflytop.github.io/post/gre-vs-ipip-tunneling/"},{"title":"Hello Gridea","content":"👏 欢迎使用 Gridea ！ ✍️ Gridea 一个静态博客写作客户端。你可以用它来记录你的生活、心情、知识、笔记、创意... ... Github Gridea 主页 示例网站 特性👇 📝 你可以使用最酷的 Markdown 语法，进行快速创作 🌉 你可以给文章配上精美的封面图和在文章任意位置插入图片 🏷️ 你可以对文章进行标签分组 📋 你可以自定义菜单，甚至可以创建外部链接菜单 💻 你可以在 Windows，MacOS 或 Linux 设备上使用此客户端 🌎 你可以使用 𝖦𝗂𝗍𝗁𝗎𝖻 𝖯𝖺𝗀𝖾𝗌 或 Coding Pages 向世界展示，未来将支持更多平台 💬 你可以进行简单的配置，接入 Gitalk 或 DisqusJS 评论系统 🇬🇧 你可以使用中文简体或英语 🌁 你可以任意使用应用内默认主题或任意第三方主题，强大的主题自定义能力 🖥 你可以自定义源文件夹，利用 OneDrive、百度网盘、iCloud、Dropbox 等进行多设备同步 🌱 当然 Gridea 还很年轻，有很多不足，但请相信，它会不停向前 🏃 未来，它一定会成为你离不开的伙伴 尽情发挥你的才华吧！ 😘 Enjoy~ ","link":"https://eflytop.github.io/post/hello-gridea/"}]}